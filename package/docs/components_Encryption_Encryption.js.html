<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>components/Encryption/Encryption.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-AdditionalDetails.html">AdditionalDetails</a><ul class='methods'><li data-type='method'><a href="module-AdditionalDetails.html#~AdditionalDetails">AdditionalDetails</a></li><li data-type='method'><a href="module-AdditionalDetails.html#~AdditionalDetails">AdditionalDetails</a></li></ul></li><li></li><li><a href="module-ApprovalForm.html">ApprovalForm</a><ul class='methods'><li data-type='method'><a href="module-ApprovalForm.html#~ApprovalForm">ApprovalForm</a></li><li data-type='method'><a href="module-ApprovalForm.html#~ApprovalForm">ApprovalForm</a></li></ul></li><li></li><li><a href="module-EmployeeVisitForm.html">EmployeeVisitForm</a><ul class='methods'><li data-type='method'><a href="module-EmployeeVisitForm.html#~EmployeeVisitForm">EmployeeVisitForm</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~EmployeeVisitForm">EmployeeVisitForm</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~stripNonEnglish">stripNonEnglish</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~stripNonEnglish">stripNonEnglish</a></li></ul></li><li></li><li><a href="module-SaveandHold.html">SaveandHold</a><ul class='methods'><li data-type='method'><a href="module-SaveandHold.html#~SaveandHold">SaveandHold</a></li><li data-type='method'><a href="module-SaveandHold.html#~SaveandHold">SaveandHold</a></li><li data-type='method'><a href="module-SaveandHold.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-SaveandHold.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-SaveandHold.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-SaveandHold.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-SaveandHold.html#~getToColumnHtml">getToColumnHtml</a></li><li data-type='method'><a href="module-SaveandHold.html#~getToColumnHtml">getToColumnHtml</a></li></ul></li><li></li><li><a href="module-components_Roadmap.html">components/Roadmap</a><ul class='methods'><li data-type='method'><a href="module-components_Roadmap.html#~Roadmap">Roadmap</a></li></ul></li><li><a href="module-src_components_UIShowcase.html">src/components/UIShowcase</a><ul class='methods'><li data-type='method'><a href="module-src_components_UIShowcase.html#~UIShowcase">UIShowcase</a></li></ul></li><li><a href="module-src_components_authentication_OtpVerification.html">src/components/authentication/OtpVerification</a><ul class='methods'><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~addTrustedDevice">addTrustedDevice</a></li><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~generateDeviceFingerprint">generateDeviceFingerprint</a></li><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~getDeviceInfo">getDeviceInfo</a></li><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~removeTrustedDevice">removeTrustedDevice</a></li></ul></li><li><a href="module-src_components_ui.html">src/components/ui</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui.html#~AnimatedSlide">AnimatedSlide</a></li><li data-type='method'><a href="module-src_components_ui.html#~CardStyle">CardStyle</a></li></ul></li><li></li><li></li><li></li><li><a href="module-src_components_ui_Alerts.html">src/components/ui/Alerts</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Alerts.html#~Alerts">Alerts</a></li></ul></li><li><a href="module-src_components_ui_Avatar.html">src/components/ui/Avatar</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Avatar.html#~Avatar">Avatar</a></li></ul></li><li><a href="module-src_components_ui_Badge.html">src/components/ui/Badge</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Badge.html#~Badge">Badge</a></li></ul></li><li><a href="module-src_components_ui_Button.html">src/components/ui/Button</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Button.html#~Button">Button</a></li><li data-type='method'><a href="module-src_components_ui_Button.html#~ButtonGroup">ButtonGroup</a></li><li data-type='method'><a href="module-src_components_ui_Button.html#~NavigationContainer">NavigationContainer</a></li></ul></li><li><a href="module-src_components_ui_Card.html">src/components/ui/Card</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Card.html#~Card">Card</a></li></ul></li><li><a href="module-src_components_ui_Checkbox.html">src/components/ui/Checkbox</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Checkbox.html#~Checkbox">Checkbox</a></li></ul></li><li><a href="module-src_components_ui_DialogBox.html">src/components/ui/DialogBox</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_DialogBox.html#~DialogBox">DialogBox</a></li></ul></li><li><a href="module-src_components_ui_Dropdown.html">src/components/ui/Dropdown</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Dropdown.html#~Dropdown">Dropdown</a></li></ul></li><li><a href="module-src_components_ui_Input.html">src/components/ui/Input</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Input.html#~Input">Input</a></li></ul></li><li><a href="module-src_components_ui_Pagination.html">src/components/ui/Pagination</a></li><li><a href="module-src_components_ui_PriorityIcon.html">src/components/ui/PriorityIcon</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_PriorityIcon.html#~PriorityIcon">PriorityIcon</a></li></ul></li><li><a href="module-src_components_ui_TextArea.html">src/components/ui/TextArea</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_TextArea.html#~TextArea">TextArea</a></li></ul></li><li><a href="module-src_layouts_full_header_Profile.html">src/layouts/full/header/Profile</a></li><li><a href="module-src_pages_Inbox_Inbox.html">src/pages/Inbox/Inbox</a></li><li><a href="module-src_services_EnhancedDynamicDecryption.html">src/services/EnhancedDynamicDecryption</a><ul class='methods'><li data-type='method'><a href="module-src_services_EnhancedDynamicDecryption.html#~base64ToArrayBuffer">base64ToArrayBuffer</a></li><li data-type='method'><a href="module-src_services_EnhancedDynamicDecryption.html#~getAuthHeaders">getAuthHeaders</a></li></ul></li><li><a href="module-src_views_authentication_auth_AuthLogin.html">src/views/authentication/auth/AuthLogin</a></li><li><a href="module-src_views_authentication_auth_encryption.html">src/views/authentication/auth/encryption</a><ul class='methods'><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.authenticateUser">authenticateUser</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.decryptGCM">decryptGCM</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.encryptECB">encryptECB</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.getDecryptKeyFromCookies">getDecryptKeyFromCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.getSessionIdFromCookies">getSessionIdFromCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.getUserFromCookies">getUserFromCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.isUserAuthenticated">isUserAuthenticated</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.logoutUser">logoutUser</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~deleteCookie">deleteCookie</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~generate256BitKey">generate256BitKey</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~getAuthHeaders">getAuthHeaders</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~getCookie">getCookie</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~insertSessionData">insertSessionData</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~saveUserToCookies">saveUserToCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~setCookie">setCookie</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#CommentsHistory">CommentsHistory</a></li><li><a href="global.html#DateInput">DateInput</a></li><li><a href="global.html#DatePicker">DatePicker</a></li><li><a href="global.html#DateRangePicker">DateRangePicker</a></li><li><a href="global.html#DocumentUpload">DocumentUpload</a></li><li><a href="global.html#DropZone">DropZone</a></li><li><a href="global.html#FileUpload">FileUpload</a></li><li><a href="global.html#ImageUpload">ImageUpload</a></li><li><a href="global.html#InlineDateRangePicker">InlineDateRangePicker</a></li><li><a href="global.html#Login2">Login2</a></li><li><a href="global.html#MultiFileUpload">MultiFileUpload</a></li><li><a href="global.html#TaskCard">TaskCard</a></li><li><a href="global.html#TaskSummaryPage">TaskSummaryPage</a></li><li><a href="global.html#base64ToArrayBuffer">base64ToArrayBuffer</a></li><li><a href="global.html#decrypt">decrypt</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">components/Encryption/Encryption.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// /**
//  * @fileoverview User authentication and encryption utility module.
//  * @module src/views/authentication/auth/encryption
//  * @author Rakshana
//  * @date 16/07/2025
//  * @since 1.0.0
//  */

// import CryptoJS from 'crypto-js';
// import { HostName } from "src/assets/host/Host";

// function setCookie(name, value, days = 7) {
//   const expires = new Date();
//   expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
//   document.cookie = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/;SameSite=Strict`;
// }

// function getCookie(name) {
//   const nameEQ = name + "=";
//   const ca = document.cookie.split(';');
//   for (let i = 0; i &lt; ca.length; i++) {
//     let c = ca[i];
//     while (c.charAt(0) === ' ') c = c.substring(1, c.length);
//     if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
//   }
//   return null;
// }

// function deleteCookie(name) {
//   document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
// }
// function generate256BitKey() {
//   const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%&amp;*';
//   const specialChars = '!@#$%&amp;*';
//   const numbers = '0123456789';
//   const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
  
//   let key = '';
//   const keyLength = 32; 
//   const randomArray = new Uint8Array(keyLength);
//   window.crypto.getRandomValues(randomArray);
  
//   for (let i = 0; i &lt; keyLength; i++) {
//     if (i % 8 === 0 &amp;&amp; i > 0) {
//       const specialIndex = randomArray[i] % specialChars.length;
//       key += specialChars[specialIndex];
//     } else if (i % 5 === 0 &amp;&amp; i > 0) {
//       const numberIndex = randomArray[i] % numbers.length;
//       key += numbers[numberIndex];
//     } else {
//       const letterIndex = randomArray[i] % letters.length;
//       key += letters[letterIndex];
//     }
//   }
  
//   return key;
// }
// const getAuthHeaders = async () => {
//   const encryptedToken = getCookie("HRToken");
//   return {
//     "Content-Type": "application/json",
//     Authorization: `Bearer ${encryptedToken}`,
//   };
// };
// async function insertSessionData(sessionId, decryptKey) {
//   const INSERT_API_URL = `${HostName}/Datadecrypt`;
//   const TOKEN = 'HRFGVJISOVp1fncC';

//   try {
//     const headers = await getAuthHeaders();
//     const requestBody = {
//       session_id: sessionId,
//       token: TOKEN,
//       decryptkey: decryptKey
//     };

//     const response = await fetch(INSERT_API_URL, {
//       method: 'POST',
//       headers: headers,
//       body: JSON.stringify(requestBody)
//     });

//     if (!response.ok) {
//       console.error(`Failed to insert session data. HTTP status: ${response.status}`);
//       throw new Error(`Session insert failed with status: ${response.status}`);
//     }

//     const result = await response.json();
//     console.log('Session data inserted successfully:', result);
//     return result;
//   } catch (error) {
//     console.error('Error inserting session data:', error);
//     throw new Error(`Failed to insert session data: ${error.message}`);
//   }
// }

// export function encryptECB(plaintext, key) {
//   try {
//     const keyWordArray = CryptoJS.enc.Utf8.parse(key);
//     const plaintextWordArray = CryptoJS.enc.Utf8.parse(plaintext);
//     const encrypted = CryptoJS.AES.encrypt(plaintextWordArray, keyWordArray, {
//       mode: CryptoJS.mode.ECB,
//       padding: CryptoJS.pad.Pkcs7
//     });
//     return encrypted.ciphertext.toString(CryptoJS.enc.Hex);
//   } catch (error) {
//     throw new Error('Failed to encrypt data');
//   }
// }

// export async function decryptGCM(encryptedBase64, key) {
//   const encryptedBytes = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
//   const nonce = encryptedBytes.slice(0, 12);
//   const ciphertext = encryptedBytes.slice(12);
//   const keyBuffer = new TextEncoder().encode(key);
//   const cryptoKey = await window.crypto.subtle.importKey(
//     'raw',
//     keyBuffer,
//     { name: 'AES-GCM' },
//     false,
//     ['decrypt']
//   );
//   try {
//     const decryptedBuffer = await window.crypto.subtle.decrypt(
//       {
//         name: 'AES-GCM',
//         iv: nonce
//       },
//       cryptoKey,
//       ciphertext
//     );

//     const decoder = new TextDecoder();
//     return decoder.decode(decryptedBuffer);
//   } catch (err) {
//     throw new Error('Failed to decrypt data');
//   }
// }

// function saveUserToCookies(userData) {
//   setCookie('userId', userData.userId, 7);
//   setCookie('username', userData.username, 7);
//   setCookie('userRole', userData.role, 7);
//   setCookie('EmpId', userData.EmployeeId, 7);
//   if (userData.mobileNo) {
//     setCookie('mobileNo', userData.mobileNo, 7); // Save mobile number to cookies
//   }
// }

// export function getUserFromCookies() {
//   const userData = getCookie('userData');
//   if (userData) {
//     try {
//       return JSON.parse(userData);
//     } catch (error) {
//       return null;
//     }
//   }
//   return null;
// }

// export function isUserAuthenticated() {
//   return getCookie('isAuthenticated') === 'true' &amp;&amp; getUserFromCookies() !== null;
// }

// export function logoutUser() {
//   deleteCookie('userId');
//   deleteCookie('username');
//   deleteCookie('userRole');
//   deleteCookie('EmpId');
//   deleteCookie('mobileNo'); // Clear mobile number cookie
//   deleteCookie('isAuthenticated');
//   deleteCookie('userData');
//   deleteCookie('HRToken');
//   deleteCookie('session_id');
// }

// export async function authenticateUser(username, password) {
//   const API_URL = `${HostName}/HRldapfailure`;
//   const TOKEN = 'HRFGVJISOVp1fncC';
//   const ENCRYPTION_KEY = '7xPz!qL3vNc#eRb9Wm@f2Zh8Kd$gYp1B';

//   try {
//     const encryptedUsername = encryptECB(username, ENCRYPTION_KEY);
//     const encryptedPassword = encryptECB(password, ENCRYPTION_KEY);
//     const requestBody = {
//       token: TOKEN,
//       username: encryptedUsername,
//       password: encryptedPassword
//     };

//     const response = await fetch(API_URL, {
//       method: 'POST',
//       headers: {
//         'Content-Type': 'application/json',
//         'Accept': 'application/json'
//       },
//       body: JSON.stringify(requestBody)
//     });

//     if (!response.ok) {
//       throw new Error(`HTTP error! status: ${response.status}`);
//     }

//     const data = await response.json();

//     if (data.Data) {
//       const decryptedData = await decryptGCM(data.Data, ENCRYPTION_KEY);
//       const parsedData = JSON.parse(decryptedData);

//       if (parsedData.valid === true) {
//         const mobileNo = parsedData.MobileNumber; // Support multiple possible field names
//         if (!mobileNo) {
//         }

//         const userData = {
//           userId: parsedData.userId,
//           username: parsedData.username,
//           role: parsedData.role || '',
//           EmployeeId: parsedData.EmployeeId || '',
//           mobileNo: mobileNo
//         };
//         const sessionId = parsedData.sessionId || parsedData.session_id || parsedData.SessionId || parsedData.userId;
//         const decryptKey = generate256BitKey();
//         saveUserToCookies(userData);
//         setCookie('isAuthenticated', 'true', 7);
//         setCookie('userData', JSON.stringify(userData), 7);
        
//         if (parsedData.token) {
//           setCookie('HRToken', parsedData.token, 7);
//         }
        
//         if (sessionId) {
//           setCookie('session_id', sessionId, 7);
//         } else {
//           console.warn('No session ID available');
//         }

//         try {
//           await insertSessionData(sessionId || parsedData.userId, decryptKey);
//           console.log('Session data successfully inserted to API');
//         } catch (insertError) {
//           console.error('Failed to insert session data to API:', insertError);
//         }

//         return {
//           success: true,
//           user: userData,
//           token: parsedData.token || null,
//           sessionId: sessionId || parsedData.userId || null, // Fallback to userId if sessionId is missing
//           decryptKey: decryptKey
//         };
//       } else {
//         throw new Error('Invalid credentials');
//       }
//     } else {
//       throw new Error('No data received from server');
//     }
//   } catch (error) {
//     throw new Error(error.message || 'Login failed. Please check your credentials.');
//   }
// }
// export function getSessionIdFromCookies() {
//   return getCookie('session_id');
// }
// export function getDecryptKeyFromCookies() {
//   return getCookie('decryptKey');
// }



/**
 * @fileoverview User login and encryption helper module.
 * @module src/views/authentication/auth/encryption
 * @author Rakshana
 * @date 16/07/2025
 * @since 1.0.0
 */

import CryptoJS from 'crypto-js';
import { HostName } from "src/assets/host/Host";

/**
 * Saves information in the browser (cookies).
 * @param {string} name - Name of the cookie
 * @param {string} value - Value to save
 * @param {number} [days=7] - How many days it stays saved
 */
function setCookie(name, value, days = 7) {
  const expires = new Date();
  expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
  document.cookie = `${name}=${encodeURIComponent(value)};expires=${expires.toUTCString()};path=/;SameSite=Strict`;
}

/**
 * Reads information from cookies.
 * @param {string} name - Name of the cookie
 * @returns {string|null} Value of the cookie, or null if not found
 */
function getCookie(name) {
  const nameEQ = name + "=";
  const ca = document.cookie.split(';');
  for (let i = 0; i &lt; ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
    if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
  }
  return null;
}

/**
 * Deletes a cookie (removes saved info).
 * @param {string} name - Name of the cookie
 */
function deleteCookie(name) {
  document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;
}

/**
 * Creates a new 256-bit secret key (used for encryption).
 * @returns {string} Randomly generated 32-character key
 */
function generate256BitKey() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%&amp;*';
  const specialChars = '!@#$%&amp;*';
  const numbers = '0123456789';
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
  
  let key = '';
  const keyLength = 32; 
  const randomArray = new Uint8Array(keyLength);
  window.crypto.getRandomValues(randomArray);
  
  for (let i = 0; i &lt; keyLength; i++) {
    if (i % 8 === 0 &amp;&amp; i > 0) {
      const specialIndex = randomArray[i] % specialChars.length;
      key += specialChars[specialIndex];
    } else if (i % 5 === 0 &amp;&amp; i > 0) {
      const numberIndex = randomArray[i] % numbers.length;
      key += numbers[numberIndex];
    } else {
      const letterIndex = randomArray[i] % letters.length;
      key += letters[letterIndex];
    }
  }
  
  return key;
}

/**
 * Prepares login headers for API requests.
 * @returns {Promise&lt;Object>} Headers with token
 */
const getAuthHeaders = async () => {
  const encryptedToken = getCookie("HRToken");
  return {
    "Content-Type": "application/json",
    Authorization: `Bearer ${encryptedToken}`,
  };
};

/**
 * Saves session details to the server.
 * @param {string} sessionId - Session identifier
 * @param {string} decryptKey - Secret key for decrypting
 * @returns {Promise&lt;Object>} Server response
 */
async function insertSessionData(sessionId, decryptKey) {
  const INSERT_API_URL = `${HostName}/Datadecrypt`;
  const TOKEN = 'HRFGVJISOVp1fncC';

  try {
    const headers = await getAuthHeaders();
    const requestBody = {
      session_id: sessionId,
      token: TOKEN,
      decryptkey: decryptKey
    };

    const response = await fetch(INSERT_API_URL, {
      method: 'POST',
      headers: headers,
      body: JSON.stringify(requestBody)
    });

    if (!response.ok) {
      throw new Error(`Session insert failed with status: ${response.status}`);
    }

    const result = await response.json();
    return result;
  } catch (error) {
    throw new Error(`Failed to insert session data: ${error.message}`);
  }
}

/**
 * Encrypts text using AES in ECB mode.
 * @param {string} plaintext - Normal text
 * @param {string} key - Secret key
 * @returns {string} Encrypted text (hex format)
 */
export function encryptECB(plaintext, key) {
  try {
    const keyWordArray = CryptoJS.enc.Utf8.parse(key);
    const plaintextWordArray = CryptoJS.enc.Utf8.parse(plaintext);
    const encrypted = CryptoJS.AES.encrypt(plaintextWordArray, keyWordArray, {
      mode: CryptoJS.mode.ECB,
      padding: CryptoJS.pad.Pkcs7
    });
    return encrypted.ciphertext.toString(CryptoJS.enc.Hex);
  } catch {
    throw new Error('Failed to encrypt data');
  }
}

/**
 * Decrypts text locked with AES-GCM.
 * @param {string} encryptedBase64 - Encrypted data (Base64 format)
 * @param {string} key - Secret key
 * @returns {Promise&lt;string>} Decrypted text
 */
export async function decryptGCM(encryptedBase64, key) {
  const encryptedBytes = Uint8Array.from(atob(encryptedBase64), c => c.charCodeAt(0));
  const nonce = encryptedBytes.slice(0, 12);
  const ciphertext = encryptedBytes.slice(12);
  const keyBuffer = new TextEncoder().encode(key);
  const cryptoKey = await window.crypto.subtle.importKey(
    'raw',
    keyBuffer,
    { name: 'AES-GCM' },
    false,
    ['decrypt']
  );
  try {
    const decryptedBuffer = await window.crypto.subtle.decrypt(
      { name: 'AES-GCM', iv: nonce },
      cryptoKey,
      ciphertext
    );
    return new TextDecoder().decode(decryptedBuffer);
  } catch {
    throw new Error('Failed to decrypt data');
  }
}

/**
 * Saves user details in cookies.
 * @param {Object} userData - User information
 */
function saveUserToCookies(userData) {
  setCookie('userId', userData.userId, 7);
  setCookie('username', userData.username, 7);
  setCookie('userRole', userData.role, 7);
  setCookie('EmpId', userData.EmployeeId, 7);
  if (userData.mobileNo) {
    setCookie('mobileNo', userData.mobileNo, 7);
  }
}

/**
 * Reads user details from cookies.
 * @returns {Object|null} User information, or null if not found
 */
export function getUserFromCookies() {
  const userData = getCookie('userData');
  if (userData) {
    try {
      return JSON.parse(userData);
    } catch {
      return null;
    }
  }
  return null;
}

/**
 * Checks if the user is logged in.
 * @returns {boolean} True if logged in
 */
export function isUserAuthenticated() {
  return getCookie('isAuthenticated') === 'true' &amp;&amp; getUserFromCookies() !== null;
}

/**
 * Logs out the user by removing cookies.
 */
export function logoutUser() {
  deleteCookie('userId');
  deleteCookie('username');
  deleteCookie('userRole');
  deleteCookie('EmpId');
  deleteCookie('mobileNo');
  deleteCookie('isAuthenticated');
  deleteCookie('userData');
  deleteCookie('HRToken');
  deleteCookie('session_id');
}

/**
 * Logs in the user with username and password.
 * Encrypts credentials, sends them to the server, 
 * and saves session + user info in cookies.
 * @param {string} username - User’s name
 * @param {string} password - User’s password
 * @returns {Promise&lt;Object>} Login result with user, token, and session details
 */
export async function authenticateUser(username, password) {
  const API_URL = `${HostName}/HRldapfailure`;
  const TOKEN = 'HRFGVJISOVp1fncC';
  const ENCRYPTION_KEY = '7xPz!qL3vNc#eRb9Wm@f2Zh8Kd$gYp1B';

  try {
    const encryptedUsername = encryptECB(username, ENCRYPTION_KEY);
    const encryptedPassword = encryptECB(password, ENCRYPTION_KEY);

    const response = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({ token: TOKEN, username: encryptedUsername, password: encryptedPassword })
    });

    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();

    if (data.Data) {
      const decryptedData = await decryptGCM(data.Data, ENCRYPTION_KEY);
      const parsedData = JSON.parse(decryptedData);

      if (parsedData.valid === true) {
        const userData = {
          userId: parsedData.userId,
          username: parsedData.username,
          role: parsedData.role || '',
          EmployeeId: parsedData.EmployeeId || '',
          mobileNo: parsedData.MobileNumber || null
        };

        const sessionId = parsedData.sessionId || parsedData.session_id || parsedData.SessionId || parsedData.userId;
        const decryptKey = generate256BitKey();

        saveUserToCookies(userData);
        setCookie('isAuthenticated', 'true', 7);
        setCookie('userData', JSON.stringify(userData), 7);
        if (parsedData.token) setCookie('HRToken', parsedData.token, 7);
        if (sessionId) setCookie('session_id', sessionId, 7);

        try {
          await insertSessionData(sessionId || parsedData.userId, decryptKey);
        } catch (insertError) {
          console.error('Failed to insert session data:', insertError);
        }

        return { success: true, user: userData, token: parsedData.token || null, sessionId, decryptKey };
      } else {
        throw new Error('Invalid credentials');
      }
    } else {
      throw new Error('No data received from server');
    }
  } catch (error) {
    throw new Error(error.message || 'Login failed. Please check your credentials.');
  }
}

/**
 * Gets the session ID saved in cookies.
 * @returns {string|null} Session ID
 */
export function getSessionIdFromCookies() {
  return getCookie('session_id');
}

/**
 * Gets the decrypt key saved in cookies.
 * @returns {string|null} Decrypt key
 */
export function getDecryptKeyFromCookies() {
  return getCookie('decryptKey');
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Wed Nov 05 2025 11:24:43 GMT+0530 (India Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
