<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>layouts/full/header/Profile.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-AdditionalDetails.html">AdditionalDetails</a><ul class='methods'><li data-type='method'><a href="module-AdditionalDetails.html#~AdditionalDetails">AdditionalDetails</a></li><li data-type='method'><a href="module-AdditionalDetails.html#~AdditionalDetails">AdditionalDetails</a></li></ul></li><li></li><li><a href="module-ApprovalForm.html">ApprovalForm</a><ul class='methods'><li data-type='method'><a href="module-ApprovalForm.html#~ApprovalForm">ApprovalForm</a></li><li data-type='method'><a href="module-ApprovalForm.html#~ApprovalForm">ApprovalForm</a></li></ul></li><li></li><li><a href="module-EmployeeVisitForm.html">EmployeeVisitForm</a><ul class='methods'><li data-type='method'><a href="module-EmployeeVisitForm.html#~EmployeeVisitForm">EmployeeVisitForm</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~EmployeeVisitForm">EmployeeVisitForm</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~stripNonEnglish">stripNonEnglish</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~stripNonEnglish">stripNonEnglish</a></li></ul></li><li></li><li><a href="module-SaveandHold.html">SaveandHold</a><ul class='methods'><li data-type='method'><a href="module-SaveandHold.html#~SaveandHold">SaveandHold</a></li><li data-type='method'><a href="module-SaveandHold.html#~SaveandHold">SaveandHold</a></li><li data-type='method'><a href="module-SaveandHold.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-SaveandHold.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-SaveandHold.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-SaveandHold.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-SaveandHold.html#~getToColumnHtml">getToColumnHtml</a></li><li data-type='method'><a href="module-SaveandHold.html#~getToColumnHtml">getToColumnHtml</a></li></ul></li><li></li><li><a href="module-components_Roadmap.html">components/Roadmap</a><ul class='methods'><li data-type='method'><a href="module-components_Roadmap.html#~Roadmap">Roadmap</a></li></ul></li><li><a href="module-src_components_UIShowcase.html">src/components/UIShowcase</a><ul class='methods'><li data-type='method'><a href="module-src_components_UIShowcase.html#~UIShowcase">UIShowcase</a></li></ul></li><li><a href="module-src_components_authentication_OtpVerification.html">src/components/authentication/OtpVerification</a><ul class='methods'><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~addTrustedDevice">addTrustedDevice</a></li><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~generateDeviceFingerprint">generateDeviceFingerprint</a></li><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~getDeviceInfo">getDeviceInfo</a></li><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~removeTrustedDevice">removeTrustedDevice</a></li></ul></li><li><a href="module-src_components_ui.html">src/components/ui</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui.html#~AnimatedSlide">AnimatedSlide</a></li><li data-type='method'><a href="module-src_components_ui.html#~CardStyle">CardStyle</a></li></ul></li><li></li><li></li><li></li><li><a href="module-src_components_ui_Alerts.html">src/components/ui/Alerts</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Alerts.html#~Alerts">Alerts</a></li></ul></li><li><a href="module-src_components_ui_Avatar.html">src/components/ui/Avatar</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Avatar.html#~Avatar">Avatar</a></li></ul></li><li><a href="module-src_components_ui_Badge.html">src/components/ui/Badge</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Badge.html#~Badge">Badge</a></li></ul></li><li><a href="module-src_components_ui_Button.html">src/components/ui/Button</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Button.html#~Button">Button</a></li><li data-type='method'><a href="module-src_components_ui_Button.html#~ButtonGroup">ButtonGroup</a></li><li data-type='method'><a href="module-src_components_ui_Button.html#~NavigationContainer">NavigationContainer</a></li></ul></li><li><a href="module-src_components_ui_Card.html">src/components/ui/Card</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Card.html#~Card">Card</a></li></ul></li><li><a href="module-src_components_ui_Checkbox.html">src/components/ui/Checkbox</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Checkbox.html#~Checkbox">Checkbox</a></li></ul></li><li><a href="module-src_components_ui_DialogBox.html">src/components/ui/DialogBox</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_DialogBox.html#~DialogBox">DialogBox</a></li></ul></li><li><a href="module-src_components_ui_Dropdown.html">src/components/ui/Dropdown</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Dropdown.html#~Dropdown">Dropdown</a></li></ul></li><li><a href="module-src_components_ui_Input.html">src/components/ui/Input</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Input.html#~Input">Input</a></li></ul></li><li><a href="module-src_components_ui_Pagination.html">src/components/ui/Pagination</a></li><li><a href="module-src_components_ui_PriorityIcon.html">src/components/ui/PriorityIcon</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_PriorityIcon.html#~PriorityIcon">PriorityIcon</a></li></ul></li><li><a href="module-src_components_ui_TextArea.html">src/components/ui/TextArea</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_TextArea.html#~TextArea">TextArea</a></li></ul></li><li><a href="module-src_layouts_full_header_Profile.html">src/layouts/full/header/Profile</a></li><li><a href="module-src_pages_Inbox_Inbox.html">src/pages/Inbox/Inbox</a></li><li><a href="module-src_services_EnhancedDynamicDecryption.html">src/services/EnhancedDynamicDecryption</a><ul class='methods'><li data-type='method'><a href="module-src_services_EnhancedDynamicDecryption.html#~base64ToArrayBuffer">base64ToArrayBuffer</a></li><li data-type='method'><a href="module-src_services_EnhancedDynamicDecryption.html#~getAuthHeaders">getAuthHeaders</a></li></ul></li><li><a href="module-src_views_authentication_auth_AuthLogin.html">src/views/authentication/auth/AuthLogin</a></li><li><a href="module-src_views_authentication_auth_encryption.html">src/views/authentication/auth/encryption</a><ul class='methods'><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.authenticateUser">authenticateUser</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.decryptGCM">decryptGCM</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.encryptECB">encryptECB</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.getDecryptKeyFromCookies">getDecryptKeyFromCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.getSessionIdFromCookies">getSessionIdFromCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.getUserFromCookies">getUserFromCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.isUserAuthenticated">isUserAuthenticated</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.logoutUser">logoutUser</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~deleteCookie">deleteCookie</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~generate256BitKey">generate256BitKey</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~getAuthHeaders">getAuthHeaders</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~getCookie">getCookie</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~insertSessionData">insertSessionData</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~saveUserToCookies">saveUserToCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~setCookie">setCookie</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#CommentsHistory">CommentsHistory</a></li><li><a href="global.html#DateInput">DateInput</a></li><li><a href="global.html#DatePicker">DatePicker</a></li><li><a href="global.html#DateRangePicker">DateRangePicker</a></li><li><a href="global.html#DocumentUpload">DocumentUpload</a></li><li><a href="global.html#DropZone">DropZone</a></li><li><a href="global.html#FileUpload">FileUpload</a></li><li><a href="global.html#ImageUpload">ImageUpload</a></li><li><a href="global.html#InlineDateRangePicker">InlineDateRangePicker</a></li><li><a href="global.html#Login2">Login2</a></li><li><a href="global.html#MultiFileUpload">MultiFileUpload</a></li><li><a href="global.html#TaskCard">TaskCard</a></li><li><a href="global.html#TaskSummaryPage">TaskSummaryPage</a></li><li><a href="global.html#base64ToArrayBuffer">base64ToArrayBuffer</a></li><li><a href="global.html#decrypt">decrypt</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">layouts/full/header/Profile.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// // /**
// //  * @fileoverview Profile component for displaying and switching user roles with auto-logout on inactivity.
// //  * @module src/layouts/full/header/Profile
// //  * @author Rakshana
// //  * @date 16/07/2025
// //  * @since 1.0.0
// //  */

// // import React, { useState, useEffect, useCallback } from 'react';
// // import { useNavigate } from 'react-router';
// // import {
// //   Avatar,
// //   Box,
// //   Menu,
// //   Button,
// //   IconButton,
// //   MenuItem,
// //   ListItemText,
// //   Typography,
// //   Divider,
// //   CircularProgress,
// //   Alert
// // } from '@mui/material';

// // import ProfileImg from 'src/assets/images/profile/user-1.jpg';
// // import {
// //   decryptData,
// //   validateJsonData,
// //   isWebCryptoSupported,
// // } from 'src/components/Decryption/Decrypt';
// // import Cookies from 'js-cookie';

// // const getAuthHeaders = async () => {
// //   const encryptedToken = Cookies.get('HRToken');
     
// //   return {
// //     'Content-Type': 'application/json',
// //     'Authorization': `Bearer ${encryptedToken}`,
// //   };
// // };

// // const Profile = () => {
// //   const [anchorEl2, setAnchorEl2] = useState(null);
// //   const [roleData, setRoleData] = useState(null);
// //   const [selectedRole, setSelectedRole] = useState(null);
// //   const [loading, setLoading] = useState(false);
// //   const [error, setError] = useState(null);
// //   const navigate = useNavigate();
// //   const IMMEDIATE_LOGOUT_MODE = true; // Enabled for immediate checks on user interaction
// //   const SESSION_CHECK_INTERVAL = 30 * 1000; // Check session every 30 seconds
// //   const INACTIVITY_CHECK_INTERVAL = 5 * 1000; // Check inactivity every 5 seconds
// //   const INACTIVITY_TIMEOUT = 3600 * 1000; // Auto-logout after 1 minute of inactivity
// //   const RETRY_ATTEMPTS = 0; // No retries for faster logout
// //   const RETRY_DELAY = 1000; // Base delay (not used due to no retries)
// //   const MIN_CHECK_INTERVAL = 15 * 1000; // Minimum time between session checks
  
// //   const timeoutRef = React.useRef(null);
// //   const sessionCheckRef = React.useRef(null);
// //   const inactivityCheckRef = React.useRef(null);
// //   const retryCountRef = React.useRef(0);
// //   const isCheckingSessionRef = React.useRef(false);
// //   const isComponentMountedRef = React.useRef(true);
// //   const lastSuccessfulCheckRef = React.useRef(null);
  
// //   const HostName = 'https://wftest1.iitm.ac.in:7000';
// //   const API_TOKEN = 'HRFGVJISOVp1fncC';

// //   const handleClick2 = (event) => {
// //     setAnchorEl2(event.currentTarget);
// //   };

// //   const handleClose2 = () => {
// //     setAnchorEl2(null);
// //   };

// //   const getCookie = (name) => {
// //     const value = `; ${document.cookie}`;
// //     const parts = value.split(`; ${name}=`);
// //     if (parts.length === 2) return parts.pop().split(';').shift();
// //     return null;
// //   };

// //   const setCookie = (name, value, days = 1) => {
// //     const date = new Date();
// //     date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
// //     const expires = `expires=${date.toUTCString()}`;
// //     document.cookie = `${name}=${value};${expires};path=/`;
// //   };

// //   const deleteCookie = (name) => {
// //     document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
// //   };
  
// //   const getLoginName = () => {
// //     const loginName = sessionStorage.getItem('username') || 
// //                      localStorage.getItem('username') || 
// //                      getCookie('username');
// //     return loginName;
// //   };

// //   const handleLogout = useCallback(async (isAutoLogout = false) => {
// //     try {
// //       stopSessionMonitoring();
      
// //       if (timeoutRef.current) {
// //         clearTimeout(timeoutRef.current);
// //         timeoutRef.current = null;
// //       }
      
// //       const sessionId = getCookie('session_id');
// //       const clearAllStorage = () => {
// //         deleteCookie('session_id');
// //         deleteCookie('selectedRole');
// //         deleteCookie('userRole');
// //         deleteCookie('userId');
// //         deleteCookie('EmpId');
// //         deleteCookie('username');
// //         deleteCookie('userData');
// //         deleteCookie('HRToken');
// //         deleteCookie('isAuthenticated');
// //         sessionStorage.clear();
// //         localStorage.removeItem('username');
// //         localStorage.removeItem('userRole');
// //       };

// //       if (!sessionId) {
// //         clearAllStorage();
// //         navigate('/auth/login', { replace: true });
// //         return;
// //       }
// //       try {
// //         const headers = await getAuthHeaders();
// //         await fetch(`${HostName}/SessionTimeout`, {
// //           method: 'POST',
// //           headers: headers,
// //           body: JSON.stringify({
// //             token: API_TOKEN,
// //             session_id: sessionId,
// //             idletimeout: isAutoLogout ? 1 : 0
// //           }),
// //           signal: AbortSignal.timeout(2000)
// //         });
// //       } catch (apiError) {
// //       }
// //       clearAllStorage();
// //       if (isComponentMountedRef.current) {
// //         navigate('/auth/login', { replace: true });
// //       } else {
// //         window.location.href = '/auth/login';
// //       }
      
// //     } catch (error) {
// //       deleteCookie('session_id');
// //       deleteCookie('selectedRole');
// //       deleteCookie('userRole');
// //       deleteCookie('userId');
// //       deleteCookie('EmpId');
// //       deleteCookie('username');
// //       deleteCookie('userData');
// //       deleteCookie('HRToken');
// //       deleteCookie('isAuthenticated');
// //       sessionStorage.clear();
// //       localStorage.removeItem('username');
// //       localStorage.removeItem('userRole');
      
// //       if (isComponentMountedRef.current) {
// //         navigate('/auth/login', { replace: true });
// //       } else {
// //         window.location.href = '/auth/login';
// //       }
// //     }
    
// //     handleClose2();
// //   }, [navigate]);

// //   const checkSessionStatus = useCallback(async (isRetry = false, isUserInteraction = false) => {
    
// //     if (isCheckingSessionRef.current) {
// //       return true;
// //     }

// //     if (
// //       !isUserInteraction &amp;&amp;
// //       lastSuccessfulCheckRef.current &amp;&amp;
// //       Date.now() - lastSuccessfulCheckRef.current &lt; MIN_CHECK_INTERVAL
// //     ) {
// //       return true;
// //     }

// //     if (!isWebCryptoSupported()) {
// //       isCheckingSessionRef.current = false;
// //       await handleLogout(true);
// //       return false;
// //     }
// //     if (!isComponentMountedRef.current) {
// //       return false;
// //     }

// //     isCheckingSessionRef.current = true;

// //     try {
// //       const sessionId = getCookie('session_id');
      
// //       if (!sessionId) {
// //         isCheckingSessionRef.current = false;
// //         await handleLogout(true);
// //         return false;
// //       }

// //       const headers = await getAuthHeaders();
// //       const controller = new AbortController();
// //       const timeoutId = setTimeout(() => controller.abort(), 2000);

// //       const response = await fetch(`${HostName}/Sessiondata`, {
// //         method: 'POST',
// //         headers: headers,
// //         body: JSON.stringify({
// //           token: API_TOKEN,
// //           Session_id: sessionId
// //         }),
// //         signal: controller.signal
// //       });

// //       clearTimeout(timeoutId);

// //       if (!response.ok) {
// //         throw new Error(`Session check failed with status: ${response.status}`);
// //       }

// //       const encryptedData = await response.json();
      
// //       if (!encryptedData.Data) {
// //         throw new Error('No encrypted session data received');
// //       }
      
// //       const decryptedData = await decryptData(encryptedData.Data);
// //       const parsedData = validateJsonData(decryptedData);
      
// //       if (parsedData.Status === 200 &amp;&amp; parsedData.Data) {
// //         const sessionData = parsedData.Data;
// //         if (!sessionData.Records || !Array.isArray(sessionData.Records) || sessionData.Records.length === 0) {
// //           isCheckingSessionRef.current = false;
// //           await handleLogout(true);
// //           return false;
// //         }
// //         const sessionRecord = sessionData.Records[0];
// //         if (!sessionRecord.hasOwnProperty('is_active')) {
// //           isCheckingSessionRef.current = false;
// //           await handleLogout(true);
// //           return false;
// //         }
        
// //         const isActive = sessionRecord.is_active;
// //         if (sessionRecord.created_at) {
// //           const sessionCreated = new Date(sessionRecord.created_at).getTime();
// //           const currentTime = Date.now();
// //           const SESSION_MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours
// //           if (currentTime - sessionCreated > SESSION_MAX_AGE) {
// //             isCheckingSessionRef.current = false;
// //             await handleLogout(true);
// //             return false;
// //           }
// //         }

// //         if (isActive === 0 || isActive === "0" || isActive === false || isActive === "false") {
// //           isCheckingSessionRef.current = false;
// //           await handleLogout(true);
// //           return false;
// //         } else if (isActive === 1 || isActive === "1" || isActive === true || isActive === "true") {
// //           lastSuccessfulCheckRef.current = Date.now();
// //           retryCountRef.current = 0;
// //           isCheckingSessionRef.current = false;
// //           return true;
// //         } else if (isActive === null || isActive === undefined) {
// //           isCheckingSessionRef.current = false;
// //           await handleLogout(true);
// //           return false;
// //         } else {
// //           throw new Error(`Invalid session status: ${isActive} (type: ${typeof isActive})`);
// //         }
// //       } else {
// //         throw new Error(`Invalid session response structure - Status: ${parsedData.Status}`);
// //       }
// //     } catch (err) {
// //       isCheckingSessionRef.current = false;
// //       await handleLogout(true);
// //       return false;
// //     }
// //   }, [handleLogout]);

// //   const startSessionMonitoring = useCallback(() => {
    
// //     if (sessionCheckRef.current) {
// //       clearInterval(sessionCheckRef.current);
// //     }
// //     const immediateCheck = async () => {
// //       if (!isComponentMountedRef.current) {
// //         return;
// //       }
// //       await checkSessionStatus(false, false);
// //     };
// //     immediateCheck();
// //     const checkSession = async () => {
// //       if (!isComponentMountedRef.current) {
// //         return;
// //       }
// //       await checkSessionStatus();
// //     };
// //     sessionCheckRef.current = setInterval(checkSession, SESSION_CHECK_INTERVAL);
// //   }, [checkSessionStatus]);

// //   const startInactivityMonitoring = useCallback(() => {
    
// //     if (inactivityCheckRef.current) {
// //       clearInterval(inactivityCheckRef.current);
// //     }

// //     const checkInactivity = async () => {
// //       if (!isComponentMountedRef.current) {
// //         return;
// //       }

// //       const lastActivity = parseInt(sessionStorage.getItem('lastActivity') || '0', 10);
// //       const timeSinceLastActivity = Date.now() - lastActivity;

// //       if (timeSinceLastActivity >= INACTIVITY_TIMEOUT) {
// //         await handleLogout(true);
// //       }
// //     };

// //     inactivityCheckRef.current = setInterval(checkInactivity, INACTIVITY_CHECK_INTERVAL);
// //   }, [handleLogout]);

// //   const stopSessionMonitoring = useCallback(() => {
// //     if (sessionCheckRef.current) {
// //       clearInterval(sessionCheckRef.current);
// //       sessionCheckRef.current = null;
// //     }
// //     if (inactivityCheckRef.current) {
// //       clearInterval(inactivityCheckRef.current);
// //       inactivityCheckRef.current = null;
// //     }
// //     isCheckingSessionRef.current = false;
// //     retryCountRef.current = 0;
// //   }, []);
  
// //   const fetchRoleData = useCallback(async () => {
// //     if (!isWebCryptoSupported()) {
// //       setError('Web Crypto API not supported in this browser');
// //       return;
// //     }

// //     setLoading(true);
// //     setError(null);

// //     try {
// //       const loginName = getLoginName();
      
// //       const headers = await getAuthHeaders();
// //       const response = await fetch(`${HostName}/Defaultrole`, {
// //         method: 'POST',
// //         headers: headers,
// //         body: JSON.stringify({
// //           token: API_TOKEN,
// //           UserName: loginName
// //         })
// //       });

// //       if (!response.ok) {
// //         throw new Error(`HTTP error! status: ${response.status}`);
// //       }

// //       const encryptedData = await response.json();
      
// //       if (!encryptedData.Data) {
// //         throw new Error('No encrypted data received from API');
// //       }
      
// //       const decryptedData = await decryptData(encryptedData.Data);
// //       const parsedData = validateJsonData(decryptedData);
      
// //       if (parsedData.Status === 200 &amp;&amp; parsedData.Data) {
// //         setRoleData(parsedData.Data);
// //         const savedRole = getCookie('selectedRole');
// //         const activeRoles = parsedData.Data.Records.filter(role => role.IsActive === "true");
        
// //         if (savedRole &amp;&amp; activeRoles.some(role => role.RoleName === savedRole)) {
// //           setSelectedRole(savedRole);
// //         } else if (activeRoles.length > 0) {
// //           const defaultRole = activeRoles[0].RoleName;
// //           setSelectedRole(defaultRole);
// //           setCookie('selectedRole', defaultRole);
// //         }
// //       } else {
// //         throw new Error(parsedData.message || 'Failed to fetch role data');
// //       }
// //     } catch (err) {
// //       setError(err.message);
// //     } finally {
// //       setLoading(false);
// //     }
// //   }, []);

// //   useEffect(() => {
// //     isComponentMountedRef.current = true;
    
// //     fetchRoleData();
// //     startSessionMonitoring();
// //     startInactivityMonitoring();
// //     return () => {
// //       isComponentMountedRef.current = false;
// //       stopSessionMonitoring();
// //     };
// //   }, [fetchRoleData, startSessionMonitoring, startInactivityMonitoring, stopSessionMonitoring]);

// //   const handleRoleSelect = async (roleName) => {
// //     const isSessionValid = await checkSessionStatus(false, true);
    
// //     if (!isSessionValid) {
// //       return;
// //     }
    
// //     const previousRole = selectedRole;
    
// //     setSelectedRole(roleName);
// //     setCookie('selectedRole', roleName);
// //     setCookie('userRole', roleName, 7);
    
// //     const userDataCookie = getCookie('userData');
// //     if (userDataCookie) {
// //       try {
// //         const userData = JSON.parse(userDataCookie);
// //         userData.role = roleName;
// //         setCookie('userData', JSON.stringify(userData), 7);
// //       } catch (e) {
// //       }
// //     }
    
// //     if (sessionStorage.getItem('userRole')) {
// //       sessionStorage.setItem('userRole', roleName);
// //     }
// //     if (localStorage.getItem('userRole')) {
// //       localStorage.setItem('userRole', roleName);
// //     }
    
// //     handleClose2();
// //     window.dispatchEvent(new CustomEvent('roleChanged', { 
// //       detail: { newRole: roleName } 
// //     }));
// //     if (previousRole &amp;&amp; previousRole !== roleName) {
// //       window.location.href = '/dashboard';
// //     } else if (!previousRole) {
// //       navigate('/dashboard');
// //     }
// //   };

// //   const handleUserActivity = useCallback(async (event) => {
// //     if (IMMEDIATE_LOGOUT_MODE) {
// //       await checkSessionStatus(false, true);
// //     }
// //     sessionStorage.setItem('lastActivity', Date.now().toString());
// //   }, [checkSessionStatus]);

// //   useEffect(() => {
// //     const events = [
// //       'mousedown',
// //       'mousemove',
// //       'keypress',
// //       'scroll',
// //       'touchstart',
// //       'click',
// //       'focus',
// //       'blur',
// //       'keydown'
// //     ];
// //     const addEventListeners = () => {
// //       events.forEach(event => {
// //         document.addEventListener(event, handleUserActivity, { 
// //           passive: true, 
// //           capture: true 
// //         });
// //       });
// //     };

// //     const removeEventListeners = () => {
// //       events.forEach(event => {
// //         document.removeEventListener(event, handleUserActivity, { capture: true });
// //       });
// //     };

// //     addEventListeners();
    
// //     return () => {
// //       removeEventListeners();
// //       if (timeoutRef.current) {
// //         clearTimeout(timeoutRef.current);
// //       }
// //     };
// //   }, [handleUserActivity]);

// //   const handleManualLogout = () => {
// //     handleLogout(false);
// //   };

// //   const handleRefreshRoles = () => {
// //     fetchRoleData();
// //   };
  
// //   const activeRoles = roleData?.Records?.filter(role => role.IsActive === "true") || [];

// //   return (
// //     &lt;Box>
// //       &lt;IconButton
// //         size="large"
// //         aria-label="profile menu"
// //         color="inherit"
// //         aria-controls="msgs-menu"
// //         aria-haspopup="true"
// //         sx={{
// //           ...(typeof anchorEl2 === 'object' &amp;&amp; {
// //             color: '#e77d67',
// //           }),
// //         }}
// //         onClick={handleClick2}
// //       >
// //         &lt;Avatar
// //           src={ProfileImg}
// //           alt={ProfileImg}
// //           sx={{
// //             width: 45,
// //             height: 45,
// //           }}
// //         />
// //       &lt;/IconButton>
// //       &lt;Menu
// //         id="msgs-menu"
// //         anchorEl={anchorEl2}
// //         keepMounted
// //         open={Boolean(anchorEl2)}
// //         onClose={handleClose2}
// //         anchorOrigin={{ horizontal: 'right', vertical: 'bottom' }}
// //         transformOrigin={{ horizontal: 'right', vertical: 'top' }}
// //         sx={{
// //           '&amp; .MuiMenu-paper': {
// //             width: '300px',
// //             maxHeight: '400px',
// //             overflowY: 'auto'
// //           },
// //         }}
// //       >
// //         {/* Current Role Display */}
// //         {selectedRole &amp;&amp; (
// //           &lt;Box px={2} py={1}>
// //             &lt;Typography variant="subtitle2" color="text.secondary">
// //               Current Role:
// //             &lt;/Typography>
// //             &lt;Typography variant="body1" sx={{ fontWeight: 'bold' }}>
// //               {selectedRole}
// //             &lt;/Typography>
// //           &lt;/Box>
// //         )}

// //         &lt;Divider />

// //         {/* Role Information Section */}
// //         &lt;Box px={2} py={1}>
// //           {error &amp;&amp; (
// //             &lt;Alert severity="error" sx={{ mb: 1, fontSize: '0.75rem' }}>
// //               {error}
// //             &lt;/Alert>
// //           )}
          
// //           {loading &amp;&amp; !roleData &amp;&amp; (
// //             &lt;Box display='flex' justifyContent='center' py={2}>
// //               &lt;CircularProgress size={20} />
// //             &lt;/Box>
// //           )}
          
// //           {activeRoles.length > 0 &amp;&amp; (
// //             &lt;Box>
// //               &lt;Typography variant='caption' color='textSecondary' sx={{ mb: 1, display: 'block' }}>
// //                 {activeRoles.length} active role{activeRoles.length !== 1 ? 's' : ''} available
// //               &lt;/Typography>
// //               {activeRoles.map((role, index) => (
// //                 &lt;MenuItem 
// //                   key={index} 
// //                   onClick={() => handleRoleSelect(role.RoleName)}
// //                   selected={role.RoleName === selectedRole}
// //                   sx={{ 
// //                     mb: 1, 
// //                     borderRadius: 1,
// //                     bgcolor: role.RoleName === selectedRole ? 'primary.light' : 'background.paper',
// //                     '&amp;:hover': {
// //                       bgcolor: role.RoleName === selectedRole ? 'primary.light' : 'action.hover'
// //                     }
// //                   }}
// //                 >
// //                   &lt;ListItemText
// //                     primary={role.RoleName}
// //                     primaryTypographyProps={{
// //                       fontWeight: role.RoleName === selectedRole ? 'bold' : 'normal',
// //                       color: role.RoleName === selectedRole ? '#e77d67' : 'text.primary'
// //                     }}
// //                     secondaryTypographyProps={{
// //                       fontSize: '0.7rem',
// //                       color: 'success.main'
// //                     }}
// //                   />
// //                 &lt;/MenuItem>
// //               ))}
// //             &lt;/Box>
// //           )}

// //           {/* Show message when no active roles are available */}
// //           {roleData &amp;&amp; activeRoles.length === 0 &amp;&amp; (
// //             &lt;Box py={2} textAlign="center">
// //               &lt;Typography variant="body2" color="text.secondary">
// //                 No active roles available
// //               &lt;/Typography>
// //             &lt;/Box>
// //           )}
// //         &lt;/Box>

// //         &lt;Divider />

// //         &lt;Box mt={1} py={1} px={2}>
// //           &lt;Button 
// //             variant="contained" 
// //             color="primary" 
// //             fullWidth
// //             onClick={handleManualLogout}
// //           >
// //             Logout
// //           &lt;/Button>
// //         &lt;/Box>
// //       &lt;/Menu>
// //     &lt;/Box>
// //   );
// // };

// // export default Profile;


// /**
//  * @fileoverview Profile component for displaying and switching user roles with auto-logout on inactivity.
//  * @module src/layouts/full/header/Profile
//  * @author Rakshana
//  * @date 16/07/2025
//  * @since 1.0.0
//  */

// import React, { useState, useEffect, useCallback } from 'react';
// import { useNavigate } from 'react-router';
// import {
//   Avatar,
//   Box,
//   Menu,
//   Button,
//   IconButton,
//   MenuItem,
//   ListItemText,
//   Typography,
//   Divider,
//   CircularProgress,
//   Alert
// } from '@mui/material';

// import ProfileImg from 'src/assets/images/profile/user-1.jpg';
// import {
//   decryptData,
//   validateJsonData,
//   isWebCryptoSupported,
// } from 'src/components/Decryption/Decrypt';
// import Cookies from 'js-cookie';
// import { HostName } from "src/assets/host/Host";

// const getAuthHeaders = async () => {
//   const encryptedToken = Cookies.get('HRToken');
      
//   return {
//     'Content-Type': 'application/json',
//     'Authorization': `Bearer ${encryptedToken}`,
//   };
// };

// const Profile = () => {
//   const [anchorEl2, setAnchorEl2] = useState(null);
//   const [roleData, setRoleData] = useState(null);
//   const [selectedRole, setSelectedRole] = useState(null);
//   const [loading, setLoading] = useState(false);
//   const [error, setError] = useState(null);
//   const navigate = useNavigate();
//   const IMMEDIATE_LOGOUT_MODE = true; // Enabled for immediate checks on user interaction
//   const SESSION_CHECK_INTERVAL = 30 * 1000; // Check session every 30 seconds
//   const INACTIVITY_CHECK_INTERVAL = 5 * 1000; // Check inactivity every 5 seconds
//   const INACTIVITY_TIMEOUT = 3600 * 1000; // Auto-logout after 1 minute of inactivity
//   const RETRY_ATTEMPTS = 0; // No retries for faster logout
//   const RETRY_DELAY = 1000; // Base delay (not used due to no retries)
//   const MIN_CHECK_INTERVAL = 15 * 1000; // Minimum time between session checks
  
//   const timeoutRef = React.useRef(null);
//   const sessionCheckRef = React.useRef(null);
//   const inactivityCheckRef = React.useRef(null);
//   const retryCountRef = React.useRef(0);
//   const isCheckingSessionRef = React.useRef(false);
//   const isComponentMountedRef = React.useRef(true);
//   const lastSuccessfulCheckRef = React.useRef(null);
  
//   //const HostName = 'https://wftest1.iitm.ac.in:7000';
//   const API_TOKEN = 'HRFGVJISOVp1fncC';

//   const handleClick2 = (event) => {
//     setAnchorEl2(event.currentTarget);
//   };

//   const handleClose2 = () => {
//     setAnchorEl2(null);
//   };

//   const getCookie = (name) => {
//     const value = `; ${document.cookie}`;
//     const parts = value.split(`; ${name}=`);
//     if (parts.length === 2) return parts.pop().split(';').shift();
//     return null;
//   };

//   const setCookie = (name, value, days = 1) => {
//     const date = new Date();
//     date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
//     const expires = `expires=${date.toUTCString()}`;
//     document.cookie = `${name}=${value};${expires};path=/`;
//   };

//   const deleteCookie = (name) => {
//     document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
//   };
  
//   const getLoginName = () => {
//     const loginName = sessionStorage.getItem('username') || 
//                      localStorage.getItem('username') || 
//                      getCookie('username');
//     return loginName;
//   };

//   const handleLogout = useCallback(async (isAutoLogout = false) => {
//     try {
//       stopSessionMonitoring();
      
//       if (timeoutRef.current) {
//         clearTimeout(timeoutRef.current);
//         timeoutRef.current = null;
//       }
      
//       const sessionId = getCookie('session_id');
//       const clearAllStorage = () => {
//         deleteCookie('session_id');
//         deleteCookie('selectedRole');
//         deleteCookie('userRole');
//         deleteCookie('userId');
//         deleteCookie('EmpId');
//         deleteCookie('username');
//         deleteCookie('userData');
//         deleteCookie('HRToken');
//         deleteCookie('isAuthenticated');
//         sessionStorage.clear();
//         localStorage.removeItem('username');
//         localStorage.removeItem('userRole');
//       };

//       if (!sessionId) {
//         clearAllStorage();
//         navigate('/auth/login', { replace: true });
//         return;
//       }
//       try {
//         const headers = await getAuthHeaders();
//         // await fetch(`${HostName}/SessionTimeout`, {
//         //   method: 'POST',
//         //   headers: headers,
//         //   body: JSON.stringify({
//         //     token: API_TOKEN,
//         //     session_id: sessionId,
//         //     //idletimeout: isAutoLogout ? 1 : 0
//         //   }),
//         //   signal: AbortSignal.timeout(2000)
//         // });
//       } catch (apiError) {
//       }
//       clearAllStorage();
//       if (isComponentMountedRef.current) {
//         navigate('/auth/login', { replace: true });
//       } else {
//         window.location.href = '/auth/login';
//       }
      
//     } catch (error) {
//       deleteCookie('session_id');
//       deleteCookie('selectedRole');
//       deleteCookie('userRole');
//       deleteCookie('userId');
//       deleteCookie('EmpId');
//       deleteCookie('username');
//       deleteCookie('userData');
//       deleteCookie('HRToken');
//       deleteCookie('isAuthenticated');
//       sessionStorage.clear();
//       localStorage.removeItem('username');
//       localStorage.removeItem('userRole');
      
//       if (isComponentMountedRef.current) {
//         navigate('/auth/login', { replace: true });
//       } else {
//         window.location.href = '/auth/login';
//       }
//     }
    
//     handleClose2();
//   }, [navigate]);

//   const checkSessionStatus = useCallback(async (isRetry = false, isUserInteraction = false) => {
    
//     if (isCheckingSessionRef.current) {
//       return true;
//     }

//     if (
//       !isUserInteraction &amp;&amp;
//       lastSuccessfulCheckRef.current &amp;&amp;
//       Date.now() - lastSuccessfulCheckRef.current &lt; MIN_CHECK_INTERVAL
//     ) {
//       return true;
//     }

//     if (!isWebCryptoSupported()) {
//       isCheckingSessionRef.current = false;
//       await handleLogout(true);
//       return false;
//     }
//     if (!isComponentMountedRef.current) {
//       return false;
//     }

//     isCheckingSessionRef.current = true;

//     try {
//       const sessionId = getCookie('session_id');
      
//       if (!sessionId) {
//         isCheckingSessionRef.current = false;
//         await handleLogout(true);
//         return false;
//       }

//       const headers = await getAuthHeaders();
//       const controller = new AbortController();
//       const timeoutId = setTimeout(() => controller.abort(), 2000);

//       const response = await fetch(`${HostName}/Sessiondata`, {
//         method: 'POST',
//         headers: headers,
//         body: JSON.stringify({
//           token: API_TOKEN,
//           Session_id: sessionId
//         }),
//         signal: controller.signal
//       });

//       clearTimeout(timeoutId);

//       if (!response.ok) {
//         throw new Error(`Session check failed with status: ${response.status}`);
//       }

//       const encryptedData = await response.json();
      
//       if (!encryptedData.Data) {
//         throw new Error('No encrypted session data received');
//       }
      
//       const decryptedData = await decryptData(encryptedData.Data);
//       const parsedData = validateJsonData(decryptedData);
      
//       if (parsedData.Status === 200 &amp;&amp; parsedData.Data) {
//         const sessionData = parsedData.Data;
//         if (!sessionData.Records || !Array.isArray(sessionData.Records) || sessionData.Records.length === 0) {
//           isCheckingSessionRef.current = false;
//           await handleLogout(true);
//           return false;
//         }
//         const sessionRecord = sessionData.Records[0];
//         if (!sessionRecord.hasOwnProperty('is_active')) {
//           isCheckingSessionRef.current = false;
//           await handleLogout(true);
//           return false;
//         }
        
//         const isActive = sessionRecord.is_active;
//         if (sessionRecord.created_at) {
//           const sessionCreated = new Date(sessionRecord.created_at).getTime();
//           const currentTime = Date.now();
//           const SESSION_MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours
//           if (currentTime - sessionCreated > SESSION_MAX_AGE) {
//             isCheckingSessionRef.current = false;
//             await handleLogout(true);
//             return false;
//           }
//         }

//         if (isActive === 0 || isActive === "0" || isActive === false || isActive === "false") {
//           isCheckingSessionRef.current = false;
//           await handleLogout(true);
//           return false;
//         } else if (isActive === 1 || isActive === "1" || isActive === true || isActive === "true") {
//           lastSuccessfulCheckRef.current = Date.now();
//           retryCountRef.current = 0;
//           isCheckingSessionRef.current = false;
//           return true;
//         } else if (isActive === null || isActive === undefined) {
//           isCheckingSessionRef.current = false;
//           await handleLogout(true);
//           return false;
//         } else {
//           throw new Error(`Invalid session status: ${isActive} (type: ${typeof isActive})`);
//         }
//       } else {
//         throw new Error(`Invalid session response structure - Status: ${parsedData.Status}`);
//       }
//     } catch (err) {
//       isCheckingSessionRef.current = false;
//       await handleLogout(true);
//       return false;
//     }
//   }, [handleLogout]);

//   const startSessionMonitoring = useCallback(() => {
    
//     if (sessionCheckRef.current) {
//       clearInterval(sessionCheckRef.current);
//     }
//     const immediateCheck = async () => {
//       if (!isComponentMountedRef.current) {
//         return;
//       }
//       await checkSessionStatus(false, false);
//     };
//     immediateCheck();
//     const checkSession = async () => {
//       if (!isComponentMountedRef.current) {
//         return;
//       }
//       await checkSessionStatus();
//     };
//     sessionCheckRef.current = setInterval(checkSession, SESSION_CHECK_INTERVAL);
//   }, [checkSessionStatus]);

//   const startInactivityMonitoring = useCallback(() => {
    
//     if (inactivityCheckRef.current) {
//       clearInterval(inactivityCheckRef.current);
//     }

//     const checkInactivity = async () => {
//       if (!isComponentMountedRef.current) {
//         return;
//       }

//       const lastActivity = parseInt(sessionStorage.getItem('lastActivity') || '0', 10);
//       const timeSinceLastActivity = Date.now() - lastActivity;

//       if (timeSinceLastActivity >= INACTIVITY_TIMEOUT) {
//         await handleLogout(true);
//       }
//     };

//     inactivityCheckRef.current = setInterval(checkInactivity, INACTIVITY_CHECK_INTERVAL);
//   }, [handleLogout]);

//   const stopSessionMonitoring = useCallback(() => {
//     if (sessionCheckRef.current) {
//       clearInterval(sessionCheckRef.current);
//       sessionCheckRef.current = null;
//     }
//     if (inactivityCheckRef.current) {
//       clearInterval(inactivityCheckRef.current);
//       inactivityCheckRef.current = null;
//     }
//     isCheckingSessionRef.current = false;
//     retryCountRef.current = 0;
//   }, []);
  
//   const fetchRoleData = useCallback(async () => {
//     if (!isWebCryptoSupported()) {
//       setError('Web Crypto API not supported in this browser');
//       return;
//     }

//     setLoading(true);
//     setError(null);

//     try {
//       const loginName = getLoginName();
      
//       const headers = await getAuthHeaders();
//       const sessionId = Cookies.get("session_id");
//       const response = await fetch(`${HostName}/Defaultrole`, {
//         method: 'POST',
//         headers: headers,
//         body: JSON.stringify({
//           token: API_TOKEN,
//           UserName: loginName,
//           session_id: sessionId,
//         })
//       });

//       if (!response.ok) {
//         throw new Error(`HTTP error! status: ${response.status}`);
//       }

//       const encryptedData = await response.json();
      
//       if (!encryptedData.Data) {
//         throw new Error('No encrypted data received from API');
//       }
      
//       const decryptedData = await decryptData(encryptedData.Data);
//       const parsedData = validateJsonData(decryptedData);
      
//       if (parsedData.Status === 200 &amp;&amp; parsedData.Data) {
//         setRoleData(parsedData.Data);
//         const savedRole = getCookie('selectedRole');
//         const activeRoles = parsedData.Data.Records.filter(role => role.IsActive === "true");
        
//         if (savedRole &amp;&amp; activeRoles.some(role => role.RoleName === savedRole)) {
//           setSelectedRole(savedRole);
//         } else if (activeRoles.length > 0) {
//           const defaultRole = activeRoles[0].RoleName;
//           setSelectedRole(defaultRole);
//           setCookie('selectedRole', defaultRole);
//         }
//       } else {
//         throw new Error(parsedData.message || 'Failed to fetch role data');
//       }
//     } catch (err) {
//       setError(err.message);
//     } finally {
//       setLoading(false);
//     }
//   }, []);

//   useEffect(() => {
//     isComponentMountedRef.current = true;
    
//     fetchRoleData();
//     startSessionMonitoring();
//     startInactivityMonitoring();
//     return () => {
//       isComponentMountedRef.current = false;
//       stopSessionMonitoring();
//     };
//   }, [fetchRoleData, startSessionMonitoring, startInactivityMonitoring, stopSessionMonitoring]);

//   const handleRoleSelect = async (roleName) => {
//     const isSessionValid = await checkSessionStatus(false, true);
    
//     if (!isSessionValid) {
//       return;
//     }
    
//     const previousRole = selectedRole;
    
//     setSelectedRole(roleName);
//     setCookie('selectedRole', roleName);
//     setCookie('userRole', roleName, 7);
    
//     const userDataCookie = getCookie('userData');
//     if (userDataCookie) {
//       try {
//         const userData = JSON.parse(userDataCookie);
//         userData.role = roleName;
//         setCookie('userData', JSON.stringify(userData), 7);
//       } catch (e) {
//       }
//     }
    
//     if (sessionStorage.getItem('userRole')) {
//       sessionStorage.setItem('userRole', roleName);
//     }
//     if (localStorage.getItem('userRole')) {
//       localStorage.setItem('userRole', roleName);
//     }
    
//     handleClose2();
//     window.dispatchEvent(new CustomEvent('roleChanged', { 
//       detail: { newRole: roleName } 
//     }));
//     if (previousRole &amp;&amp; previousRole !== roleName) {
//       window.location.href = '/dashboard';
//     } else if (!previousRole) {
//       navigate('/dashboard');
//     }
//   };

//   const handleUserActivity = useCallback(async (event) => {
//     if (IMMEDIATE_LOGOUT_MODE) {
//       await checkSessionStatus(false, true);
//     }
//     sessionStorage.setItem('lastActivity', Date.now().toString());
//   }, [checkSessionStatus]);

//   useEffect(() => {
//     const events = [
//       'mousedown',
//       'mousemove',
//       'keypress',
//       'scroll',
//       'touchstart',
//       'click',
//       'focus',
//       'blur',
//       'keydown'
//     ];
//     const addEventListeners = () => {
//       events.forEach(event => {
//         document.addEventListener(event, handleUserActivity, { 
//           passive: true, 
//           capture: true 
//         });
//       });
//     };

//     const removeEventListeners = () => {
//       events.forEach(event => {
//         document.removeEventListener(event, handleUserActivity, { capture: true });
//       });
//     };

//     addEventListeners();
    
//     return () => {
//       removeEventListeners();
//       if (timeoutRef.current) {
//         clearTimeout(timeoutRef.current);
//       }
//     };
//   }, [handleUserActivity]);

//   const handleManualLogout = () => {
//     handleLogout(false);
//   };

//   const handleRefreshRoles = () => {
//     fetchRoleData();
//   };
  
//   const activeRoles = roleData?.Records?.filter(role => role.IsActive === "true") || [];

//   return (
//     &lt;Box>
//       &lt;IconButton
//         size="large"
//         aria-label="profile menu"
//         color="inherit"
//         aria-controls="msgs-menu"
//         aria-haspopup="true"
//         sx={{
//           ...(typeof anchorEl2 === 'object' &amp;&amp; {
//             color: '#ed553b',
//           }),
//         }}
//         onClick={handleClick2}
//       >
//         &lt;Avatar
//           src={ProfileImg}
//           alt={ProfileImg}
//           sx={{
//             width: 45,
//             height: 45,
//           }}
//         />
//       &lt;/IconButton>
//       &lt;Menu
//         id="msgs-menu"
//         anchorEl={anchorEl2}
//         keepMounted
//         open={Boolean(anchorEl2)}
//         onClose={handleClose2}
//         anchorOrigin={{ horizontal: 'right', vertical: 'bottom' }}
//         transformOrigin={{ horizontal: 'right', vertical: 'top' }}
//         sx={{
//           '&amp; .MuiMenu-paper': {
//             width: '300px',
//             maxHeight: '400px',
//             overflowY: 'auto'
//           },
//         }}
//       >
//         {/* Current Role Display */}
//         {selectedRole &amp;&amp; (
//           &lt;Box px={2} py={1}>
//             &lt;Typography variant="subtitle2" color="text.secondary">
//               Current Role:
//             &lt;/Typography>
//             &lt;Typography variant="body1" sx={{ fontWeight: 'bold' }}>
//               {selectedRole}
//             &lt;/Typography>
//           &lt;/Box>
//         )}

//         &lt;Divider />

//         {/* Role Information Section */}
//         &lt;Box px={2} py={1}>
//           {error &amp;&amp; (
//             &lt;Alert severity="error" sx={{ mb: 1, fontSize: '0.75rem' }}>
//               {error}
//             &lt;/Alert>
//           )}
          
//           {loading &amp;&amp; !roleData &amp;&amp; (
//             &lt;Box display='flex' justifyContent='center' py={2}>
//               &lt;CircularProgress size={20} />
//             &lt;/Box>
//           )}
          
//           {activeRoles.length > 0 &amp;&amp; (
//             &lt;Box>
//               &lt;Typography variant='caption' color='textSecondary' sx={{ mb: 1, display: 'block' }}>
//                 {activeRoles.length} active role{activeRoles.length !== 1 ? 's' : ''} available
//               &lt;/Typography>
//               {activeRoles.map((role, index) => (
//                 &lt;MenuItem 
//                   key={index} 
//                   onClick={() => handleRoleSelect(role.RoleName)}
//                   selected={role.RoleName === selectedRole}
//                   sx={{ 
//                     mb: 1, 
//                     borderRadius: 1,
//                     bgcolor: role.RoleName === selectedRole ? '#ed553b' : 'background.paper',
//                     '&amp;:hover': {
//                       bgcolor: role.RoleName === selectedRole ? '#f8c6b0' : 'action.hover'
//                     }
//                   }}
//                 >
//                   &lt;ListItemText
//                     primary={role.RoleName}
//                     primaryTypographyProps={{
//                       fontWeight: role.RoleName === selectedRole ? 'bold' : 'normal',
//                       color: role.RoleName === selectedRole ? '#ed553b' : 'text.primary'
//                     }}
//                     secondaryTypographyProps={{
//                       fontSize: '0.7rem',
//                       color: 'success.main'
//                     }}
//                   />
//                 &lt;/MenuItem>
//               ))}
//             &lt;/Box>
//           )}

//           {/* Show message when no active roles are available */}
//           {roleData &amp;&amp; activeRoles.length === 0 &amp;&amp; (
//             &lt;Box py={2} textAlign="center">
//               &lt;Typography variant="body2" color="text.secondary">
//                 No active roles available
//               &lt;/Typography>
//             &lt;/Box>
//           )}
//         &lt;/Box>

//         &lt;Divider />

//         &lt;Box mt={1} py={1} px={2}>
//           &lt;Button 
//             variant="contained" 
//             color="primary" 
//             fullWidth
//             onClick={handleManualLogout}
//             sx={{
//               backgroundColor: '#ed553b',
//               '&amp;:hover': {
//                 backgroundColor: '#ed553b'
//               }
//             }}
//           >
//             Logout
//           &lt;/Button>
//         &lt;/Box>
//       &lt;/Menu>
//     &lt;/Box>
//   );
// };

// export default Profile;




// /**
//  * @fileoverview Profile component for displaying and switching user roles with auto-logout on inactivity.
//  * @module src/layouts/full/header/Profile
//  * @author Rakshana
//  * @date 16/07/2025
//  * @since 1.0.0
//  */

// import React, { useState, useEffect, useCallback } from 'react';
// import { useNavigate } from 'react-router';
// import {
//   Avatar,
//   Box,
//   Menu,
//   Button,
//   IconButton,
//   MenuItem,
//   ListItemText,
//   Typography,
//   Divider,
//   CircularProgress,
//   Alert
// } from '@mui/material';

// import ProfileImg from 'src/assets/images/profile/user-1.jpg';
// import {
//   decryptData,
//   validateJsonData,
//   isWebCryptoSupported,
// } from 'src/components/Decryption/Decrypt';
// import Cookies from 'js-cookie';
// import { HostName } from "src/assets/host/Host";

// const getAuthHeaders = async () => {
//   const encryptedToken = Cookies.get('HRToken');
      
//   return {
//     'Content-Type': 'application/json',
//     'Authorization': `Bearer ${encryptedToken}`,
//   };
// };

// const Profile = () => {
//   const [anchorEl2, setAnchorEl2] = useState(null);
//   const [roleData, setRoleData] = useState(null);
//   const [selectedRole, setSelectedRole] = useState(null);
//   const [loading, setLoading] = useState(false);
//   const [error, setError] = useState(null);
//   const navigate = useNavigate();
//   const IMMEDIATE_LOGOUT_MODE = true; // Enabled for immediate checks on user interaction
//   const SESSION_CHECK_INTERVAL = 30 * 1000; // Check session every 30 seconds
//   const INACTIVITY_CHECK_INTERVAL = 5 * 1000; // Check inactivity every 5 seconds
//   const INACTIVITY_TIMEOUT = 3600 * 1000; // Auto-logout after 1 minute of inactivity
//   const RETRY_ATTEMPTS = 0; // No retries for faster logout
//   const RETRY_DELAY = 1000; // Base delay (not used due to no retries)
//   const MIN_CHECK_INTERVAL = 15 * 1000; // Minimum time between session checks
  
//   const timeoutRef = React.useRef(null);
//   const sessionCheckRef = React.useRef(null);
//   const inactivityCheckRef = React.useRef(null);
//   const retryCountRef = React.useRef(0);
//   const isCheckingSessionRef = React.useRef(false);
//   const isComponentMountedRef = React.useRef(true);
//   const lastSuccessfulCheckRef = React.useRef(null);
  
//   //const HostName = 'https://wftest1.iitm.ac.in:7000';
//   const API_TOKEN = 'HRFGVJISOVp1fncC';

//   const handleClick2 = (event) => {
//     setAnchorEl2(event.currentTarget);
//   };

//   const handleClose2 = () => {
//     setAnchorEl2(null);
//   };

//   const getCookie = (name) => {
//     const value = `; ${document.cookie}`;
//     const parts = value.split(`; ${name}=`);
//     if (parts.length === 2) return parts.pop().split(';').shift();
//     return null;
//   };

//   const setCookie = (name, value, days = 1) => {
//     const date = new Date();
//     date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
//     const expires = `expires=${date.toUTCString()}`;
//     document.cookie = `${name}=${value};${expires};path=/`;
//   };

//   const deleteCookie = (name) => {
//     document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
//   };
  
//   const getLoginName = () => {
//     const loginName = sessionStorage.getItem('username') || 
//                      localStorage.getItem('username') || 
//                      getCookie('username');
//     return loginName;
//   };

//   const handleLogout = useCallback(async (isAutoLogout = false) => {
//     try {
//       stopSessionMonitoring();
      
//       if (timeoutRef.current) {
//         clearTimeout(timeoutRef.current);
//         timeoutRef.current = null;
//       }
      
//       const sessionId = getCookie('session_id');
//       const clearAllStorage = () => {
//         deleteCookie('session_id');
//         deleteCookie('selectedRole');
//         deleteCookie('userRole');
//         deleteCookie('userId');
//         deleteCookie('EmpId');
//         deleteCookie('username');
//         deleteCookie('userData');
//         deleteCookie('HRToken');
//         deleteCookie('isAuthenticated');
//         sessionStorage.clear();
//         localStorage.removeItem('username');
//         localStorage.removeItem('userRole');
//       };

//       if (!sessionId) {
//         clearAllStorage();
//         navigate('/auth/login', { replace: true });
//         return;
//       }
//       // try {
//       //   const headers = await getAuthHeaders();
//       //   await fetch(`${HostName}/SessionTimeout`, {
//       //     method: 'POST',
//       //     headers: headers,
//       //     body: JSON.stringify({
//       //       token: API_TOKEN,
//       //       session_id: sessionId,
//       //       idletimeout: isAutoLogout ? 1 : 0
//       //     }),
//       //     signal: AbortSignal.timeout(2000)
//       //   });
//       // } catch (apiError) {
//       // }
//       // clearAllStorage();
//       // if (isComponentMountedRef.current) {
//       //   navigate('/auth/login', { replace: true });
//       // } else {
//       //   window.location.href = '/auth/login';
//       // }
      
//     } catch (error) {
//       deleteCookie('session_id');
//       deleteCookie('selectedRole');
//       deleteCookie('userRole');
//       deleteCookie('userId');
//       deleteCookie('EmpId');
//       deleteCookie('username');
//       deleteCookie('userData');
//       deleteCookie('HRToken');
//       deleteCookie('isAuthenticated');
//       sessionStorage.clear();
//       localStorage.removeItem('username');
//       localStorage.removeItem('userRole');
      
//       if (isComponentMountedRef.current) {
//         navigate('/auth/login', { replace: true });
//       } else {
//         window.location.href = '/auth/login';
//       }
//     }
    
//     handleClose2();
//   }, [navigate]);

//   const checkSessionStatus = useCallback(async (isRetry = false, isUserInteraction = false) => {
    
//     if (isCheckingSessionRef.current) {
//       return true;
//     }

//     if (
//       !isUserInteraction &amp;&amp;
//       lastSuccessfulCheckRef.current &amp;&amp;
//       Date.now() - lastSuccessfulCheckRef.current &lt; MIN_CHECK_INTERVAL
//     ) {
//       return true;
//     }

//     if (!isWebCryptoSupported()) {
//       isCheckingSessionRef.current = false;
//       await handleLogout(true);
//       return false;
//     }
//     if (!isComponentMountedRef.current) {
//       return false;
//     }

//     isCheckingSessionRef.current = true;

//     try {
//       const sessionId = getCookie('session_id');
      
//       if (!sessionId) {
//         isCheckingSessionRef.current = false;
//         await handleLogout(true);
//         return false;
//       }

//       const headers = await getAuthHeaders();
//       const controller = new AbortController();
//       const timeoutId = setTimeout(() => controller.abort(), 2000);

//       const response = await fetch(`${HostName}/Sessiondata`, {
//         method: 'POST',
//         headers: headers,
//         body: JSON.stringify({
//           token: API_TOKEN,
//           Session_id: sessionId
//         }),
//         signal: controller.signal
//       });

//       clearTimeout(timeoutId);

//       if (!response.ok) {
//         throw new Error(`Session check failed with status: ${response.status}`);
//       }

//       const encryptedData = await response.json();
      
//       if (!encryptedData.Data) {
//         throw new Error('No encrypted session data received');
//       }
      
//       const decryptedData = await decryptData(encryptedData.Data);
//       const parsedData = validateJsonData(decryptedData);
      
//       if (parsedData.Status === 200 &amp;&amp; parsedData.Data) {
//         const sessionData = parsedData.Data;
//         if (!sessionData.Records || !Array.isArray(sessionData.Records) || sessionData.Records.length === 0) {
//           isCheckingSessionRef.current = false;
//           await handleLogout(true);
//           return false;
//         }
//         const sessionRecord = sessionData.Records[0];
//         if (!sessionRecord.hasOwnProperty('is_active')) {
//           isCheckingSessionRef.current = false;
//           await handleLogout(true);
//           return false;
//         }
        
//         const isActive = sessionRecord.is_active;
//         if (sessionRecord.created_at) {
//           const sessionCreated = new Date(sessionRecord.created_at).getTime();
//           const currentTime = Date.now();
//           const SESSION_MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours
//           if (currentTime - sessionCreated > SESSION_MAX_AGE) {
//             isCheckingSessionRef.current = false;
//             await handleLogout(true);
//             return false;
//           }
//         }

//         if (isActive === 0 || isActive === "0" || isActive === false || isActive === "false") {
//           isCheckingSessionRef.current = false;
//           await handleLogout(true);
//           return false;
//         } else if (isActive === 1 || isActive === "1" || isActive === true || isActive === "true") {
//           lastSuccessfulCheckRef.current = Date.now();
//           retryCountRef.current = 0;
//           isCheckingSessionRef.current = false;
//           return true;
//         } else if (isActive === null || isActive === undefined) {
//           isCheckingSessionRef.current = false;
//           await handleLogout(true);
//           return false;
//         } else {
//           throw new Error(`Invalid session status: ${isActive} (type: ${typeof isActive})`);
//         }
//       } else {
//         throw new Error(`Invalid session response structure - Status: ${parsedData.Status}`);
//       }
//     } catch (err) {
//       isCheckingSessionRef.current = false;
//       await handleLogout(true);
//       return false;
//     }
//   }, [handleLogout]);

//   const startSessionMonitoring = useCallback(() => {
    
//     if (sessionCheckRef.current) {
//       clearInterval(sessionCheckRef.current);
//     }
//     const immediateCheck = async () => {
//       if (!isComponentMountedRef.current) {
//         return;
//       }
//       await checkSessionStatus(false, false);
//     };
//     immediateCheck();
//     const checkSession = async () => {
//       if (!isComponentMountedRef.current) {
//         return;
//       }
//       await checkSessionStatus();
//     };
//     sessionCheckRef.current = setInterval(checkSession, SESSION_CHECK_INTERVAL);
//   }, [checkSessionStatus]);

//   const startInactivityMonitoring = useCallback(() => {
    
//     if (inactivityCheckRef.current) {
//       clearInterval(inactivityCheckRef.current);
//     }

//     const checkInactivity = async () => {
//       if (!isComponentMountedRef.current) {
//         return;
//       }

//       const lastActivity = parseInt(sessionStorage.getItem('lastActivity') || '0', 10);
//       const timeSinceLastActivity = Date.now() - lastActivity;

//       if (timeSinceLastActivity >= INACTIVITY_TIMEOUT) {
//         await handleLogout(true);
//       }
//     };

//     inactivityCheckRef.current = setInterval(checkInactivity, INACTIVITY_CHECK_INTERVAL);
//   }, [handleLogout]);

//   const stopSessionMonitoring = useCallback(() => {
//     if (sessionCheckRef.current) {
//       clearInterval(sessionCheckRef.current);
//       sessionCheckRef.current = null;
//     }
//     if (inactivityCheckRef.current) {
//       clearInterval(inactivityCheckRef.current);
//       inactivityCheckRef.current = null;
//     }
//     isCheckingSessionRef.current = false;
//     retryCountRef.current = 0;
//   }, []);
  
//   const fetchRoleData = useCallback(async () => {
//     if (!isWebCryptoSupported()) {
//       setError('Web Crypto API not supported in this browser');
//       return;
//     }

//     setLoading(true);
//     setError(null);

//     try {
//       const loginName = getLoginName();
      
//       const headers = await getAuthHeaders();
//       const sessionId = Cookies.get("session_id");
//       const response = await fetch(`${HostName}/Defaultrole`, {
//         method: 'POST',
//         headers: headers,
//         body: JSON.stringify({
//           token: API_TOKEN,
//           UserName: loginName,
//           session_id: sessionId,
//         })
//       });

//       if (!response.ok) {
//         throw new Error(`HTTP error! status: ${response.status}`);
//       }

//       const encryptedData = await response.json();
      
//       if (!encryptedData.Data) {
//         throw new Error('No encrypted data received from API');
//       }
      
//       const decryptedData = await decryptData(encryptedData.Data);
//       const parsedData = validateJsonData(decryptedData);
      
//       if (parsedData.Status === 200 &amp;&amp; parsedData.Data) {
//         setRoleData(parsedData.Data);
//         const savedRole = getCookie('selectedRole');
//         const activeRoles = parsedData.Data.Records.filter(role => role.IsActive === "true");
        
//         if (savedRole &amp;&amp; activeRoles.some(role => role.RoleName === savedRole)) {
//           setSelectedRole(savedRole);
//         } else if (activeRoles.length > 0) {
//           const defaultRole = activeRoles[0].RoleName;
//           setSelectedRole(defaultRole);
//           setCookie('selectedRole', defaultRole);
//         }
//       } else {
//         throw new Error(parsedData.message || 'Failed to fetch role data');
//       }
//     } catch (err) {
//       setError(err.message);
//     } finally {
//       setLoading(false);
//     }
//   }, []);

//   useEffect(() => {
//     isComponentMountedRef.current = true;
    
//     fetchRoleData();
//     startSessionMonitoring();
//     startInactivityMonitoring();
//     return () => {
//       isComponentMountedRef.current = false;
//       stopSessionMonitoring();
//     };
//   }, [fetchRoleData, startSessionMonitoring, startInactivityMonitoring, stopSessionMonitoring]);

//   const handleRoleSelect = async (roleName) => {
//     const isSessionValid = await checkSessionStatus(false, true);
    
//     if (!isSessionValid) {
//       return;
//     }
    
//     const previousRole = selectedRole;
    
//     setSelectedRole(roleName);
//     setCookie('selectedRole', roleName);
//     setCookie('userRole', roleName, 7);
    
//     const userDataCookie = getCookie('userData');
//     if (userDataCookie) {
//       try {
//         const userData = JSON.parse(userDataCookie);
//         userData.role = roleName;
//         setCookie('userData', JSON.stringify(userData), 7);
//       } catch (e) {
//       }
//     }
    
//     if (sessionStorage.getItem('userRole')) {
//       sessionStorage.setItem('userRole', roleName);
//     }
//     if (localStorage.getItem('userRole')) {
//       localStorage.setItem('userRole', roleName);
//     }
    
//     handleClose2();
//     window.dispatchEvent(new CustomEvent('roleChanged', { 
//       detail: { newRole: roleName } 
//     }));
//     if (previousRole &amp;&amp; previousRole !== roleName) {
//       window.location.href = '/dashboard';
//     } else if (!previousRole) {
//       navigate('/dashboard');
//     }
//   };

//   const handleUserActivity = useCallback(async (event) => {
//     if (IMMEDIATE_LOGOUT_MODE) {
//       await checkSessionStatus(false, true);
//     }
//     sessionStorage.setItem('lastActivity', Date.now().toString());
//   }, [checkSessionStatus]);

//   useEffect(() => {
//     const events = [
//       'mousedown',
//       'mousemove',
//       'keypress',
//       'scroll',
//       'touchstart',
//       'click',
//       'focus',
//       'blur',
//       'keydown'
//     ];
//     const addEventListeners = () => {
//       events.forEach(event => {
//         document.addEventListener(event, handleUserActivity, { 
//           passive: true, 
//           capture: true 
//         });
//       });
//     };

//     const removeEventListeners = () => {
//       events.forEach(event => {
//         document.removeEventListener(event, handleUserActivity, { capture: true });
//       });
//     };

//     addEventListeners();
    
//     return () => {
//       removeEventListeners();
//       if (timeoutRef.current) {
//         clearTimeout(timeoutRef.current);
//       }
//     };
//   }, [handleUserActivity]);

//   const handleManualLogout = () => {
//     handleLogout(false);
//   };

//   const handleRefreshRoles = () => {
//     fetchRoleData();
//   };
  
//   const activeRoles = roleData?.Records?.filter(role => role.IsActive === "true") || [];

//   return (
//     &lt;Box>
//       &lt;IconButton
//         size="large"
//         aria-label="profile menu"
//         color="inherit"
//         aria-controls="msgs-menu"
//         aria-haspopup="true"
//         sx={{
//           ...(typeof anchorEl2 === 'object' &amp;&amp; {
//             color: '#ed553b',
//           }),
//         }}
//         onClick={handleClick2}
//       >
//         &lt;Avatar
//           src={ProfileImg}
//           alt={ProfileImg}
//           sx={{
//             width: 45,
//             height: 45,
//           }}
//         />
//       &lt;/IconButton>
//       &lt;Menu
//         id="msgs-menu"
//         anchorEl={anchorEl2}
//         keepMounted
//         open={Boolean(anchorEl2)}
//         onClose={handleClose2}
//         anchorOrigin={{ horizontal: 'right', vertical: 'bottom' }}
//         transformOrigin={{ horizontal: 'right', vertical: 'top' }}
//         sx={{
//           '&amp; .MuiMenu-paper': {
//             width: '300px',
//             maxHeight: '400px',
//             overflowY: 'auto'
//           },
//         }}
//       >
//         {/* Current Role Display */}
//         {selectedRole &amp;&amp; (
//           &lt;Box px={2} py={1}>
//             &lt;Typography variant="subtitle2" color="text.secondary">
//               Current Role:
//             &lt;/Typography>
//             &lt;Typography variant="body1" sx={{ fontWeight: 'bold' }}>
//               {selectedRole}
//             &lt;/Typography>
//           &lt;/Box>
//         )}

//         &lt;Divider />

//         {/* Role Information Section */}
//         &lt;Box px={2} py={1}>
//           {error &amp;&amp; (
//             &lt;Alert severity="error" sx={{ mb: 1, fontSize: '0.75rem' }}>
//               {error}
//             &lt;/Alert>
//           )}
          
//           {loading &amp;&amp; !roleData &amp;&amp; (
//             &lt;Box display='flex' justifyContent='center' py={2}>
//               &lt;CircularProgress size={20} />
//             &lt;/Box>
//           )}
          
//           {activeRoles.length > 0 &amp;&amp; (
//             &lt;Box>
//               &lt;Typography variant='caption' color='textSecondary' sx={{ mb: 1, display: 'block' }}>
//                 {activeRoles.length} active role{activeRoles.length !== 1 ? 's' : ''} available
//               &lt;/Typography>
//               {activeRoles.map((role, index) => (
//                 &lt;MenuItem 
//                   key={index} 
//                   onClick={() => handleRoleSelect(role.RoleName)}
//                   selected={role.RoleName === selectedRole}
//                   sx={{ 
//                     mb: 1, 
//                     borderRadius: 1,
//                     bgcolor: role.RoleName === selectedRole ? '#ed553b' : 'background.paper',
//                     '&amp;:hover': {
//                       bgcolor: role.RoleName === selectedRole ? '#f8c6b0' : 'action.hover'
//                     }
//                   }}
//                 >
//                   &lt;ListItemText
//                     primary={role.RoleName}
//                     primaryTypographyProps={{
//                       fontWeight: role.RoleName === selectedRole ? 'bold' : 'normal',
//                       color: role.RoleName === selectedRole ? '#ed553b' : 'text.primary'
//                     }}
//                     secondaryTypographyProps={{
//                       fontSize: '0.7rem',
//                       color: 'success.main'
//                     }}
//                   />
//                 &lt;/MenuItem>
//               ))}
//             &lt;/Box>
//           )}

//           {/* Show message when no active roles are available */}
//           {roleData &amp;&amp; activeRoles.length === 0 &amp;&amp; (
//             &lt;Box py={2} textAlign="center">
//               &lt;Typography variant="body2" color="text.secondary">
//                 No active roles available
//               &lt;/Typography>
//             &lt;/Box>
//           )}
//         &lt;/Box>

//         &lt;Divider />

//         &lt;Box mt={1} py={1} px={2}>
//           &lt;Button 
//             variant="contained" 
//             color="primary" 
//             fullWidth
//             onClick={handleManualLogout}
//             sx={{
//               backgroundColor: '#ed553b',
//               '&amp;:hover': {
//                 backgroundColor: '#ed553b'
//               }
//             }}
//           >
//             Logout
//           &lt;/Button>
//         &lt;/Box>
//       &lt;/Menu>
//     &lt;/Box>
//   );
// };

// export default Profile;



/**
 * @fileoverview Profile component for displaying and switching user roles with auto-logout on inactivity.
 * @module src/layouts/full/header/Profile
 * @author Rakshana
 * @date 16/07/2025
 * @since 1.0.0
 */

import React, { useState, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router';
import {
  Avatar,
  Box,
  Menu,
  Button,
  IconButton,
  MenuItem,
  ListItemText,
  Typography,
  Divider,
  CircularProgress,
  Alert
} from '@mui/material';

import ProfileImg from 'src/assets/images/profile/user-1.jpg';
import {
  decryptData,
  validateJsonData,
  isWebCryptoSupported,
} from 'src/components/Decryption/Decrypt';
import Cookies from 'js-cookie';
import { HostName } from "src/assets/host/Host";

const getAuthHeaders = async () => {
  const encryptedToken = Cookies.get('HRToken');
      
  return {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${encryptedToken}`,
  };
};

const Profile = () => {
  const [anchorEl2, setAnchorEl2] = useState(null);
  const [roleData, setRoleData] = useState(null);
  const [selectedRole, setSelectedRole] = useState(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const navigate = useNavigate();
  const IMMEDIATE_LOGOUT_MODE = true; // Enabled for immediate checks on user interaction
  const SESSION_CHECK_INTERVAL = 30 * 1000; // Check session every 30 seconds
  const INACTIVITY_CHECK_INTERVAL = 5 * 1000; // Check inactivity every 5 seconds
  const INACTIVITY_TIMEOUT = 3600 * 1000; // Auto-logout after 1 minute of inactivity
  const RETRY_ATTEMPTS = 0; // No retries for faster logout
  const RETRY_DELAY = 1000; // Base delay (not used due to no retries)
  const MIN_CHECK_INTERVAL = 15 * 1000; // Minimum time between session checks
  
  const timeoutRef = React.useRef(null);
  const sessionCheckRef = React.useRef(null);
  const inactivityCheckRef = React.useRef(null);
  const retryCountRef = React.useRef(0);
  const isCheckingSessionRef = React.useRef(false);
  const isComponentMountedRef = React.useRef(true);
  const lastSuccessfulCheckRef = React.useRef(null);
  
  //const HostName = 'https://wftest1.iitm.ac.in:7000';
  const API_TOKEN = 'HRFGVJISOVp1fncC';

  const handleClick2 = (event) => {
    setAnchorEl2(event.currentTarget);
  };

  const handleClose2 = () => {
    setAnchorEl2(null);
  };

  const getCookie = (name) => {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  };

  const setCookie = (name, value, days = 1) => {
    const date = new Date();
    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
    const expires = `expires=${date.toUTCString()}`;
    document.cookie = `${name}=${value};${expires};path=/`;
  };

  const deleteCookie = (name) => {
    document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
  };
  
  const getLoginName = () => {
    const loginName = sessionStorage.getItem('username') || 
                     localStorage.getItem('username') || 
                     getCookie('username');
    return loginName;
  };

  const handleLogout = useCallback(async (isAutoLogout = false) => {
    try {
      stopSessionMonitoring();
      
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
        timeoutRef.current = null;
      }
      
      const sessionId = getCookie('session_id');
      const clearAllStorage = () => {
        deleteCookie('session_id');
        deleteCookie('selectedRole');
        deleteCookie('userRole');
        deleteCookie('userId');
        deleteCookie('EmpId');
        deleteCookie('username');
        deleteCookie('userData');
        deleteCookie('HRToken');
        deleteCookie('isAuthenticated');
        sessionStorage.clear();
        localStorage.removeItem('username');
        localStorage.removeItem('userRole');
      };

      if (!sessionId) {
        clearAllStorage();
        navigate('/auth/login', { replace: true });
        return;
      }
      // try {
      //   const headers = await getAuthHeaders();
      //   await fetch(`${HostName}/SessionTimeout`, {
      //     method: 'POST',
      //     headers: headers,
      //     body: JSON.stringify({
      //       token: API_TOKEN,
      //       session_id: sessionId,
      //       idletimeout: isAutoLogout ? 1 : 0
      //     }),
      //     signal: AbortSignal.timeout(2000)
      //   });
      // } catch (apiError) {
      // }
      // clearAllStorage();
      // if (isComponentMountedRef.current) {
      //   navigate('/auth/login', { replace: true });
      // } else {
      //   window.location.href = '/auth/login';
      // }
      
    } catch (error) {
      deleteCookie('session_id');
      deleteCookie('selectedRole');
      deleteCookie('userRole');
      deleteCookie('userId');
      deleteCookie('EmpId');
      deleteCookie('username');
      deleteCookie('userData');
      deleteCookie('HRToken');
      deleteCookie('isAuthenticated');
      sessionStorage.clear();
      localStorage.removeItem('username');
      localStorage.removeItem('userRole');
      
      if (isComponentMountedRef.current) {
        navigate('/auth/login', { replace: true });
      } else {
        window.location.href = '/auth/login';
      }
    }
    
    handleClose2();
  }, [navigate]);

  const checkSessionStatus = useCallback(async (isRetry = false, isUserInteraction = false) => {
    
    if (isCheckingSessionRef.current) {
      return true;
    }

    if (
      !isUserInteraction &amp;&amp;
      lastSuccessfulCheckRef.current &amp;&amp;
      Date.now() - lastSuccessfulCheckRef.current &lt; MIN_CHECK_INTERVAL
    ) {
      return true;
    }

    if (!isWebCryptoSupported()) {
      isCheckingSessionRef.current = false;
      await handleLogout(true);
      return false;
    }
    if (!isComponentMountedRef.current) {
      return false;
    }

    isCheckingSessionRef.current = true;

    try {
      const sessionId = getCookie('session_id');
      
      if (!sessionId) {
        isCheckingSessionRef.current = false;
        await handleLogout(true);
        return false;
      }

      const headers = await getAuthHeaders();
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 2000);

      const response = await fetch(`${HostName}/Sessiondata`, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
          token: API_TOKEN,
          Session_id: sessionId
        }),
        signal: controller.signal
      });

      clearTimeout(timeoutId);

      if (!response.ok) {
        throw new Error(`Session check failed with status: ${response.status}`);
      }

      const encryptedData = await response.json();
      
      if (!encryptedData.Data) {
        throw new Error('No encrypted session data received');
      }
      
      const decryptedData = await decryptData(encryptedData.Data);
      const parsedData = validateJsonData(decryptedData);
      
      if (parsedData.Status === 200 &amp;&amp; parsedData.Data) {
        const sessionData = parsedData.Data;
        if (!sessionData.Records || !Array.isArray(sessionData.Records) || sessionData.Records.length === 0) {
          isCheckingSessionRef.current = false;
          await handleLogout(true);
          return false;
        }
        const sessionRecord = sessionData.Records[0];
        if (!sessionRecord.hasOwnProperty('is_active')) {
          isCheckingSessionRef.current = false;
          await handleLogout(true);
          return false;
        }
        
        const isActive = sessionRecord.is_active;
        if (sessionRecord.created_at) {
          const sessionCreated = new Date(sessionRecord.created_at).getTime();
          const currentTime = Date.now();
          const SESSION_MAX_AGE = 24 * 60 * 60 * 1000; // 24 hours
          if (currentTime - sessionCreated > SESSION_MAX_AGE) {
            isCheckingSessionRef.current = false;
            await handleLogout(true);
            return false;
          }
        }

        if (isActive === 0 || isActive === "0" || isActive === false || isActive === "false") {
          isCheckingSessionRef.current = false;
          await handleLogout(true);
          return false;
        } else if (isActive === 1 || isActive === "1" || isActive === true || isActive === "true") {
          lastSuccessfulCheckRef.current = Date.now();
          retryCountRef.current = 0;
          isCheckingSessionRef.current = false;
          return true;
        } else if (isActive === null || isActive === undefined) {
          isCheckingSessionRef.current = false;
          await handleLogout(true);
          return false;
        } else {
          throw new Error(`Invalid session status: ${isActive} (type: ${typeof isActive})`);
        }
      } else {
        throw new Error(`Invalid session response structure - Status: ${parsedData.Status}`);
      }
    } catch (err) {
      isCheckingSessionRef.current = false;
      await handleLogout(true);
      return false;
    }
  }, [handleLogout]);

  const startSessionMonitoring = useCallback(() => {
    
    if (sessionCheckRef.current) {
      clearInterval(sessionCheckRef.current);
    }
    const immediateCheck = async () => {
      if (!isComponentMountedRef.current) {
        return;
      }
      await checkSessionStatus(false, false);
    };
    immediateCheck();
    const checkSession = async () => {
      if (!isComponentMountedRef.current) {
        return;
      }
      await checkSessionStatus();
    };
    sessionCheckRef.current = setInterval(checkSession, SESSION_CHECK_INTERVAL);
  }, [checkSessionStatus]);

  const startInactivityMonitoring = useCallback(() => {
    
    if (inactivityCheckRef.current) {
      clearInterval(inactivityCheckRef.current);
    }

    const checkInactivity = async () => {
      if (!isComponentMountedRef.current) {
        return;
      }

      const lastActivity = parseInt(sessionStorage.getItem('lastActivity') || '0', 10);
      const timeSinceLastActivity = Date.now() - lastActivity;

      if (timeSinceLastActivity >= INACTIVITY_TIMEOUT) {
        await handleLogout(true);
      }
    };

    inactivityCheckRef.current = setInterval(checkInactivity, INACTIVITY_CHECK_INTERVAL);
  }, [handleLogout]);

  const stopSessionMonitoring = useCallback(() => {
    if (sessionCheckRef.current) {
      clearInterval(sessionCheckRef.current);
      sessionCheckRef.current = null;
    }
    if (inactivityCheckRef.current) {
      clearInterval(inactivityCheckRef.current);
      inactivityCheckRef.current = null;
    }
    isCheckingSessionRef.current = false;
    retryCountRef.current = 0;
  }, []);
  
  const fetchRoleData = useCallback(async () => {
    if (!isWebCryptoSupported()) {
      setError('Web Crypto API not supported in this browser');
      return;
    }

    setLoading(true);
    setError(null);

    try {
      const loginName = getLoginName();
      
      const headers = await getAuthHeaders();
      const sessionId = Cookies.get("session_id");
      const response = await fetch(`${HostName}/Defaultrole`, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
          token: API_TOKEN,
          UserName: loginName,
          session_id: sessionId,
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const encryptedData = await response.json();
      
      if (!encryptedData.Data) {
        throw new Error('No encrypted data received from API');
      }
      
      const decryptedData = await decryptData(encryptedData.Data);
      const parsedData = validateJsonData(decryptedData);
      
      if (parsedData.Status === 200 &amp;&amp; parsedData.Data) {
        setRoleData(parsedData.Data);
        const savedRole = getCookie('selectedRole');
        
        // --- START: MODIFICATION FOR MOCK DATA STRUCTURE ---
        // Assuming all roles in Records are available/selectable as IsActive field is missing in mock data
        const allAvailableRoles = parsedData.Data.Records || []; 
        
        if (savedRole &amp;&amp; allAvailableRoles.some(role => role.RoleName === savedRole)) {
          setSelectedRole(savedRole);
        } else if (allAvailableRoles.length > 0) {
          const defaultRole = allAvailableRoles[0].RoleName;
          setSelectedRole(defaultRole);
          setCookie('selectedRole', defaultRole);
        }
        // --- END: MODIFICATION FOR MOCK DATA STRUCTURE ---
        
      } else {
        throw new Error(parsedData.message || 'Failed to fetch role data');
      }
    } catch (err) {
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    isComponentMountedRef.current = true;
    
    fetchRoleData();
    startSessionMonitoring();
    startInactivityMonitoring();
    return () => {
      isComponentMountedRef.current = false;
      stopSessionMonitoring();
    };
  }, [fetchRoleData, startSessionMonitoring, startInactivityMonitoring, stopSessionMonitoring]);

  const handleRoleSelect = async (roleName) => {
    const isSessionValid = await checkSessionStatus(false, true);
    
    if (!isSessionValid) {
      return;
    }
    
    const previousRole = selectedRole;
    
    setSelectedRole(roleName);
    setCookie('selectedRole', roleName);
    setCookie('userRole', roleName, 7);
    
    const userDataCookie = getCookie('userData');
    if (userDataCookie) {
      try {
        const userData = JSON.parse(userDataCookie);
        userData.role = roleName;
        setCookie('userData', JSON.stringify(userData), 7);
      } catch (e) {
      }
    }
    
    if (sessionStorage.getItem('userRole')) {
      sessionStorage.setItem('userRole', roleName);
    }
    if (localStorage.getItem('userRole')) {
      localStorage.setItem('userRole', roleName);
    }
    
    handleClose2();
    window.dispatchEvent(new CustomEvent('roleChanged', { 
      detail: { newRole: roleName } 
    }));
    if (previousRole &amp;&amp; previousRole !== roleName) {
      window.location.href = '/dashboard';
    } else if (!previousRole) {
      navigate('/dashboard');
    }
  };

  const handleUserActivity = useCallback(async (event) => {
    if (IMMEDIATE_LOGOUT_MODE) {
      await checkSessionStatus(false, true);
    }
    sessionStorage.setItem('lastActivity', Date.now().toString());
  }, [checkSessionStatus]);

  useEffect(() => {
    const events = [
      'mousedown',
      'mousemove',
      'keypress',
      'scroll',
      'touchstart',
      'click',
      'focus',
      'blur',
      'keydown'
    ];
    const addEventListeners = () => {
      events.forEach(event => {
        document.addEventListener(event, handleUserActivity, { 
          passive: true, 
          capture: true 
        });
      });
    };

    const removeEventListeners = () => {
      events.forEach(event => {
        document.removeEventListener(event, handleUserActivity, { capture: true });
      });
    };

    addEventListeners();
    
    return () => {
      removeEventListeners();
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, [handleUserActivity]);

  const handleManualLogout = () => {
    handleLogout(false);
  };

  const handleRefreshRoles = () => {
    fetchRoleData();
  };
  
  // Use all roles from Records as available roles based on the provided mock API structure
  const availableRoles = roleData?.Records || [];

  return (
    &lt;Box>
      &lt;IconButton
        size="large"
        aria-label="profile menu"
        color="inherit"
        aria-controls="msgs-menu"
        aria-haspopup="true"
        sx={{
          ...(typeof anchorEl2 === 'object' &amp;&amp; {
            color: '#ed553b',
          }),
        }}
        onClick={handleClick2}
      >
        &lt;Avatar
          src={ProfileImg}
          alt={ProfileImg}
          sx={{
            width: 45,
            height: 45,
          }}
        />
      &lt;/IconButton>
      &lt;Menu
        id="msgs-menu"
        anchorEl={anchorEl2}
        keepMounted
        open={Boolean(anchorEl2)}
        onClose={handleClose2}
        anchorOrigin={{ horizontal: 'right', vertical: 'bottom' }}
        transformOrigin={{ horizontal: 'right', vertical: 'top' }}
        sx={{
          '&amp; .MuiMenu-paper': {
            width: '300px',
            maxHeight: '400px',
            overflowY: 'auto'
          },
        }}
      >
        {/* Current Role Display */}
        {selectedRole &amp;&amp; (
          &lt;Box px={2} py={1}>
            &lt;Typography variant="subtitle2" color="text.secondary">
              Current Role:
            &lt;/Typography>
            &lt;Typography variant="body1" sx={{ fontWeight: 'bold' }}>
              {selectedRole}
            &lt;/Typography>
          &lt;/Box>
        )}

        &lt;Divider />

        {/* Role Information Section */}
        &lt;Box px={2} py={1}>
          {error &amp;&amp; (
            &lt;Alert severity="error" sx={{ mb: 1, fontSize: '0.75rem' }}>
              {error}
            &lt;/Alert>
          )}
          
          {loading &amp;&amp; !roleData &amp;&amp; (
            &lt;Box display='flex' justifyContent='center' py={2}>
              &lt;CircularProgress size={20} />
            &lt;/Box>
          )}
          
          {availableRoles.length > 0 &amp;&amp; (
            &lt;Box>
              &lt;Typography variant='caption' color='textSecondary' sx={{ mb: 1, display: 'block' }}>
                {availableRoles.length} role{availableRoles.length !== 1 ? 's' : ''} available
              &lt;/Typography>
              {availableRoles.map((role, index) => (
                &lt;MenuItem 
                  key={index} 
                  onClick={() => handleRoleSelect(role.RoleName)}
                  selected={role.RoleName === selectedRole}
                  sx={{ 
                    mb: 1, 
                    borderRadius: 1,
                    bgcolor: role.RoleName === selectedRole ? '#ed553b' : 'background.paper',
                    '&amp;:hover': {
                      bgcolor: role.RoleName === selectedRole ? '#f8c6b0' : 'action.hover'
                    }
                  }}
                >
                  &lt;ListItemText
                    primary={role.RoleName}
                    primaryTypographyProps={{
                      fontWeight: role.RoleName === selectedRole ? 'bold' : 'normal',
                      color: role.RoleName === selectedRole ? '#ed553b' : 'text.primary'
                    }}
                    // Removed secondaryTypographyProps as the mock data only provides RoleName
                  />
                &lt;/MenuItem>
              ))}
            &lt;/Box>
          )}

          {/* Show message when no active roles are available */}
          {roleData &amp;&amp; availableRoles.length === 0 &amp;&amp; (
            &lt;Box py={2} textAlign="center">
              &lt;Typography variant="body2" color="text.secondary">
                No roles available
              &lt;/Typography>
            &lt;/Box>
          )}
        &lt;/Box>

        &lt;Divider />

        &lt;Box mt={1} py={1} px={2}>
          &lt;Button 
            variant="contained" 
            color="primary" 
            fullWidth
            onClick={handleManualLogout}
            sx={{
              backgroundColor: '#ed553b',
              '&amp;:hover': {
                backgroundColor: '#ed553b'
              }
            }}
          >
            Logout
          &lt;/Button>
        &lt;/Box>
      &lt;/Menu>
    &lt;/Box>
  );
};

export default Profile;</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Wed Nov 05 2025 11:24:43 GMT+0530 (India Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
