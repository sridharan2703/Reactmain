<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>views/Menus/OfficeOrder/OfficeOrderSaveandHold.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-AdditionalDetails.html">AdditionalDetails</a><ul class='methods'><li data-type='method'><a href="module-AdditionalDetails.html#~AdditionalDetails">AdditionalDetails</a></li><li data-type='method'><a href="module-AdditionalDetails.html#~AdditionalDetails">AdditionalDetails</a></li></ul></li><li></li><li><a href="module-ApprovalForm.html">ApprovalForm</a><ul class='methods'><li data-type='method'><a href="module-ApprovalForm.html#~ApprovalForm">ApprovalForm</a></li><li data-type='method'><a href="module-ApprovalForm.html#~ApprovalForm">ApprovalForm</a></li></ul></li><li></li><li><a href="module-EmployeeVisitForm.html">EmployeeVisitForm</a><ul class='methods'><li data-type='method'><a href="module-EmployeeVisitForm.html#~EmployeeVisitForm">EmployeeVisitForm</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~EmployeeVisitForm">EmployeeVisitForm</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~stripNonEnglish">stripNonEnglish</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~stripNonEnglish">stripNonEnglish</a></li></ul></li><li></li><li><a href="module-SaveandHold.html">SaveandHold</a><ul class='methods'><li data-type='method'><a href="module-SaveandHold.html#~SaveandHold">SaveandHold</a></li><li data-type='method'><a href="module-SaveandHold.html#~SaveandHold">SaveandHold</a></li><li data-type='method'><a href="module-SaveandHold.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-SaveandHold.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-SaveandHold.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-SaveandHold.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-SaveandHold.html#~getToColumnHtml">getToColumnHtml</a></li><li data-type='method'><a href="module-SaveandHold.html#~getToColumnHtml">getToColumnHtml</a></li></ul></li><li></li><li><a href="module-components_Roadmap.html">components/Roadmap</a><ul class='methods'><li data-type='method'><a href="module-components_Roadmap.html#~Roadmap">Roadmap</a></li></ul></li><li><a href="module-src_components_UIShowcase.html">src/components/UIShowcase</a><ul class='methods'><li data-type='method'><a href="module-src_components_UIShowcase.html#~UIShowcase">UIShowcase</a></li></ul></li><li><a href="module-src_components_authentication_OtpVerification.html">src/components/authentication/OtpVerification</a><ul class='methods'><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~addTrustedDevice">addTrustedDevice</a></li><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~generateDeviceFingerprint">generateDeviceFingerprint</a></li><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~getDeviceInfo">getDeviceInfo</a></li><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~removeTrustedDevice">removeTrustedDevice</a></li></ul></li><li><a href="module-src_components_ui.html">src/components/ui</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui.html#~AnimatedSlide">AnimatedSlide</a></li><li data-type='method'><a href="module-src_components_ui.html#~CardStyle">CardStyle</a></li></ul></li><li></li><li></li><li></li><li><a href="module-src_components_ui_Alerts.html">src/components/ui/Alerts</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Alerts.html#~Alerts">Alerts</a></li></ul></li><li><a href="module-src_components_ui_Avatar.html">src/components/ui/Avatar</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Avatar.html#~Avatar">Avatar</a></li></ul></li><li><a href="module-src_components_ui_Badge.html">src/components/ui/Badge</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Badge.html#~Badge">Badge</a></li></ul></li><li><a href="module-src_components_ui_Button.html">src/components/ui/Button</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Button.html#~Button">Button</a></li><li data-type='method'><a href="module-src_components_ui_Button.html#~ButtonGroup">ButtonGroup</a></li><li data-type='method'><a href="module-src_components_ui_Button.html#~NavigationContainer">NavigationContainer</a></li></ul></li><li><a href="module-src_components_ui_Card.html">src/components/ui/Card</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Card.html#~Card">Card</a></li></ul></li><li><a href="module-src_components_ui_Checkbox.html">src/components/ui/Checkbox</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Checkbox.html#~Checkbox">Checkbox</a></li></ul></li><li><a href="module-src_components_ui_DialogBox.html">src/components/ui/DialogBox</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_DialogBox.html#~DialogBox">DialogBox</a></li></ul></li><li><a href="module-src_components_ui_Dropdown.html">src/components/ui/Dropdown</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Dropdown.html#~Dropdown">Dropdown</a></li></ul></li><li><a href="module-src_components_ui_Input.html">src/components/ui/Input</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Input.html#~Input">Input</a></li></ul></li><li><a href="module-src_components_ui_Pagination.html">src/components/ui/Pagination</a></li><li><a href="module-src_components_ui_PriorityIcon.html">src/components/ui/PriorityIcon</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_PriorityIcon.html#~PriorityIcon">PriorityIcon</a></li></ul></li><li><a href="module-src_components_ui_TextArea.html">src/components/ui/TextArea</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_TextArea.html#~TextArea">TextArea</a></li></ul></li><li><a href="module-src_layouts_full_header_Profile.html">src/layouts/full/header/Profile</a></li><li><a href="module-src_pages_Inbox_Inbox.html">src/pages/Inbox/Inbox</a></li><li><a href="module-src_services_EnhancedDynamicDecryption.html">src/services/EnhancedDynamicDecryption</a><ul class='methods'><li data-type='method'><a href="module-src_services_EnhancedDynamicDecryption.html#~base64ToArrayBuffer">base64ToArrayBuffer</a></li><li data-type='method'><a href="module-src_services_EnhancedDynamicDecryption.html#~getAuthHeaders">getAuthHeaders</a></li></ul></li><li><a href="module-src_views_authentication_auth_AuthLogin.html">src/views/authentication/auth/AuthLogin</a></li><li><a href="module-src_views_authentication_auth_encryption.html">src/views/authentication/auth/encryption</a><ul class='methods'><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.authenticateUser">authenticateUser</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.decryptGCM">decryptGCM</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.encryptECB">encryptECB</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.getDecryptKeyFromCookies">getDecryptKeyFromCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.getSessionIdFromCookies">getSessionIdFromCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.getUserFromCookies">getUserFromCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.isUserAuthenticated">isUserAuthenticated</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.logoutUser">logoutUser</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~deleteCookie">deleteCookie</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~generate256BitKey">generate256BitKey</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~getAuthHeaders">getAuthHeaders</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~getCookie">getCookie</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~insertSessionData">insertSessionData</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~saveUserToCookies">saveUserToCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~setCookie">setCookie</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#CommentsHistory">CommentsHistory</a></li><li><a href="global.html#DateInput">DateInput</a></li><li><a href="global.html#DatePicker">DatePicker</a></li><li><a href="global.html#DateRangePicker">DateRangePicker</a></li><li><a href="global.html#DocumentUpload">DocumentUpload</a></li><li><a href="global.html#DropZone">DropZone</a></li><li><a href="global.html#FileUpload">FileUpload</a></li><li><a href="global.html#ImageUpload">ImageUpload</a></li><li><a href="global.html#InlineDateRangePicker">InlineDateRangePicker</a></li><li><a href="global.html#Login2">Login2</a></li><li><a href="global.html#MultiFileUpload">MultiFileUpload</a></li><li><a href="global.html#TaskCard">TaskCard</a></li><li><a href="global.html#TaskSummaryPage">TaskSummaryPage</a></li><li><a href="global.html#base64ToArrayBuffer">base64ToArrayBuffer</a></li><li><a href="global.html#decrypt">decrypt</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">views/Menus/OfficeOrder/OfficeOrderSaveandHold.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// // import React, { useState, useEffect } from "react";
// // import Cookies from "js-cookie";
// // import TextField from "@mui/material/TextField";
// // import OfficeOrderPreview from "./OfficeOrderPreview.js";
// // import {
// //   decryptData,
// //   validateJsonData,
// // } from "src/components/Decryption/Decrypt";
// // import Alerts from "src/components/ui/Alerts.js";
// // import TextEdit from "./TextEdit";
// // import Swal from "sweetalert2";
// // import { HostName } from "src/assets/host/Host";
// // const signingAuthorityOptions = [
// //   { value: "AR", label: "Assistant Registrar" },
// //   { value: "Deputy Registrar", label: "Deputy Registrar" },
// //   { value: "Registrar", label: "Registrar" },
// // ];
// // const getToColumnHtml = (formData) => {
// //   const departmentLine = formData.department
// //     ? `&lt;br>Thro the Head, ${formData.department}`
// //     : "";
// //   return `&lt;p>&lt;strong>To&lt;/strong>&lt;br>${formData.facultyname} (ID No. ${formData.employeeid})${departmentLine}&lt;/p>&lt;p>&lt;strong>Sir,&lt;/strong>&lt;/p>`;
// // };

// // const SaveandHold = ({ onClose, record, onSuccess }) => {
// //   const [formData, setFormData] = useState({
// //     employeeid: "",
// //     facultyname: "",
// //     department: "",
// //     designation: "",
// //     visitfrom: "",
// //     visitto: "",
// //     natureofparticipation: "",
// //     country: "",
// //     city: "",
// //     claimType: "",
// //     signingauthority: "",
// //     toSection: [],
// //     remarks: "",
// //   });

// //   const [bodyData, setBodyData] = useState({
// //     referencenumber: "",
// //     subject: "",
// //     body: "",
// //     refsub: "",
// //     referenceDate: "",
// //     template: "",
// //     header: "",
// //     footer: "",
// //   });

// //   const [showPreview, setShowPreview] = useState(false);
// //   const [loading, setLoading] = useState(false);
// //   const [error, setError] = useState("");
// //   const [previewCoverPageNo, setPreviewCoverPageNo] = useState(null);
// //   const [selectedEmployeeId, setSelectedEmployeeId] = useState(null);
// //   const [isDraftSaved, setIsDraftSaved] = useState(false);

// //   const sessionId = Cookies.get("session_id");
// //   const jwtToken = Cookies.get("HRToken");
// //   const empId = Cookies.get("EmpId");
// //    const userRole = Cookies.get("selectedRole"); 

// //   const toSectionOptions = [
// //     `The Head of ${formData?.department || ""}`,
// //     "The Dean (Faculty)",
// //     "The Dean (Admin)",
// //     "The Dean (IC&amp;SR)",
// //     "The Dean (ACR)",
// //     "The Dean (GE)",
// //     "The Deputy Registrar (F&amp;A)",
// //     "Office copy",
// //     "AR (Paybill)",
// //     "AR (Bills)",
// //   ];
// //   const validateForm = () => {
// //     const requiredFields = {
// //       natureofparticipation: "Nature of Visit",
// //       visitfrom: "Visit From Date",
// //       visitto: "Visit To Date",
// //       country: "Country",
// //       city: "City/Town",
// //       subject: "Subject",
// //       refsub: "Reference (Ref)",
// //       body: "Body",
// //       signingauthority: "Signing Authority",
// //       toSection: "To Section",
// //       remarks: "Remarks",
// //     };

// //     const missingFields = [];

// //     for (const [key, label] of Object.entries(requiredFields)) {
// //       const value =
// //         formData[key] !== undefined
// //           ? formData[key]
// //           : bodyData[key] !== undefined
// //           ? bodyData[key]
// //           : "";

// //       if (
// //         value === "" ||
// //         value === null ||
// //         (Array.isArray(value) &amp;&amp; value.length === 0)
// //       ) {
// //         missingFields.push(label);
// //       }
// //     }

// //     if (missingFields.length > 0) {
// //       const message =
// //         missingFields.length === 1
// //           ? `${missingFields[0]} is required.`
// //           : `Please fill the following required fields: ${missingFields.join(
// //               ", "
// //             )}.`;
// //       setError(message);
// //       return false;
// //     }

// //     setError("");
// //     return true;
// //   };
// //   const formatDate = (dateValue) => {
// //     if (!dateValue) return "";
// //     const date = new Date(dateValue);
// //     return isNaN(date.getTime()) ? "" : date.toISOString().split("T")[0];
// //   };
// //   const formatDateTime = (dateValue) => {
// //     if (!dateValue) return null;
// //     const isStart = dateValue === formData.visitfrom;
// //     const time = isStart ? "09:00:00" : "17:00:00";
// //     return `${dateValue}T${time}+05:30`;
// //   };
// //   const fetchEmployeeDetails = async (coverpageno, employeeid) => {
// //     setLoading(true);
// //     setError("");
// //     try {
// //       if (!jwtToken) throw new Error("Authentication token missing.");
// //       if (!employeeid) throw new Error("Employee ID missing");

// //       const body = {
// //         employeeid,
// //         coverpageno,
// //         token: "HRFGVJISOVp1fncC",
// //         session_id: sessionId,
// //       };

// //       const response = await fetch(`${HostName}/OfficeOrder_taskvisitdetails`, {
// //         method: "POST",
// //         headers: {
// //           "Content-Type": "application/json",
// //           Authorization: `Bearer ${jwtToken}`,
// //         },
// //         body: JSON.stringify(body),
// //       });

// //       const encryptedData = await response.json();
// //       const encryptedPayload = encryptedData.Data ?? encryptedData.data;
// //       if (!encryptedPayload) throw new Error("Encrypted Data missing");

// //       const decryptedString = await decryptData(encryptedPayload);
// //       const parsedData = validateJsonData(decryptedString);

// //       const records = parsedData?.Records ?? parsedData?.Data?.Records ?? [];
// //       if (!records.length) throw new Error("No records found");

// //       const record = records[0];
// //       const rawCcList = record.cc_to || "";
// //       const ccSectionsArray = rawCcList
// //         ? rawCcList
// //             .split(",")
// //             .map((s) => s.trim())
// //             .filter((s) => s)
// //         : [];

// //       setFormData({
// //         employeeid: record?.employee_id || "",
// //         facultyname: record?.employee_name || "",
// //         department: record.department || "",
// //         designation: record.designation || "",
// //         visitfrom: formatDate(record.visit_from),
// //         visitto: formatDate(record.visit_to),
// //         natureofparticipation: record.nature_of_visit || "",
// //         country: record.country || "",
// //         city: record.city_town || "",
// //         claimType: record.claim_type || "",
// //         signingauthority: record.signing_authority || "",
// //         toSection: ccSectionsArray,
// //         remarks: record.remarks || "",
// //         leaveDetails: record.leaveDetails,
// //       });

// //       setBodyData({
// //         referencenumber: record.order_no || "",
// //         subject: record.subject || "",
// //         body: record.body_html || "",
// //         refsub: record.reference || "",
// //         referenceDate: formatDate(record.order_date),
// //         template: record.template_id || "",
// //         header: record.header_html || "",
// //         footer: record.footer_html || "",
// //       });

// //       setIsDraftSaved(true);
// //     } catch (err) {
// //       console.error("API Fetch Error:", err);
// //       setError(err.message || "Failed to fetch employee data");
// //     } finally {
// //       setLoading(false);
// //     }
// //   };

// //   useEffect(() => {
// //     if (record?.coverpageno &amp;&amp; record?.employeeid) {
// //       fetchEmployeeDetails(record.coverpageno, record.employeeid);
// //     }
// //   }, [record]);

// //   const handleChange = (e) => {
// //     const { name, value, type, checked } = e.target;

// //     if (type === "checkbox") {
// //       setFormData((prev) => {
// //         const current = Array.isArray(prev.toSection) ? prev.toSection : [];
// //         const updated = checked
// //           ? [...current, value]
// //           : current.filter((v) => v !== value);
// //         return { ...prev, toSection: updated };
// //       });
// //     } else if (
// //       ["referencenumber", "subject", "refsub", "referenceDate"].includes(name)
// //     ) {
// //       setBodyData((prev) => ({ ...prev, [name]: value }));
// //       setIsDraftSaved(false);
// //     } else {
// //       setFormData((prev) => ({ ...prev, [name]: value }));
// //       setIsDraftSaved(false);
// //     }
// //   };

// //   const handleUpdate = async () => {
// //     try {
// //       setLoading(true);
// //       setError("");

// //       const coverpageno = record?.coverpageno;

// //       if (!jwtToken) throw new Error("Authentication token missing.");
// //       if (!empId) throw new Error("Employee ID missing in cookies.");

// //       const payload = {
// //         token: "HRFGVJISOVp1fncC",
// //         employeeid: empId,
// //         coverpageno: coverpageno,
// //         Body: bodyData.body,
// //         Subject: bodyData.subject,
// //         Referencenumber: bodyData.referencenumber,
// //         session_id: sessionId,
// //       };

// //       const response = await fetch(`${HostName}/OfficeOrder_taskvisitdetails`, {
// //         method: "POST",
// //         headers: {
// //           "Content-Type": "application/json",
// //           Authorization: `Bearer ${jwtToken}`,
// //         },
// //         body: JSON.stringify(payload),
// //       });

// //       if (!response.ok) throw new Error("Failed to update Office Order");

// //       Swal.fire({
// //         title: "Updated!",
// //         text: "Changes have been Updated successfully.",
// //         icon: "success",
// //         timer: 2000,
// //         showConfirmButton: false,
// //       });

// //       setPreviewCoverPageNo(coverpageno);
// //       setShowPreview(false);
// //       setIsDraftSaved(true);
// //     } catch (err) {
// //       console.error("Update API Error:", err);
// //       setError(err.message || "Failed to update Office Order");
// //       Swal.fire({
// //         title: "Error",
// //         text: err.message || "Failed to update Office Order",
// //         icon: "error",
// //       });
// //     } finally {
// //       setLoading(false);
// //     }
// //   };

// //   const handleSave = async () => {
// //     try {
// //       setLoading(true);
// //       setError("");

// //       if (!jwtToken) throw new Error("Authentication token missing.");
// //       if (!empId) throw new Error("Employee ID missing in cookies.");
// //       const statusResponse = await fetch(
// //         "https://wftest1.iitm.ac.in:7000/Statusmasternew",
// //         {
// //           method: "POST",
// //           headers: {
// //             "Content-Type": "application/json",
// //             Authorization: `Bearer ${jwtToken}`,
// //           },
// //           body: JSON.stringify({
// //             statusdescription: "saveandhold",
// //             token: "HRFGVJISOVp1fncC",
// //             session_id: sessionId,
// //           }),
// //         }
// //       );

// //       if (!statusResponse.ok) throw new Error("Failed to fetch status");

// //       const encryptedStatus = await statusResponse.json();
// //       const decryptedString = await decryptData(
// //         encryptedStatus.Data ?? encryptedStatus.data
// //       );
// //       const validStatusData = validateJsonData(decryptedString);
// //       const taskStatusId = validStatusData?.Data?.Records?.[0]?.statusid ?? 8;
// //       const selectedAuthority = signingAuthorityOptions.find(
// //         (opt) => opt.value === formData.signingauthority
// //       );
// //       const signatureText = selectedAuthority
// //         ? selectedAuthority.label
// //         : formData.signingauthority;
// //       const reqpayload = {
// //         token: "HRFGVJISOVp1fncC",
// //         session_id: sessionId,
// //         typeofsubmit: "draft",
// //         p_cover_page_no: record?.coverpageno,
// //         p_employee_id: formData?.employeeid,
// //         p_employee_name: formData?.facultyname,
// //         p_department: formData?.department,
// //         p_designation: formData?.designation,
// //         p_visit_from: formatDateTime(formData.visitfrom),
// //         p_visit_to: formatDateTime(formData.visitto),
// //         p_duration:
// //           formData.visitfrom &amp;&amp; formData.visitto
// //             ? Math.ceil(
// //                 (new Date(formData.visitto) - new Date(formData.visitfrom)) /
// //                   (1000 * 60 * 60 * 24) +
// //                   1
// //               )
// //             : 0,
// //         p_nature_of_visit: formData?.natureofparticipation,
// //         p_claim_type: formData?.claimType || "",
// //         p_city_town: formData?.city,
// //         p_country: formData?.country,
// //         p_header_html: bodyData.header || "",
// //         p_order_no: bodyData.referencenumber || "",
// //         p_order_date: formatDate(bodyData.referenceDate),
// //         p_to_column: getToColumnHtml(formData),
// //         p_subject: bodyData.subject || "",
// //         p_reference: bodyData.refsub,
// //         p_body_html: bodyData.body,
// //         p_signature_html: `&lt;p>${signatureText}&lt;/p>`,
// //         p_cc_to: Array.isArray(formData.toSection)
// //           ? formData.toSection.join(",")
// //           : formData.toSection || "Office copy",
// //         p_footer_html: bodyData.footer || "",
// //         p_task_status_id: taskStatusId,
// //         p_initiated_by: empId || "admin",
// //         p_updated_by: empId || "admin",
// //         p_updated_on: new Date().toISOString(),
// //         p_process_id: 1,
// //         p_remarks: formData.remarks,
// //         p_email_flag: false,
// //         p_reject_flag: 0,
// //         p_assign_to: formData.employeeid || "",
// //         p_assigned_role: "initiator",
// //         p_activity_seq_no: 0,
// //         p_is_task_return: false,
// //         p_is_task_approved: false,
// //         p_user_role: userRole || "", // &lt;--- ADDED: User role from cookie

// //       };

// //       const response = await fetch(
// //         `${HostName}/OfficeOrder_InsertOfficedetails`,
// //         {
// //           method: "POST",
// //           headers: {
// //             "Content-Type": "application/json",
// //             Authorization: `Bearer ${jwtToken}`,
// //           },
// //           body: JSON.stringify(reqpayload),
// //         }
// //       );

// //       if (!response.ok)
// //         throw new Error(
// //           "Failed to save as draft (OfficeOrder_InsertOfficedetails)"
// //         );

// //       await Swal.fire({
// //         title: "Saved!",
// //         text: "The task has been saved successfully as a draft.",
// //         icon: "success",
// //         timer: 2000,
// //         showConfirmButton: false,
// //       });

// //       setIsDraftSaved(true);
// //       setPreviewCoverPageNo(record?.coverpageno);
// //       setSelectedEmployeeId(formData.employeeid);
// //     } catch (err) {
// //       console.error("Save as Draft API Error:", err);
// //       setError(err.message || "Failed to save as draft");
// //       Swal.fire({
// //         title: "Error",
// //         text: err.message || "Failed to save as draft",
// //         icon: "error",
// //       });
// //     } finally {
// //       setLoading(false);
// //     }
// //   };

// //   const handleDelete = async () => {
// //     const confirmResult = await Swal.fire({
// //       title: "Are you sure?",
// //       text: "Do you want to delete the task?",
// //       icon: "warning",
// //       showCancelButton: true,
// //       confirmButtonColor: "#ED553B",
// //       cancelButtonColor: "#6c757d",
// //       confirmButtonText: "Yes, Delete",
// //       cancelButtonText: "No, Cancel",
// //     });

// //     if (!confirmResult.isConfirmed) return;

// //     try {
// //       setLoading(true);
// //       setError("");

// //       if (!jwtToken) throw new Error("Authentication token missing.");

// //       const statusResponse = await fetch(
// //         "https://wftest1.iitm.ac.in:7000/Statusmasternew",
// //         {
// //           method: "POST",
// //           headers: {
// //             "Content-Type": "application/json",
// //             Authorization: `Bearer ${jwtToken}`,
// //           },
// //           body: JSON.stringify({
// //             statusdescription: "Deleted",
// //             token: "HRFGVJISOVp1fncC",
// //             session_id: sessionId,
// //           }),
// //         }
// //       );

// //       if (!statusResponse.ok) throw new Error("Failed to fetch status");

// //       const encryptedStatus = await statusResponse.json();
// //       const decryptedString = await decryptData(
// //         encryptedStatus.Data ?? encryptedStatus.data
// //       );
// //       const validStatusData = validateJsonData(decryptedString);
// //       const deletedStatusId =
// //         validStatusData?.Data?.Records?.[0]?.statusid ?? 8;

// //       const reqpayload = {
// //         token: "HRFGVJISOVp1fncC",
// //         session_id: sessionId,
// //         p_coverpageno: record.coverpageno,
// //         p_employeeid: record.employeeid,
// //         p_taskstatusid: String(deletedStatusId),
// //         p_updatedby: "DELETEBYUSER",
// //         p_updatedon: new Date().toISOString(),
// //       };

// //       const response = await fetch(`${HostName}/OfficeOrder_statusupdate`, {
// //         method: "POST",
// //         headers: {
// //           "Content-Type": "application/json",
// //           Authorization: `Bearer ${jwtToken}`,
// //         },
// //         body: JSON.stringify(reqpayload),
// //       });

// //       if (!response.ok) throw new Error("Failed to update Office Order");

// //       await Swal.fire({
// //         title: "Deleted!",
// //         text: "The task has been marked as deleted successfully.",
// //         icon: "success",
// //         timer: 2000,
// //         showConfirmButton: false,
// //       });
// //       onClose?.();
// //       if (onSuccess) {
// //         onSuccess();
// //       }
// //     } catch (err) {
// //       console.error("Delete API Error:", err);
// //       setError(err.message || "Failed to delete Office Order");
// //       Swal.fire({
// //         title: "Error",
// //         text: err.message || "Failed to delete Office Order",
// //         icon: "error",
// //       });
// //     } finally {
// //       setLoading(false);
// //     }
// //   };

// //   const handleSubmit = async (e) => {
// //     e.preventDefault(); // Prevent default browser form submission

// //     if (!validateForm()) return;
// //     try {
// //       setLoading(true);
// //       setError("");

// //       if (!jwtToken) throw new Error("Authentication token missing.");
// //       if (!empId) throw new Error("Employee ID missing in cookies.");
// //       const statusResponse = await fetch(
// //         "https://wftest1.iitm.ac.in:7000/Statusmasternew",
// //         {
// //           method: "POST",
// //           headers: {
// //             "Content-Type": "application/json",
// //             Authorization: `Bearer ${jwtToken}`,
// //           },
// //           body: JSON.stringify({
// //             statusdescription: "ongoing",
// //             token: "HRFGVJISOVp1fncC",
// //             session_id: sessionId,
// //           }),
// //         }
// //       );

// //       if (!statusResponse.ok)
// //         throw new Error("Failed to fetch status for 'ongoing'");

// //       const encryptedStatus = await statusResponse.json();
// //       const decryptedString = await decryptData(
// //         encryptedStatus.Data ?? encryptedStatus.data
// //       );
// //       const validStatusData = validateJsonData(decryptedString);
// //       const taskStatusId = validStatusData?.Data?.Records?.[0]?.statusid ?? 8;
// //       const selectedAuthority = signingAuthorityOptions.find(
// //         (opt) => opt.value === formData.signingauthority
// //       );
// //       const signatureText = selectedAuthority
// //         ? selectedAuthority.label
// //         : formData.signingauthority;
// //       const requestpayload = {
// //         token: "HRFGVJISOVp1fncC",
// //         session_id: sessionId,
// //         typeofsubmit: "Submit",
// //         p_cover_page_no: record?.coverpageno,
// //         p_employee_id: formData.employeeid,
// //         p_employee_name: formData.facultyname,
// //         p_department: formData.department,
// //         p_designation: formData.designation,
// //         p_visit_from: formatDateTime(formData.visitfrom),
// //         p_visit_to: formatDateTime(formData.visitto),
// //         p_duration:
// //           formData.visitfrom &amp;&amp; formData.visitto
// //             ? Math.ceil(
// //                 (new Date(formData.visitto) - new Date(formData.visitfrom)) /
// //                   (1000 * 60 * 60 * 24) +
// //                   1
// //               )
// //             : 0,
// //         p_nature_of_visit: formData.natureofparticipation,
// //         p_claim_type: formData.claimType || "",
// //         p_city_town: formData.city,
// //         p_country: formData.country,
// //         p_header_html: bodyData.header || "",
// //         p_order_no: bodyData.referencenumber || "",
// //         p_order_date: formatDate(bodyData.referenceDate),
// //         p_to_column: getToColumnHtml(formData),
// //         p_subject: bodyData.subject || "",
// //         p_reference: bodyData.refsub,
// //         p_body_html: bodyData.body,
// //         p_signature_html: `&lt;p>${signatureText}&lt;/p>`,
// //         p_cc_to: Array.isArray(formData.toSection)
// //           ? formData.toSection.join(",")
// //           : formData.toSection || "wf_admin@iitm.ac.in",
// //         p_footer_html: bodyData.footer,
// //         p_assign_to: "WF_Admin", // *** Placeholder based on example ***
// //         p_assigned_role: "initiator",
// //         p_task_status_id: taskStatusId,
// //         p_activity_seq_no: 1,
// //         p_is_task_return: false,
// //         p_is_task_approved: true,
// //         p_initiated_by: empId || "admin",
// //         p_initiated_on: new Date().toISOString().replace("Z", "+05:30"),
// //         p_updated_by: empId || "admin",
// //         p_updated_on: new Date().toISOString().replace("Z", "+05:30"),
// //         p_process_id: 1,
// //         p_remarks: formData.remarks,
// //         p_email_flag: false,
// //         p_reject_flag: 0,
// //         p_user_role: userRole || "", // &lt;--- ADDED: User role from cookie

// //       };

// //       const response = await fetch(
// //         `${HostName}/OfficeOrder_InsertOfficedetails`,
// //         {
// //           method: "POST",
// //           headers: {
// //             "Content-Type": "application/json",
// //             Authorization: `Bearer ${jwtToken}`,
// //           },
// //           body: JSON.stringify(requestpayload),
// //         }
// //       );

// //       if (!response.ok)
// //         throw new Error("Failed to insert Office Order (Submit)");

// //       await Swal.fire({
// //         title: "Submitted!",
// //         text: "The task has been Submitted Successfully.",
// //         icon: "success",
// //         timer: 2000,
// //         showConfirmButton: false,
// //       });
// //       onClose?.();

// //       if (onSuccess) {
// //         onSuccess();
// //       }
// //     } catch (err) {
// //       console.error("Insert API Error:", err);
// //       setError(err.message || "Failed to insert Office Order");
// //       Swal.fire({
// //         title: "Error",
// //         text: err.message || "Failed to insert Office Order",
// //         icon: "error",
// //       });
// //     } finally {
// //       setLoading(false);
// //     }
// //   };

// //   const removeTimestamp = (text) => {
// //     if (!text) return "";
// //     return text.replace(/(\d{4}-\d{2}-\d{2})T\d{2}:\d{2}:\d{2}.*?/g, "$1");
// //   };

// //   const handlePreview = async () => {
// //     if (!isDraftSaved) {
// //       setError("Please save the current changes as a draft first to preview.");
// //       return;
// //     }

// //     try {
// //       setLoading(true);
// //       setError("");

// //       if (!jwtToken) throw new Error("Authentication token missing.");
// //       if (!empId) throw new Error("Employee ID missing in cookies.");

// //       const previewpayload = {
// //         employeeid: formData.employeeid,
// //         coverpageno: record?.coverpageno,
// //         templatetype: "draft",
// //         status: "saveandhold",
// //       };

// //       const response = await fetch(
// //         `https://wftest1.iitm.ac.in:8080/api/officeorder/pdf`,
// //         {
// //           method: "POST",
// //           headers: {
// //             "Content-Type": "application/json",
// //             Authorization: `Bearer ${jwtToken}`,
// //           },
// //           body: JSON.stringify(previewpayload),
// //         }
// //       );

// //       if (!response.ok)
// //         throw new Error("Preview generation failed via new API");

// //       setPreviewCoverPageNo(record?.coverpageno);
// //       setSelectedEmployeeId(record?.employeeid);
// //       setShowPreview(true);
// //     } catch (err) {
// //       console.error("New Preview API Error:", err);
// //       setError(err.message || "Error generating preview");
// //       Swal.fire({
// //         title: "Error",
// //         text: err.message || "Error generating preview",
// //         icon: "error",
// //       });
// //     } finally {
// //       setLoading(false);
// //     }
// //   };

// //   const handleClosePreview = () => setShowPreview(false);
// //   const handleBack = () => onClose?.();

// //   if (loading) return &lt;div style={loadingStyle}>Loading employee data...&lt;/div>;
// //   if (showPreview)
// //     return (
// //       &lt;OfficeOrderPreview
// //         coverpageno={previewCoverPageNo}
// //         formData={formData}
// //         bodyData={bodyData}
// //         onBack={handleClosePreview}
// //         employeeid={selectedEmployeeId}
// //       />
// //     );
// //   return (
// //     &lt;div style={containerStyle}>
// //       &lt;div style={cardStyle}>
// //         &lt;button onClick={handleBack} style={backButtonStyle}>
// //           â† Back
// //         &lt;/button>
// //         &lt;h2 style={headingStyle}>Permission Cum Relief&lt;/h2>
// //         {error &amp;&amp; &lt;Alerts type="error" variant="outlined" message={error} />}

// //         &lt;form onSubmit={handleSubmit}>
// //           {/* Employee Info */}
// //           &lt;div
// //             style={{
// //               marginBottom: "30px",
// //               padding: "20px",
// //               border: "1px solid #e5e7eb",
// //               borderRadius: "10px",
// //             }}
// //           >
// //             &lt;h3
// //               style={{
// //                 marginBottom: "16px",
// //                 fontSize: "18px",
// //                 fontWeight: "600",
// //                 color: "#374151",
// //               }}
// //             >
// //               Employee Information
// //             &lt;/h3>

// //             &lt;div style={gridRowStyle}>
// //               &lt;TextField
// //                 label="Employee ID"
// //                 name="employeeid"
// //                 value={formData.employeeid}
// //                 onChange={handleChange}
// //                 InputProps={{
// //                   readOnly: true,
// //                 }}
// //               />
// //               &lt;TextField
// //                 label="Employee Name"
// //                 name="facultyname"
// //                 value={formData.facultyname}
// //                 onChange={handleChange}
// //                 InputProps={{
// //                   readOnly: true,
// //                 }}
// //               />
// //               &lt;TextField
// //                 label="Department"
// //                 name="department"
// //                 value={formData.department}
// //                 onChange={handleChange}
// //                 InputProps={{
// //                   readOnly: true,
// //                 }}
// //               />
// //               &lt;TextField
// //                 label="Designation"
// //                 name="designation"
// //                 value={formData.designation}
// //                 onChange={handleChange}
// //                 InputProps={{
// //                   readOnly: true,
// //                 }}
// //               />
// //             &lt;/div>

// //             &lt;div style={gridRowStyle}>
// //               &lt;TextField
// //                 label="Nature of Visit"
// //                 name="natureofparticipation"
// //                 value={formData.natureofparticipation}
// //                 onChange={handleChange}
// //               />
// //               &lt;TextField
// //                 type="date"
// //                 label="Visit From"
// //                 name="visitfrom"
// //                 value={formData.visitfrom}
// //                 onChange={handleChange}
// //                 InputLabelProps={{ shrink: true }}
// //               />
// //               &lt;TextField
// //                 type="date"
// //                 label="Visit To"
// //                 name="visitto"
// //                 value={formData.visitto}
// //                 onChange={handleChange}
// //                 InputLabelProps={{ shrink: true }}
// //               />
// //               &lt;TextField
// //                 label="Country"
// //                 name="country"
// //                 value={formData.country}
// //                 onChange={handleChange}
// //               />
// //             &lt;/div>

// //             &lt;div style={{ width: "23%" }}>
// //               &lt;TextField
// //                 label="City/Town"
// //                 name="city"
// //                 value={formData.city}
// //                 onChange={handleChange}
// //               />
// //               &lt;div>&lt;/div>
// //             &lt;/div>
// //           &lt;/div>
// //           {/* Office Order Details */}
// //           &lt;div
// //             style={{
// //               marginBottom: "30px",
// //               padding: "20px",
// //               border: "1px solid #e5e7eb",
// //               borderRadius: "10px",
// //             }}
// //           >
// //             &lt;h3
// //               style={{
// //                 marginBottom: "16px",
// //                 fontSize: "18px",
// //                 fontWeight: "600",
// //                 color: "#374151",
// //               }}
// //             >
// //               Office Order Details
// //             &lt;/h3>
// //             &lt;div style={{ display: "flex", gap: "16px", flexWrap: "wrap" }}>
// //               &lt;div style={{ flex: 1, minWidth: "250px" }}>
// //                 &lt;TextField
// //                   label="Reference Number"
// //                   name="referencenumber"
// //                   value={bodyData.referencenumber}
// //                   onChange={handleChange}
// //                   InputProps={{
// //                     readOnly: true,
// //                   }}
// //                 />
// //               &lt;/div>

// //               &lt;div style={{ flex: 1, minWidth: "200px" }}>
// //                 &lt;TextField
// //                   type="date"
// //                   label="Date"
// //                   name="referenceDate"
// //                   value={bodyData.referenceDate || ""}
// //                   onChange={handleChange}
// //                   InputLabelProps={{ shrink: true }}
// //                 />
// //               &lt;/div>
// //             &lt;/div>

// //             &lt;div style={{ ...gridRowTwoColumnStyles, width: "100%" }}>
// //               &lt;TextField
// //                 label="Subject"
// //                 name="subject"
// //                 value={bodyData.subject}
// //                 onChange={handleChange}
// //               />
// //               &lt;div style={{ marginBottom: "16px", width: "60%" }}>
// //                 &lt;label style={labelStyle}>Ref&lt;/label>
// //                 &lt;input
// //                   type="text"
// //                   name="refsub"
// //                   value={bodyData.refsub || ""}
// //                   onChange={handleChange}
// //                   style={inputStyle}
// //                 />
// //               &lt;/div>
// //             &lt;/div>

// //             &lt;div style={{ marginBottom: "16px" }}>
// //               &lt;label style={labelStyle}>Body&lt;/label>
// //               &lt;TextEdit
// //                 value={bodyData.body}
// //                 onChange={(value) =>
// //                   setBodyData((prev) => ({
// //                     ...prev,
// //                     body: removeTimestamp(value),
// //                   }))
// //                 }
// //               />
// //             &lt;/div>
// //             &lt;div style={{ width: "23%" }}>
// //               &lt;Select
// //                 label="Signing Authority"
// //                 name="signingauthority"
// //                 value={formData.signingauthority}
// //                 onChange={handleChange}
// //                 options={signingAuthorityOptions}
// //               />
// //               &lt;div>&lt;/div>
// //             &lt;/div>

// //             {/* TO Section */}
// //             &lt;div style={{ marginBottom: "16px" }}>
// //               &lt;label style={labelStyle}>TO Section&lt;/label>
// //               &lt;div style={checkboxGridStyle}>
// //                 {toSectionOptions.map((opt) => (
// //                   &lt;div key={opt} style={checkboxItemStyle}>
// //                     &lt;input
// //                       type="checkbox"
// //                       value={opt}
// //                       checked={formData.toSection.includes(opt)}
// //                       onChange={handleChange}
// //                       style={{ marginRight: "8px" }}
// //                     />
// //                     &lt;span style={{ fontSize: "14px" }}>{opt}&lt;/span>
// //                   &lt;/div>
// //                 ))}
// //               &lt;/div>
// //             &lt;/div>

// //             &lt;div style={gridRowTwoColumnStyle}>
// //               &lt;TextField
// //                 label="Remarks"
// //                 name="remarks"
// //                 value={formData.remarks}
// //                 onChange={handleChange}
// //               />
// //             &lt;/div>
// //           &lt;/div>

// //           {/* Buttons */}
// //           &lt;div style={{ display: "flex", gap: "12px", marginTop: "20px" }}>
// //             &lt;button
// //               type="button"
// //               onClick={handleSave}
// //               style={{ ...buttonStyle, backgroundColor: "#6B21A8" }}
// //             >
// //               Save as Draft
// //             &lt;/button>

// //             &lt;button
// //               type="submit"
// //               style={{ ...buttonStyle, backgroundColor: "#10B981" }} // Green for Submit
// //             >
// //               Submit
// //             &lt;/button>
// //             &lt;button
// //               type="button"
// //               onClick={handlePreview}
// //               style={{
// //                 ...buttonStyle,
// //                 backgroundColor: isDraftSaved ? "#D97706" : "#9ca3af",
// //                 cursor: isDraftSaved ? "pointer" : "not-allowed",
// //               }}
// //               disabled={!isDraftSaved}
// //             >
// //               Preview
// //             &lt;/button>

// //             &lt;button
// //               type="button"
// //               onClick={handleDelete}
// //               style={{ ...buttonStyle, backgroundColor: "#EF4444" }}
// //             >
// //               Delete
// //             &lt;/button>
// //           &lt;/div>
// //         &lt;/form>
// //       &lt;/div>
// //     &lt;/div>
// //   );
// // };

// // /* ---------- REUSABLE COMPONENTS (Copied for completeness) ---------- */
// // const Select = ({ label, options, ...props }) => {
// //   const key = `${props.name}-${props.value}`;
// //   return (
// //     &lt;div>
// //       &lt;label style={labelStyle}>{label}&lt;/label>
// //       &lt;select key={key} {...props} style={inputStyle} onChange={props.onChange}>
// //         &lt;option value="">Select {label}&lt;/option>
// //         {options.map((opt) => (
// //           &lt;option key={opt.value} value={opt.value}>
// //             {opt.label}
// //           &lt;/option>
// //         ))}
// //       &lt;/select>
// //     &lt;/div>
// //   );
// // };

// // /* ---------- STYLES (Copied for completeness) ---------- */
// // const containerStyle = {
// //   width: "100%",
// //   minHeight: "100vh",
// //   display: "flex",
// //   justifyContent: "center",
// //   alignItems: "flex-start",
// //   padding: "20px",
// // };
// // const cardStyle = {
// //   width: "100%",
// //   maxWidth: "1200px",
// //   padding: "32px",
// //   borderRadius: "12px",
// //   boxShadow: "0 8px 16px rgba(0,0,0,0.1)",
// //   backgroundColor: "#fff",
// //   marginTop: "20px",
// // };
// // const headingStyle = {
// //   marginBottom: "24px",
// //   color: "rgb(107, 114, 128)",
// //   fontSize: "24px",
// //   fontWeight: "600",
// // };
// // const labelStyle = {
// //   display: "block",
// //   marginBottom: "6px",
// //   fontWeight: "500",
// //   color: "#374151",
// // };
// // const inputStyle = {
// //   width: "100%",
// //   padding: "10px 12px",
// //   borderRadius: "8px",
// //   border: "1px solid #D1D5DB",
// //   fontSize: "14px",
// //   color: "#374151",
// // };
// // const buttonStyle = {
// //   padding: "10px 20px",
// //   border: "none",
// //   borderRadius: "8px",
// //   color: "#fff",
// //   cursor: "pointer",
// //   fontWeight: "600",
// // };
// // const backButtonStyle = {
// //   padding: "8px 16px",
// //   border: "none",
// //   borderRadius: "6px",
// //   backgroundColor: "rgb(37, 99, 235)",
// //   color: "#fff",
// //   cursor: "pointer",
// //   fontWeight: "600",
// //   marginBottom: "20px",
// // };
// // const gridRowStyle = {
// //   display: "grid",
// //   gridTemplateColumns: "repeat(4, 1fr)",
// //   gap: "16px",
// //   marginBottom: "16px",
// // };
// // const gridRowTwoColumnStyle = {
// //   display: "grid",
// //   gridTemplateColumns: "repeat(1, 1fr)",
// //   gap: "16px",
// //   marginBottom: "16px",
// // };

// // const gridRowTwoColumnStyles = {
// //   display: "grid",
// //   gridTemplateColumns: "repeat(2, 1fr)",
// //   gap: "16px",
// //   marginBottom: "16px",
// // };

// // const checkboxGridStyle = {
// //   display: "grid",
// //   gridTemplateColumns: "repeat(2, 1fr)",
// //   gap: "8px",
// //   marginTop: "8px",
// // };
// // const checkboxItemStyle = {
// //   display: "flex",
// //   alignItems: "center",
// //   marginBottom: "6px",
// // };
// // const loadingStyle = {
// //   display: "flex",
// //   justifyContent: "center",
// //   alignItems: "center",
// //   height: "100vh",
// //   fontSize: "18px",
// //   color: "#6B7280",
// // };

// // export default SaveandHold;



// // import React, { useState, useEffect } from "react";
// // import Cookies from "js-cookie";
// // import TextField from "@mui/material/TextField";
// // import OfficeOrderPreview from "./OfficeOrderPreview.js";
// // import {
// //   decryptData,
// //   validateJsonData,
// // } from "src/components/Decryption/Decrypt";
// // import Alerts from "src/components/ui/Alerts.js";
// // import TextEdit from "./TextEdit";
// // import Swal from "sweetalert2";
// // import { HostName } from "src/assets/host/Host";

// // // New custom style for full-width TextEdit container
// // const fullWidthInputStyle = {
// //   marginBottom: "16px",
// // };

// // const signingAuthorityOptions = [
// //   { value: "AR", label: "Assistant Registrar" },
// //   { value: "Deputy Registrar", label: "Deputy Registrar" },
// //   { value: "Registrar", label: "Registrar" },
// // ];
// // const getToColumnHtml = (formData) => {
// //   const departmentLine = formData.department
// //     ? `&lt;br>Thro the Head, ${formData.department}`
// //     : "";
// //   return `&lt;p>&lt;strong>To&lt;/strong>&lt;br>${formData.facultyname} (ID No. ${formData.employeeid})${departmentLine}&lt;/p>&lt;p>&lt;strong>Sir,&lt;/strong>&lt;/p>`;
// // };

// // const SaveandHold = ({ onClose, record, onSuccess }) => {
// //   const [formData, setFormData] = useState({
// //     employeeid: "",
// //     facultyname: "",
// //     department: "",
// //     designation: "",
// //     visitfrom: "",
// //     visitto: "",
// //     natureofparticipation: "",
// //     country: "",
// //     city: "",
// //     claimType: "",
// //     signingauthority: "",
// //     toSection: [],
// //     remarks: "",
// //   });

// //   const [bodyData, setBodyData] = useState({
// //     referencenumber: "",
// //     subject: "",
// //     body: "",
// //     refsub: "",
// //     referenceDate: "",
// //     template: "",
// //     header: "",
// //     footer: "",
// //   });

// //   const [showPreview, setShowPreview] = useState(false);
// //   const [loading, setLoading] = useState(false);
// //   const [error, setError] = useState("");
// //   const [previewCoverPageNo, setPreviewCoverPageNo] = useState(null);
// //   const [selectedEmployeeId, setSelectedEmployeeId] = useState(null);
// //   const [isDraftSaved, setIsDraftSaved] = useState(false);

// //   const sessionId = Cookies.get("session_id");
// //   const jwtToken = Cookies.get("HRToken");
// //   const empId = Cookies.get("EmpId");
// //    const userRole = Cookies.get("selectedRole"); 

// //   const toSectionOptions = [
// //     `The Head of ${formData?.department || ""}`,
// //     "The Dean (Faculty)",
// //     "The Dean (Admin)",
// //     "The Dean (IC&amp;SR)",
// //     "The Dean (ACR)",
// //     "The Dean (GE)",
// //     "The Deputy Registrar (F&amp;A)",
// //     "Office copy",
// //     "AR (Paybill)",
// //     "AR (Bills)",
// //   ];
// //   // const validateForm = () => {
// //   //   const requiredFields = {
// //   //     natureofparticipation: "Nature of Visit",
// //   //     visitfrom: "Visit From Date",
// //   //     visitto: "Visit To Date",
// //   //     country: "Country",
// //   //     city: "City/Town",
// //   //     subject: "Subject",
// //   //     refsub: "Reference (Ref)",
// //   //     body: "Body",
// //   //     signingauthority: "Signing Authority",
// //   //     toSection: "To Section",
// //   //     remarks: "Remarks",
// //   //   };

// //   //   const missingFields = [];

// //   //   for (const [key, label] of Object.entries(requiredFields)) {
// //   //     const value =
// //   //       formData[key] !== undefined
// //   //         ? formData[key]
// //   //         : bodyData[key] !== undefined
// //   //         ? bodyData[key]
// //   //         : "";

// //   //     if (
// //   //       value === "" ||
// //   //       value === null ||
// //   //       (Array.isArray(value) &amp;&amp; value.length === 0)
// //   //     ) {
// //   //       missingFields.push(label);
// //   //     }
// //   //   }

// //   //   if (missingFields.length > 0) {
// //   //     const message =
// //   //       missingFields.length === 1
// //   //         ? `${missingFields[0]} is required.`
// //   //         : `Please fill the following required fields: ${missingFields.join(
// //   //             ", "
// //   //           )}.`;
// //   //     setError(message);
// //   //     return false;
// //   //   }

// //   //   setError("");
// //   //   return true;
// //   // };
  

// //   const validateForm = (isDraft = false) => {
// //     const requiredFields = {
// //       natureofparticipation: "Nature of Visit",
// //       visitfrom: "Visit From Date",
// //       visitto: "Visit To Date",
// //       country: "Country",
// //       city: "City/Town",
// //       subject: "Subject",
// //       refsub: "Reference (Ref)",
// //       body: "Body",
// //       signingauthority: "Signing Authority",
// //       toSection: "To Section",
// //       remarks: "Remarks",
// //     };

// //     // For draft, only validate essential employee fields
// //     const draftRequiredFields = {
// //       natureofparticipation: "Nature of Visit",
// //       visitfrom: "Visit From Date",
// //       visitto: "Visit To Date",
// //       country: "Country",
// //       city: "City/Town",
// //     };

// //     const fieldsToValidate = isDraft ? draftRequiredFields : requiredFields;
// //     const missingFields = [];
// //     const validationErrors = [];

// //     for (const [key, label] of Object.entries(fieldsToValidate)) {
// //       const value =
// //         formData[key] !== undefined
// //           ? formData[key]
// //           : bodyData[key] !== undefined
// //           ? bodyData[key]
// //           : "";

// //       if (
// //         value === "" ||
// //         value === null ||
// //         (Array.isArray(value) &amp;&amp; value.length === 0)
// //       ) {
// //         missingFields.push(label);
// //       }
// //     }

// //     // Additional validations
// //     // 1. Date validations
// //     if (formData.visitfrom &amp;&amp; formData.visitto) {
// //       const fromDate = new Date(formData.visitfrom);
// //       const toDate = new Date(formData.visitto);
      
// //       if (toDate &lt; fromDate) {
// //         validationErrors.push("Visit To Date cannot be earlier than Visit From Date");
// //       }
// //     }

// //     // 2. Body content validation (for submit only)
// //     if (!isDraft &amp;&amp; bodyData.body) {
// //       const strippedBody = bodyData.body.replace(/&lt;[^>]*>/g, '').trim();
// //       if (strippedBody.length &lt; 10) {
// //         validationErrors.push("Body content must be at least 10 characters long");
// //       }
// //     }

// //     // 3. Subject validation (for submit only)
// //     if (!isDraft &amp;&amp; bodyData.subject) {
// //       if (bodyData.subject.trim().length &lt; 5) {
// //         validationErrors.push("Subject must be at least 5 characters long");
// //       }
// //     }

// //     // 4. Reference validation (for submit only)
// //     if (!isDraft &amp;&amp; bodyData.refsub) {
// //       if (bodyData.refsub.trim().length &lt; 3) {
// //         validationErrors.push("Reference must be at least 3 characters long");
// //       }
// //     }

// //     // Combine all errors
// //     const allErrors = [...missingFields, ...validationErrors];

// //     if (allErrors.length > 0) {
// //       const errorTitle = isDraft ? "Cannot Save Draft" : "Cannot Submit";
// //       const errorMessage = missingFields.length > 0
// //         ? `&lt;strong>Missing Required Fields:&lt;/strong>&lt;br/>â€¢ ${missingFields.join("&lt;br/>â€¢ ")}`
// //         : "";
// //       const validationMessage = validationErrors.length > 0
// //         ? `${errorMessage ? "&lt;br/>&lt;br/>" : ""}&lt;strong>Validation Errors:&lt;/strong>&lt;br/>â€¢ ${validationErrors.join("&lt;br/>â€¢ ")}`
// //         : "";

// //       Swal.fire({
// //         title: errorTitle,
// //         html: errorMessage + validationMessage,
// //         icon: "error",
// //         confirmButtonColor: "#EF4444",
// //         confirmButtonText: "OK",
// //       });
// //       return false;
// //     }

// //     setError("");
// //     return true;
// //   };
  
  
  
// //   const formatDate = (dateValue) => {
// //     if (!dateValue) return "";
// //     const date = new Date(dateValue);
// //     return isNaN(date.getTime()) ? "" : date.toISOString().split("T")[0];
// //   };
// //   const formatDateTime = (dateValue) => {
// //     if (!dateValue) return null;
// //     const isStart = dateValue === formData.visitfrom;
// //     const time = isStart ? "09:00:00" : "17:00:00";
// //     return `${dateValue}T${time}+05:30`;
// //   };
// //   const fetchEmployeeDetails = async (coverpageno, employeeid) => {
// //     setLoading(true);
// //     setError("");
// //     try {
// //       if (!jwtToken) throw new Error("Authentication token missing.");
// //       if (!employeeid) throw new Error("Employee ID missing");

// //       const body = {
// //         employeeid,
// //         coverpageno,
// //         token: "HRFGVJISOVp1fncC",
// //         session_id: sessionId,
// //       };

// //       const response = await fetch(`${HostName}/OfficeOrder_taskvisitdetails`, {
// //         method: "POST",
// //         headers: {
// //           "Content-Type": "application/json",
// //           Authorization: `Bearer ${jwtToken}`,
// //         },
// //         body: JSON.stringify(body),
// //       });

// //       const encryptedData = await response.json();
// //       const encryptedPayload = encryptedData.Data ?? encryptedData.data;
// //       if (!encryptedPayload) throw new Error("Encrypted Data missing");

// //       const decryptedString = await decryptData(encryptedPayload);
// //       const parsedData = validateJsonData(decryptedString);

// //       const records = parsedData?.Records ?? parsedData?.Data?.Records ?? [];
// //       if (!records.length) throw new Error("No records found");

// //       const record = records[0];
// //       const rawCcList = record.cc_to || "";
// //       const ccSectionsArray = rawCcList
// //         ? rawCcList
// //             .split(",")
// //             .map((s) => s.trim())
// //             .filter((s) => s)
// //         : [];

// //       // --- START: Logic to derive signingauthority value from signature_html ---
// //       let signingAuthorityValue = record.signing_authority || ""; // Fallback

// //       if (record.signature_html) {
// //           // Extract text inside the first &lt;p>...&lt;/p> tag (e.g., "&lt;p>Assistant Registrar&lt;/p>" -> "Assistant Registrar")
// //           const signatureTextMatch = record.signature_html.match(/&lt;p>(.*?)&lt;\/p>/i);
// //           const signatureLabel = signatureTextMatch ? signatureTextMatch[1].trim() : '';
          
// //           if (signatureLabel) {
// //               // Find the corresponding value from the predefined options
// //               const matchedOption = signingAuthorityOptions.find(
// //                   (opt) => opt.label.toLowerCase() === signatureLabel.toLowerCase()
// //               );
              
// //               // Use the value if matched, otherwise use the label as the value (for custom text)
// //               signingAuthorityValue = matchedOption ? matchedOption.value : signatureLabel;
// //           }
// //       }
// //       // --- END: Logic to derive signingauthority value from signature_html ---

// //       setFormData({
// //         employeeid: record?.employee_id || "",
// //         facultyname: record?.employee_name || "",
// //         department: record.department || "",
// //         designation: record.designation || "",
// //         visitfrom: formatDate(record.visit_from),
// //         visitto: formatDate(record.visit_to),
// //         natureofparticipation: record.nature_of_visit || "",
// //         country: record.country || "",
// //         city: record.city_town || "",
// //         claimType: record.claim_type || "",
// //         signingauthority: signingAuthorityValue, // Use the derived value
// //         toSection: ccSectionsArray,
// //         remarks: record.remarks || "",
// //         leaveDetails: record.leaveDetails,
// //       });

// //       setBodyData({
// //         referencenumber: record.order_no || "",
// //         subject: record.subject || "",
// //         body: record.body_html || "",
// //         refsub: record.reference || "",
// //         referenceDate: formatDate(record.order_date),
// //         template: record.template_id || "",
// //         header: record.header_html || "",
// //         footer: record.footer_html || "",
// //       });

// //       setIsDraftSaved(true);
// //     } catch (err) {
// //       console.error("API Fetch Error:", err);
// //       setError(err.message || "Failed to fetch employee data");
// //     } finally {
// //       setLoading(false);
// //     }
// //   };

// //   useEffect(() => {
// //     if (record?.coverpageno &amp;&amp; record?.employeeid) {
// //       fetchEmployeeDetails(record.coverpageno, record.employeeid);
// //     }
// //   }, [record]);

// //   const handleChange = (e) => {
// //     const { name, value, type, checked } = e.target;

// //     if (type === "checkbox") {
// //       setFormData((prev) => {
// //         const current = Array.isArray(prev.toSection) ? prev.toSection : [];
// //         const updated = checked
// //           ? [...current, value]
// //           : current.filter((v) => v !== value);
// //         return { ...prev, toSection: updated };
// //       });
// //     } else if (
// //       ["referencenumber", "subject", "refsub", "referenceDate"].includes(name)
// //     ) {
// //       setBodyData((prev) => ({ ...prev, [name]: value }));
// //       setIsDraftSaved(false);
// //     } else {
// //       setFormData((prev) => ({ ...prev, [name]: value }));
// //       setIsDraftSaved(false);
// //     }
// //   };

// //   const handleUpdate = async () => {
// //     try {
// //       setLoading(true);
// //       setError("");

// //       const coverpageno = record?.coverpageno;

// //       if (!jwtToken) throw new Error("Authentication token missing.");
// //       if (!empId) throw new Error("Employee ID missing in cookies.");

// //       const payload = {
// //         token: "HRFGVJISOVp1fncC",
// //         employeeid: empId,
// //         coverpageno: coverpageno,
// //         Body: bodyData.body,
// //         Subject: bodyData.subject,
// //         Referencenumber: bodyData.referencenumber,
// //         session_id: sessionId,
// //       };

// //       const response = await fetch(`${HostName}/OfficeOrder_taskvisitdetails`, {
// //         method: "POST",
// //         headers: {
// //           "Content-Type": "application/json",
// //           Authorization: `Bearer ${jwtToken}`,
// //         },
// //         body: JSON.stringify(payload),
// //       });

// //       if (!response.ok) throw new Error("Failed to update Office Order");

// //       Swal.fire({
// //         title: "Updated!",
// //         text: "Changes have been Updated successfully.",
// //         icon: "success",
// //         timer: 2000,
// //         showConfirmButton: false,
// //       });

// //       setPreviewCoverPageNo(coverpageno);
// //       setShowPreview(false);
// //       setIsDraftSaved(true);
// //     } catch (err) {
// //       console.error("Update API Error:", err);
// //       setError(err.message || "Failed to update Office Order");
// //       Swal.fire({
// //         title: "Error",
// //         text: err.message || "Failed to update Office Order",
// //         icon: "error",
// //       });
// //     } finally {
// //       setLoading(false);
// //     }
// //   };

// //   const handleSave = async () => {
// //     try {
// //       setLoading(true);
// //       setError("");

// //       if (!jwtToken) throw new Error("Authentication token missing.");
// //       if (!empId) throw new Error("Employee ID missing in cookies.");
// //       const statusResponse = await fetch(
// //         "https://wftest1.iitm.ac.in:7000/Statusmasternew",
// //         {
// //           method: "POST",
// //           headers: {
// //             "Content-Type": "application/json",
// //             Authorization: `Bearer ${jwtToken}`,
// //           },
// //           body: JSON.stringify({
// //             statusdescription: "saveandhold",
// //             token: "HRFGVJISOVp1fncC",
// //             session_id: sessionId,
// //           }),
// //         }
// //       );

// //       if (!statusResponse.ok) throw new Error("Failed to fetch status");

// //       const encryptedStatus = await statusResponse.json();
// //       const decryptedString = await decryptData(
// //         encryptedStatus.Data ?? encryptedStatus.data
// //       );
// //       const validStatusData = validateJsonData(decryptedString);
// //       const taskStatusId = validStatusData?.Data?.Records?.[0]?.statusid ?? 8;
// //       const selectedAuthority = signingAuthorityOptions.find(
// //         (opt) => opt.value === formData.signingauthority
// //       );
// //       const signatureText = selectedAuthority
// //         ? selectedAuthority.label
// //         : formData.signingauthority;
// //       const reqpayload = {
// //         token: "HRFGVJISOVp1fncC",
// //         session_id: sessionId,
// //         typeofsubmit: "draft",
// //         p_cover_page_no: record?.coverpageno,
// //         p_employee_id: formData?.employeeid,
// //         p_employee_name: formData?.facultyname,
// //         p_department: formData?.department,
// //         p_designation: formData?.designation,
// //         p_visit_from: formatDateTime(formData.visitfrom),
// //         p_visit_to: formatDateTime(formData.visitto),
// //         p_duration:
// //           formData.visitfrom &amp;&amp; formData.visitto
// //             ? Math.ceil(
// //                 (new Date(formData.visitto) - new Date(formData.visitfrom)) /
// //                   (1000 * 60 * 60 * 24) +
// //                   1
// //               )
// //             : 0,
// //         p_nature_of_visit: formData?.natureofparticipation,
// //         p_claim_type: formData?.claimType || "",
// //         p_city_town: formData?.city,
// //         p_country: formData?.country,
// //         p_header_html: bodyData.header || "",
// //         p_order_no: bodyData.referencenumber || "",
// //         p_order_date: formatDate(bodyData.referenceDate),
// //         p_to_column: getToColumnHtml(formData),
// //         p_subject: bodyData.subject || "",
// //         p_reference: bodyData.refsub,
// //         p_body_html: bodyData.body,
// //         p_signature_html: `&lt;p>${signatureText}&lt;/p>`,
// //         p_cc_to: Array.isArray(formData.toSection)
// //           ? formData.toSection.join(",")
// //           : formData.toSection || "Office copy",
// //         p_footer_html: bodyData.footer || "",
// //         p_task_status_id: taskStatusId,
// //         p_initiated_by: empId || "admin",
// //         p_updated_by: empId || "admin",
// //         p_updated_on: new Date().toISOString(),
// //         p_process_id: 1,
// //         p_remarks: formData.remarks,
// //         p_email_flag: false,
// //         p_reject_flag: 0,
// //         p_assign_to: formData.employeeid || "",
// //         p_assigned_role: "initiator",
// //         p_activity_seq_no: 0,
// //         p_is_task_return: false,
// //         p_is_task_approved: false,
// //         p_user_role: userRole || "", // &lt;--- ADDED: User role from cookie

// //       };

// //       const response = await fetch(
// //         `${HostName}/OfficeOrder_InsertOfficedetails`,
// //         {
// //           method: "POST",
// //           headers: {
// //             "Content-Type": "application/json",
// //             Authorization: `Bearer ${jwtToken}`,
// //           },
// //           body: JSON.stringify(reqpayload),
// //         }
// //       );

// //       if (!response.ok)
// //         throw new Error(
// //           "Failed to save as draft (OfficeOrder_InsertOfficedetails)"
// //         );

// //       await Swal.fire({
// //         title: "Saved!",
// //         text: "The task has been saved successfully as a draft.",
// //         icon: "success",
// //         timer: 2000,
// //         showConfirmButton: false,
// //       });

// //       setIsDraftSaved(true);
// //       setPreviewCoverPageNo(record?.coverpageno);
// //       setSelectedEmployeeId(formData.employeeid);
// //     } catch (err) {
// //       console.error("Save as Draft API Error:", err);
// //       setError(err.message || "Failed to save as draft");
// //       Swal.fire({
// //         title: "Error",
// //         text: err.message || "Failed to save as draft",
// //         icon: "error",
// //       });
// //     } finally {
// //       setLoading(false);
// //     }
// //   };

// //   const handleDelete = async () => {
// //     const confirmResult = await Swal.fire({
// //       title: "Are you sure?",
// //       text: "Do you want to delete the task?",
// //       icon: "warning",
// //       showCancelButton: true,
// //       confirmButtonColor: "#ED553B",
// //       cancelButtonColor: "#6c757d",
// //       confirmButtonText: "Yes, Delete",
// //       cancelButtonText: "No, Cancel",
// //     });

// //     if (!confirmResult.isConfirmed) return;

// //     try {
// //       setLoading(true);
// //       setError("");

// //       if (!jwtToken) throw new Error("Authentication token missing.");

// //       const statusResponse = await fetch(
// //         "https://wftest1.iitm.ac.in:7000/Statusmasternew",
// //         {
// //           method: "POST",
// //           headers: {
// //             "Content-Type": "application/json",
// //             Authorization: `Bearer ${jwtToken}`,
// //           },
// //           body: JSON.stringify({
// //             statusdescription: "Deleted",
// //             token: "HRFGVJISOVp1fncC",
// //             session_id: sessionId,
// //           }),
// //         }
// //       );

// //       if (!statusResponse.ok) throw new Error("Failed to fetch status");

// //       const encryptedStatus = await statusResponse.json();
// //       const decryptedString = await decryptData(
// //         encryptedStatus.Data ?? encryptedStatus.data
// //       );
// //       const validStatusData = validateJsonData(decryptedString);
// //       const deletedStatusId =
// //         validStatusData?.Data?.Records?.[0]?.statusid ?? 8;

// //       const reqpayload = {
// //         token: "HRFGVJISOVp1fncC",
// //         session_id: sessionId,
// //         p_coverpageno: record.coverpageno,
// //         p_employeeid: record.employeeid,
// //         p_taskstatusid: String(deletedStatusId),
// //         p_updatedby: "DELETEBYUSER",
// //         p_updatedon: new Date().toISOString(),
// //       };

// //       const response = await fetch(`${HostName}/OfficeOrder_statusupdate`, {
// //         method: "POST",
// //         headers: {
// //           "Content-Type": "application/json",
// //           Authorization: `Bearer ${jwtToken}`,
// //         },
// //         body: JSON.stringify(reqpayload),
// //       });

// //       if (!response.ok) throw new Error("Failed to update Office Order");

// //       await Swal.fire({
// //         title: "Deleted!",
// //         text: "The task has been marked as deleted successfully.",
// //         icon: "success",
// //         timer: 2000,
// //         showConfirmButton: false,
// //       });
// //       onClose?.();
// //       if (onSuccess) {
// //         onSuccess();
// //       }
// //     } catch (err) {
// //       console.error("Delete API Error:", err);
// //       setError(err.message || "Failed to delete Office Order");
// //       Swal.fire({
// //         title: "Error",
// //         text: err.message || "Failed to delete Office Order",
// //         icon: "error",
// //       });
// //     } finally {
// //       setLoading(false);
// //     }
// //   };

// //   const handleSubmit = async (e) => {
// //     e.preventDefault(); // Prevent default browser form submission

// //     if (!validateForm()) return;
// //     try {
// //       setLoading(true);
// //       setError("");

// //       if (!jwtToken) throw new Error("Authentication token missing.");
// //       if (!empId) throw new Error("Employee ID missing in cookies.");
// //       const statusResponse = await fetch(
// //         "https://wftest1.iitm.ac.in:7000/Statusmasternew",
// //         {
// //           method: "POST",
// //           headers: {
// //             "Content-Type": "application/json",
// //             Authorization: `Bearer ${jwtToken}`,
// //           },
// //           body: JSON.stringify({
// //             statusdescription: "ongoing",
// //             token: "HRFGVJISOVp1fncC",
// //             session_id: sessionId,
// //           }),
// //         }
// //       );

// //       if (!statusResponse.ok)
// //         throw new Error("Failed to fetch status for 'ongoing'");

// //       const encryptedStatus = await statusResponse.json();
// //       const decryptedString = await decryptData(
// //         encryptedStatus.Data ?? encryptedStatus.data
// //       );
// //       const validStatusData = validateJsonData(decryptedString);
// //       const taskStatusId = validStatusData?.Data?.Records?.[0]?.statusid ?? 8;
// //       const selectedAuthority = signingAuthorityOptions.find(
// //         (opt) => opt.value === formData.signingauthority
// //       );
// //       const signatureText = selectedAuthority
// //         ? selectedAuthority.label
// //         : formData.signingauthority;
// //       const requestpayload = {
// //         token: "HRFGVJISOVp1fncC",
// //         session_id: sessionId,
// //         typeofsubmit: "Submit",
// //         p_cover_page_no: record?.coverpageno,
// //         p_employee_id: formData.employeeid,
// //         p_employee_name: formData.facultyname,
// //         p_department: formData.department,
// //         p_designation: formData.designation,
// //         p_visit_from: formatDateTime(formData.visitfrom),
// //         p_visit_to: formatDateTime(formData.visitto),
// //         p_duration:
// //           formData.visitfrom &amp;&amp; formData.visitto
// //             ? Math.ceil(
// //                 (new Date(formData.visitto) - new Date(formData.visitfrom)) /
// //                   (1000 * 60 * 60 * 24) +
// //                   1
// //               )
// //             : 0,
// //         p_nature_of_visit: formData.natureofparticipation,
// //         p_claim_type: formData.claimType || "",
// //         p_city_town: formData.city,
// //         p_country: formData.country,
// //         p_header_html: bodyData.header || "",
// //         p_order_no: bodyData.referencenumber || "",
// //         p_order_date: formatDate(bodyData.referenceDate),
// //         p_to_column: getToColumnHtml(formData),
// //         p_subject: bodyData.subject || "",
// //         p_reference: bodyData.refsub,
// //         p_body_html: bodyData.body,
// //         p_signature_html: `&lt;p>${signatureText}&lt;/p>`,
// //         p_cc_to: Array.isArray(formData.toSection)
// //           ? formData.toSection.join(",")
// //           : formData.toSection || "wf_admin@iitm.ac.in",
// //         p_footer_html: bodyData.footer,
// //         p_assign_to: "WF_Admin", // *** Placeholder based on example ***
// //         p_assigned_role: "initiator",
// //         p_task_status_id: taskStatusId,
// //         p_activity_seq_no: 1,
// //         p_is_task_return: false,
// //         p_is_task_approved: true,
// //         p_initiated_by: empId || "admin",
// //         p_initiated_on: new Date().toISOString().replace("Z", "+05:30"),
// //         p_updated_by: empId || "admin",
// //         p_updated_on: new Date().toISOString().replace("Z", "+05:30"),
// //         p_process_id: 1,
// //         p_remarks: formData.remarks,
// //         p_email_flag: false,
// //         p_reject_flag: 0,
// //         p_user_role: userRole || "", // &lt;--- ADDED: User role from cookie

// //       };

// //       const response = await fetch(
// //         `${HostName}/OfficeOrder_InsertOfficedetails`,
// //         {
// //           method: "POST",
// //           headers: {
// //             "Content-Type": "application/json",
// //             Authorization: `Bearer ${jwtToken}`,
// //           },
// //           body: JSON.stringify(requestpayload),
// //         }
// //       );

// //       if (!response.ok)
// //         throw new Error("Failed to insert Office Order (Submit)");

// //       await Swal.fire({
// //         title: "Submitted!",
// //         text: "The task has been Submitted Successfully.",
// //         icon: "success",
// //         timer: 2000,
// //         showConfirmButton: false,
// //       });
// //       onClose?.();

// //       if (onSuccess) {
// //         onSuccess();
// //       }
// //     } catch (err) {
// //       console.error("Insert API Error:", err);
// //       setError(err.message || "Failed to insert Office Order");
// //       Swal.fire({
// //         title: "Error",
// //         text: err.message || "Failed to insert Office Order",
// //         icon: "error",
// //       });
// //     } finally {
// //       setLoading(false);
// //     }
// //   };

// //   const removeTimestamp = (text) => {
// //     if (!text) return "";
// //     return text.replace(/(\d{4}-\d{2}-\d{2})T\d{2}:\d{2}:\d{2}.*?/g, "$1");
// //   };

// //   const handlePreview = async () => {
// //     if (!isDraftSaved) {
// //       setError("Please save the current changes as a draft first to preview.");
// //       return;
// //     }

// //     try {
// //       setLoading(true);
// //       setError("");

// //       if (!jwtToken) throw new Error("Authentication token missing.");
// //       if (!empId) throw new Error("Employee ID missing in cookies.");

// //       const previewpayload = {
// //         employeeid: formData.employeeid,
// //         coverpageno: record?.coverpageno,
// //         templatetype: "draft",
// //         status: "saveandhold",
// //       };

// //       const response = await fetch(
// //         `https://wftest1.iitm.ac.in:8080/api/officeorder/pdf`,
// //         {
// //           method: "POST",
// //           headers: {
// //             "Content-Type": "application/json",
// //             Authorization: `Bearer ${jwtToken}`,
// //           },
// //           body: JSON.stringify(previewpayload),
// //         }
// //       );

// //       if (!response.ok)
// //         throw new Error("Preview generation failed via new API");

// //       setPreviewCoverPageNo(record?.coverpageno);
// //       setSelectedEmployeeId(record?.employeeid);
// //       setShowPreview(true);
// //     } catch (err) {
// //       console.error("New Preview API Error:", err);
// //       setError(err.message || "Error generating preview");
// //       Swal.fire({
// //         title: "Error",
// //         text: err.message || "Error generating preview",
// //         icon: "error",
// //       });
// //     } finally {
// //       setLoading(false);
// //     }
// //   };

// //   const handleClosePreview = () => setShowPreview(false);
// //   const handleBack = () => onClose?.();

// //   if (loading) return &lt;div style={loadingStyle}>Loading employee data...&lt;/div>;
// //   if (showPreview)
// //     return (
// //       &lt;OfficeOrderPreview
// //         coverpageno={previewCoverPageNo}
// //         formData={formData}
// //         bodyData={bodyData}
// //         onBack={handleClosePreview}
// //         employeeid={selectedEmployeeId}
// //       />
// //     );
// //   return (
// //     &lt;div style={containerStyle}>
// //       &lt;div style={cardStyle}>
// //         &lt;button onClick={handleBack} style={backButtonStyle}>
// //           â† Back
// //         &lt;/button>
// //         &lt;h2 style={headingStyle}>Permission Cum Relief&lt;/h2>
// //         {error &amp;&amp; &lt;Alerts type="error" variant="outlined" message={error} />}

// //         &lt;form onSubmit={handleSubmit}>
// //           {/* Employee Info */}
// //           &lt;div
// //             style={formSectionStyle}
// //           >
// //             &lt;h3 style={sectionHeadingStyle}>
// //               Employee Information
// //             &lt;/h3>

// //             {/* Row 1: Employee ID, Name, Dept, Desig */}
// //             &lt;div style={gridRowStyle}>
// //               &lt;TextField
// //                 label="Employee ID"
// //                 name="employeeid"
// //                 value={formData.employeeid}
// //                 onChange={handleChange}
// //                 InputProps={{
// //                   readOnly: true,
// //                 }}
// //                 variant="outlined"
// //                 fullWidth
// //               />
// //               &lt;TextField
// //                 label="Employee Name"
// //                 name="facultyname"
// //                 value={formData.facultyname}
// //                 onChange={handleChange}
// //                 InputProps={{
// //                   readOnly: true,
// //                 }}
// //                 variant="outlined"
// //                 fullWidth
// //               />
// //               &lt;TextField
// //                 label="Department"
// //                 name="department"
// //                 value={formData.department}
// //                 onChange={handleChange}
// //                 InputProps={{
// //                   readOnly: true,
// //                 }}
// //                 variant="outlined"
// //                 fullWidth
// //               />
// //               &lt;TextField
// //                 label="Designation"
// //                 name="designation"
// //                 value={formData.designation}
// //                 onChange={handleChange}
// //                 InputProps={{
// //                   readOnly: true,
// //                 }}
// //                 variant="outlined"
// //                 fullWidth
// //               />
// //             &lt;/div>

// //             {/* Row 2: Nature, Visit From, Visit To, Country */}
// //             &lt;div style={gridRowStyle}>
// //               &lt;TextField
// //                 label="Nature of Visit"
// //                 name="natureofparticipation"
// //                 value={formData.natureofparticipation}
// //                 onChange={handleChange}
// //                 variant="outlined"
// //                 fullWidth
// //               />
// //               &lt;TextField
// //                 type="date"
// //                 label="Visit From"
// //                 name="visitfrom"
// //                 value={formData.visitfrom}
// //                 onChange={handleChange}
// //                 InputLabelProps={{ shrink: true }}
// //                 variant="outlined"
// //                 fullWidth
// //               />
// //               &lt;TextField
// //                 type="date"
// //                 label="Visit To"
// //                 name="visitto"
// //                 value={formData.visitto}
// //                 onChange={handleChange}
// //                 InputLabelProps={{ shrink: true }}
// //                 variant="outlined"
// //                 fullWidth
// //               />
// //               &lt;TextField
// //                 label="Country"
// //                 name="country"
// //                 value={formData.country}
// //                 onChange={handleChange}
// //                 variant="outlined"
// //                 fullWidth
// //               />
// //             &lt;/div>

// //             {/* Row 3: City/Town (1 column) */}
// //             &lt;div style={gridRowStyle}>
// //               &lt;TextField
// //                 label="City/Town"
// //                 name="city"
// //                 value={formData.city}
// //                 onChange={handleChange}
// //                 variant="outlined"
// //                 fullWidth
// //               />
// //               &lt;div>&lt;/div> {/* Empty for alignment */}
// //               &lt;div>&lt;/div> {/* Empty for alignment */}
// //               &lt;div>&lt;/div> {/* Empty for alignment */}
// //             &lt;/div>
// //           &lt;/div>
          
// //           {/* Office Order Details */}
// //           &lt;div
// //             style={formSectionStyle}
// //           >
// //             &lt;h3 style={sectionHeadingStyle}>
// //               Office Order Details
// //             &lt;/h3>

// //             {/* Row 1: Reference Number, Date */}
// //             &lt;div style={gridRowTwoColumnStyles}>
// //               &lt;TextField
// //                 label="Reference Number"
// //                 name="referencenumber"
// //                 value={bodyData.referencenumber}
// //                 onChange={handleChange}
// //                 InputProps={{
// //                   readOnly: true,
// //                 }}
// //                 variant="outlined"
// //                 fullWidth
// //               />

// //               &lt;TextField
// //                 type="date"
// //                 label="Date"
// //                 name="referenceDate"
// //                 value={bodyData.referenceDate || ""}
// //                 onChange={handleChange}
// //                 InputLabelProps={{ shrink: true }}
// //                 variant="outlined"
// //                 fullWidth
// //               />
// //             &lt;/div>

// //             {/* Row 2: Subject, Ref */}
// //             &lt;div style={gridRowTwoColumnStyles}>
// //               &lt;TextField
// //                 label="Subject"
// //                 name="subject"
// //                 value={bodyData.subject}
// //                 onChange={handleChange}
// //                 variant="outlined"
// //                 fullWidth
// //               />
// //               {/* Replaced custom input with TextField for consistency */}
// //               &lt;TextField
// //                 label="Ref"
// //                 name="refsub"
// //                 value={bodyData.refsub || ""}
// //                 onChange={handleChange}
// //                 variant="outlined"
// //                 fullWidth
// //               />
// //             &lt;/div>

// //             {/* Body (Full width) */}
// //             &lt;div style={fullWidthInputStyle}>
// //               &lt;label style={labelStyle}>Body&lt;/label>
// //               &lt;TextEdit
// //                 value={bodyData.body}
// //                 onChange={(value) =>
// //                   setBodyData((prev) => ({
// //                     ...prev,
// //                     body: removeTimestamp(value),
// //                   }))
// //                 }
// //               />
// //             &lt;/div>

// //             {/* Row 3: Signing Authority, Empty */}
// //             &lt;div style={gridRowTwoColumnStyles}>
// //               &lt;Select
// //                 label="Signing Authority"
// //                 name="signingauthority"
// //                 value={formData.signingauthority}
// //                 onChange={handleChange}
// //                 options={signingAuthorityOptions}
// //                 fullWidth
// //               />
// //               &lt;div>&lt;/div> {/* Empty for alignment */}
// //             &lt;/div>

// //             {/* TO Section (Full width, checkbox grid) */}
// //             &lt;div style={fullWidthInputStyle}>
// //               &lt;label style={labelStyle}>TO Section&lt;/label>
// //               &lt;div style={checkboxGridStyle}>
// //                 {toSectionOptions.map((opt) => (
// //                   &lt;div key={opt} style={checkboxItemStyle}>
// //                     &lt;input
// //                       type="checkbox"
// //                       value={opt}
// //                       checked={formData.toSection.includes(opt)}
// //                       onChange={handleChange}
// //                       style={{ marginRight: "8px" }}
// //                     />
// //                     &lt;span style={{ fontSize: "14px" }}>{opt}&lt;/span>
// //                   &lt;/div>
// //                 ))}
// //               &lt;/div>
// //             &lt;/div>

// //             {/* Remarks (Full width, single column style) */}
// //             &lt;div style={fullWidthInputStyle}>
// //               &lt;TextField
// //                 label="Remarks"
// //                 name="remarks"
// //                 value={formData.remarks}
// //                 onChange={handleChange}
// //                 variant="outlined"
// //                 fullWidth
// //                 multiline
// //                 rows={2}
// //               />
// //             &lt;/div>
// //           &lt;/div>

// //           {/* Buttons (Right aligned) */}
// //           &lt;div style={buttonContainerStyle}>
// //             &lt;button
// //               type="button"
// //               onClick={handleSave}
// //               style={{ ...buttonStyle, backgroundColor: "#6B21A8" }}
// //             >
// //               Save as Draft
// //             &lt;/button>

// //             &lt;button
// //               type="submit"
// //               style={{ ...buttonStyle, backgroundColor: "#10B981" }} // Green for Submit
// //             >
// //               Submit
// //             &lt;/button>
// //             &lt;button
// //               type="button"
// //               onClick={handlePreview}
// //               style={{
// //                 ...buttonStyle,
// //                 backgroundColor: isDraftSaved ? "#D97706" : "#9ca3af",
// //                 cursor: isDraftSaved ? "pointer" : "not-allowed",
// //               }}
// //               disabled={!isDraftSaved}
// //             >
// //               Preview
// //             &lt;/button>

// //             &lt;button
// //               type="button"
// //               onClick={handleDelete}
// //               style={{ ...buttonStyle, backgroundColor: "#EF4444" }}
// //             >
// //               Delete
// //             &lt;/button>
// //           &lt;/div>
// //         &lt;/form>
// //       &lt;/div>
// //     &lt;/div>
// //   );
// // };

// // /* ---------- REUSABLE COMPONENTS (Modified for visual consistency) ---------- */
// // const Select = ({ label, options, fullWidth, ...props }) => {
// //   const key = `${props.name}-${props.value}`;
  
// //   // To visually align with TextField, we wrap the select inside a div 
// //   // that uses the inputStyle/TextField wrapper structure.
// //   return (
// //     &lt;div style={{ marginBottom: "16px" }}>
// //       &lt;label style={labelStyle}>{label}&lt;/label>
// //       &lt;select key={key} {...props} style={selectInputStyle} onChange={props.onChange}>
// //         &lt;option value="">Select {label}&lt;/option>
// //         {options.map((opt) => (
// //           &lt;option key={opt.value} value={opt.value}>
// //             {opt.label}
// //           &lt;/option>
// //         ))}
// //       &lt;/select>
// //     &lt;/div>
// //   );
// // };

// // /* ---------- STYLES (Refined and New) ---------- */
// // const containerStyle = {
// //   width: "100%",
// //   minHeight: "100vh",
// //   display: "flex",
// //   justifyContent: "center",
// //   alignItems: "flex-start",
// //   padding: "20px",
// //   backgroundColor: "#f9fafb", // Light background for professionalism
// // };
// // const cardStyle = {
// //   width: "100%",
// //   maxWidth: "1200px",
// //   padding: "32px",
// //   borderRadius: "12px",
// //   boxShadow: "0 4px 12px rgba(0,0,0,0.05)", // Softer shadow
// //   backgroundColor: "#fff",
// //   marginTop: "20px",
// // };
// // const headingStyle = {
// //   marginBottom: "24px",
// //   color: "#1f2937", // Darker text for elegance
// //   fontSize: "24px",
// //   fontWeight: "700",
// //   borderBottom: "2px solid #e5e7eb", // Subtle divider
// //   paddingBottom: "8px",
// // };
// // const sectionHeadingStyle = {
// //   marginBottom: "16px",
// //   fontSize: "18px",
// //   fontWeight: "600",
// //   color: "#4b5563",
// // };
// // const formSectionStyle = {
// //     marginBottom: "30px",
// //     padding: "20px",
// //     border: "1px solid #e5e7eb",
// //     borderRadius: "10px",
// //     backgroundColor: "#ffffff",
// // }
// // const labelStyle = {
// //   display: "block",
// //   marginBottom: "6px",
// //   fontWeight: "500",
// //   color: "#374151",
// //   fontSize: "14px",
// // };
// // const selectInputStyle = {
// //   width: "100%",
// //   padding: "10px 12px",
// //   borderRadius: "4px", // Matches MUI outlined
// //   border: "1px solid #D1D5DB",
// //   fontSize: "16px", // Standard font size
// //   color: "#374151",
// //   height: "56px", // Set height to match TextField default height
// //   backgroundColor: "#fff",
// //   boxSizing: "border-box",
// // };

// // const buttonStyle = {
// //   padding: "10px 20px",
// //   border: "none",
// //   borderRadius: "6px", // Slightly smaller border radius for modern look
// //   color: "#fff",
// //   cursor: "pointer",
// //   fontWeight: "600",
// //   transition: "background-color 0.2s",
// //   minWidth: "120px",
// // };
// // const backButtonStyle = {
// //   padding: "8px 16px",
// //   border: "none",
// //   borderRadius: "6px",
// //   backgroundColor: "#3b82f6", // Blue for primary action
// //   color: "#fff",
// //   cursor: "pointer",
// //   fontWeight: "600",
// //   marginBottom: "20px",
// //   fontSize: "14px",
// // };
// // const gridRowStyle = {
// //   display: "grid",
// //   gridTemplateColumns: "repeat(4, 1fr)",
// //   gap: "16px",
// //   marginBottom: "16px",
// // };

// // const gridRowTwoColumnStyles = {
// //   display: "grid",
// //   gridTemplateColumns: "repeat(2, 1fr)",
// //   gap: "16px",
// //   marginBottom: "16px",
// // };

// // const checkboxGridStyle = {
// //   display: "grid",
// //   gridTemplateColumns: "repeat(2, 1fr)",
// //   gap: "16px", // Increased gap
// //   marginTop: "8px",
// //   padding: "12px",
// //   border: "1px solid #e5e7eb", // Subtle border
// //   borderRadius: "4px",
// // };
// // const checkboxItemStyle = {
// //   display: "flex",
// //   alignItems: "center",
// // };
// // const loadingStyle = {
// //   display: "flex",
// //   justifyContent: "center",
// //   alignItems: "center",
// //   height: "100vh",
// //   fontSize: "18px",
// //   color: "#6B7280",
// // };

// // const buttonContainerStyle = {
// //   display: "flex",
// //   gap: "12px",
// //   marginTop: "30px", // Increased spacing
// //   justifyContent: "flex-end", // Aligned to the right
// // };

// // export default SaveandHold;

// import React, { useState, useEffect } from "react";
// import Cookies from "js-cookie";
// import TextField from "@mui/material/TextField";
// import OfficeOrderPreview from "./OfficeOrderPreview.js";
// import {
//   decryptData,
//   validateJsonData,
// } from "src/components/Decryption/Decrypt";
// import Alerts from "src/components/ui/Alerts.js";
// import TextEdit from "./TextEdit";
// import Swal from "sweetalert2";
// import { HostName } from "src/assets/host/Host";
// import DropdownWithCheckboxes from "src/components/ui/DropdownWithCheckBox";
// import Dropdown from "src/components/ui/Dropdown";
// import FormSection from "src/components/ui/TopColorCard.js";
// import { SaveButton, SubmitButton, FavoriteButton, BackButton, DeleteButton } from "src/components/ui/Button.js";


// const formatTimestamp = (dateStr, hour = "09:00:00") => {
//   if (!dateStr || !dateStr.trim()) return null;
//   const date = new Date(`${dateStr}T${hour}`);
//   const year = date.getFullYear();
//   const month = String(date.getMonth() + 1).padStart(2, "0");
//   const day = String(date.getDate()).padStart(2, "0");
//   return `${year}-${month}-${day}T${hour}+05:30`;
// };

// const calculateDuration = (from, to) => {
//   if (!from || !to) return 0;
//   const diff = new Date(to) - new Date(from);
//   return Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1;
// };

// const getToColumnHtml = (formData) => {
//   const { signingAuthority, department = "N/A Department", facultyname = "N/A Name", employeeid = "N/A" } = formData;
//   let toColumnValue = "";
//   if (signingAuthority) {
//     toColumnValue = `&lt;p>&lt;strong>To&lt;/strong>&lt;br>${facultyname} (ID No. ${employeeid})&lt;br>Thro the Head, ${department}&lt;/p>&lt;p>&lt;strong>Sir,&lt;/strong>&lt;/p>`;
//   }
//   return toColumnValue;
// };

// const SaveandHold = ({ onClose, record, onSuccess }) => {
//   const [formData, setFormData] = useState({
//     employeeid: "",
//     facultyname: "",
//     department: "",
//     designation: "",
//     visitfrom: "",
//     visitto: "",
//     natureofparticipation_value: "",
//     country: "",
//     city: "",
//     claimtype: "",
//     signingAuthority: "",
//     toSection: [],
//     remarks: "",
//   });

//   const [bodyData, setBodyData] = useState({
//     referenceNo: "",
//     referenceDate: "",
//     subject: "",
//     refsubject: "",
//     body: "",
//     header: "",
//     footer: "",
//     template: "",
//   });

//   const [showPreview, setShowPreview] = useState(false);
//   const [loading, setLoading] = useState(false);
//   const [error, setError] = useState("");
//   const [isSavedSuccessfully, setIsSavedSuccessfully] = useState(false);
//   const [previewData, setPreviewData] = useState(null);
//   const [previewCoverPageNo, setPreviewCoverPageNo] = useState(null);
//   const [selectedEmployeeId, setSelectedEmployeeId] = useState(null);

//   const sessionId = Cookies.get("session_id");
//   const empId = Cookies.get("EmpId");
//   const userRole = Cookies.get("selectedRole");
//   const jwtToken = Cookies.get("HRToken");

//   const toSectionOptions = [
//     `The Head of ${formData?.department || ""}`,
//     "The Dean (Faculty)",
//     "The Dean (Admin)",
//     "The Dean (IC&amp;SR)",
//     "The Dean (ACR)",
//     "The Dean (GE)",
//     "The Deputy Registrar (F&amp;A)",
//     "Office copy",
//     "AR (Paybill)",
//     "AR (Bills)",
//   ];

//   const signingOptions = [
//     { value: "Signing Authority", label: "Select Signing Authority" },
//     { value: "Deputy Registrar", label: "Deputy Registrar" },
//     { value: "Assistant Registrar", label: "Assistant Registrar" },
//     { value: "Registrar", label: "Registrar" },
//   ];

//   const signingValue = signingOptions.find(opt => opt.value === formData.signingAuthority) || signingOptions[0];

//   const handleSigningChange = (selectedOption) => {
//     setFormData(prev => ({ ...prev, signingAuthority: selectedOption.value }));
//     setIsSavedSuccessfully(false);
//   };

//   const formatDate = (dateValue) => {
//     if (!dateValue) return "";
//     const date = new Date(dateValue);
//     return isNaN(date.getTime()) ? "" : date.toISOString().split("T")[0];
//   };

//   const fetchEmployeeDetails = async (coverpageno, employeeid) => {
//     setLoading(true);
//     setError("");
//     try {
//       if (!jwtToken) throw new Error("Authentication token missing.");
//       if (!employeeid) throw new Error("Employee ID missing");

//       const body = {
//         employeeid,
//         coverpageno,
//         token: "HRFGVJISOVp1fncC",
//         session_id: sessionId,
//       };

//       const response = await fetch(`${HostName}/OfficeOrder_taskvisitdetails`, {
//         method: "POST",
//         headers: {
//           "Content-Type": "application/json",
//           Authorization: `Bearer ${jwtToken}`,
//         },
//         body: JSON.stringify(body),
//       });

//       const encryptedData = await response.json();
//       const encryptedPayload = encryptedData.Data ?? encryptedData.data;
//       if (!encryptedPayload) throw new Error("Encrypted Data missing");

//       const decryptedString = await decryptData(encryptedPayload);
//       const parsedData = validateJsonData(decryptedString);

//       const records = parsedData?.Records ?? parsedData?.Data?.Records ?? [];
//       if (!records.length) throw new Error("No records found");

//       const record = records[0];
//       const rawCcList = record.cc_to || "";
//       const ccSectionsArray = rawCcList
//         ? rawCcList
//             .split(",")
//             .map((s) => s.trim())
//             .filter((s) => s)
//         : [];

//       let signingAuthorityValue = record.signing_authority || "";

//       if (record.signature_html) {
//         const signatureTextMatch = record.signature_html.match(/&lt;p>(.*?)&lt;\/p>/i);
//         const signatureLabel = signatureTextMatch ? signatureTextMatch[1].trim() : '';
        
//         if (signatureLabel) {
//           const matchedOption = signingOptions.find(
//             (opt) => opt.label.toLowerCase() === signatureLabel.toLowerCase()
//           );
          
//           signingAuthorityValue = matchedOption ? matchedOption.value : signatureLabel;
//         }
//       }

//       setFormData({
//         employeeid: record?.employee_id || "",
//         facultyname: record?.employee_name || "",
//         department: record.department || "",
//         designation: record.designation || "",
//         visitfrom: formatDate(record.visit_from),
//         visitto: formatDate(record.visit_to),
//         natureofparticipation_value: record.nature_of_visit || "",
//         country: record.country || "",
//         city: record.city_town || "",
//         claimtype: record.claim_type || "",
//         signingAuthority: signingAuthorityValue,
//         toSection: ccSectionsArray,
//         remarks: record.remarks || "",
//       });

//       setBodyData({
//         referenceNo: record.order_no || "",
//         referenceDate: formatDate(record.order_date),
//         subject: record.subject || "",
//         refsubject: record.reference || "",
//         body: record.body_html || "",
//         header: record.header_html || "",
//         footer: record.footer_html || "",
//         template: record.template_id || "",
//       });

//       setIsSavedSuccessfully(true);
//     } catch (err) {
//       console.error("API Fetch Error:", err);
//       setError(err.message || "Failed to fetch employee data");
//     } finally {
//       setLoading(false);
//     }
//   };

//   useEffect(() => {
//     if (record?.coverpageno &amp;&amp; record?.employeeid) {
//       fetchEmployeeDetails(record.coverpageno, record.employeeid);
//     }
//   }, [record]);

//   const handleChange = (e) => {
//     const { name, value, type, checked } = e.target;
//     setIsSavedSuccessfully(false);

//     if (type === "checkbox") {
//       setFormData((prev) => {
//         const current = Array.isArray(prev.toSection) ? prev.toSection : [];
//         const updated = checked
//           ? [...current, value]
//           : current.filter((v) => v !== value);
//         return { ...prev, toSection: updated };
//       });
//     } else if (
//       [
//         "referenceNo",
//         "referenceDate",
//         "subject",
//         "refsubject",
//         "body",
//         "header",
//         "footer",
//         "template",
//       ].includes(name)
//     ) {
//       setBodyData((prev) => ({ ...prev, [name]: value }));
//     } else {
//       setFormData((prev) => ({ ...prev, [name]: value }));
//     }
//   };

//   const validateForm = (isDraft = false) => {
//     const missingFields = [];
//     const invalidFields = [];
//     const requiredFieldsForSubmit = {
//       natureofparticipation_value: "Nature of Visit",
//       visitfrom: "Visit From Date",
//       visitto: "Visit To Date",
//       country: "Country",
//       city: "City/Town",
//       subject: "Subject",
//       refsubject: "Reference (Ref)",
//       body: "Body",
//       signingAuthority: "Signing Authority",
//       toSection: "To Section",
//       remarks: "Remarks",
//     };
//     const requiredFieldsForDraft = {
//       natureofparticipation_value: "Nature of Visit",
//       visitfrom: "Visit From Date",
//       visitto: "Visit To Date",
//       country: "Country",
//       city: "City/Town",
//     };

//     const fieldsToValidate = isDraft ? requiredFieldsForDraft : requiredFieldsForSubmit;
//     for (const [key, label] of Object.entries(fieldsToValidate)) {
//       let value = formData.hasOwnProperty(key) ? formData[key] : bodyData[key];
//       if (
//         value === "" ||
//         value === null ||
//         value === undefined ||
//         (Array.isArray(value) &amp;&amp; value.length === 0) ||
//         (typeof value === "string" &amp;&amp; value.trim() === "")
//       ) {
//         missingFields.push(label);
//       }
//     }
//     if (formData.visitfrom &amp;&amp; formData.visitto) {
//       const fromDate = new Date(formData.visitfrom);
//       const toDate = new Date(formData.visitto);
      
//       if (fromDate > toDate) {
//         invalidFields.push("Visit To Date must be equal to or after Visit From Date");
//       }
//     }
//     if (!isDraft) {
//       if (bodyData.subject &amp;&amp; bodyData.subject.trim().length &lt; 10) {
//         invalidFields.push("Subject must be at least 10 characters long");
//       }
//       if (bodyData.body) {
//         const tempDiv = document.createElement("div");
//         tempDiv.innerHTML = bodyData.body;
//         const textContent = tempDiv.textContent || tempDiv.innerText || "";
//         if (textContent.trim().length &lt; 20) {
//           invalidFields.push("Body must contain at least 20 characters of text");
//         }
//       }
//       if (formData.country &amp;&amp; !/^[a-zA-Z\s]+$/.test(formData.country.trim())) {
//         invalidFields.push("Country must contain only alphabetic characters");
//       }
//       if (formData.city &amp;&amp; !/^[a-zA-Z\s,.-]+$/.test(formData.city.trim())) {
//         invalidFields.push("City/Town must contain only alphabetic characters and basic punctuation");
//       }
     
//     }
//     const errorMessages = [];
    
//     if (missingFields.length > 0) {
//       errorMessages.push(`Missing required fields: ${missingFields.join(", ")}`);
//     }

//     if (invalidFields.length > 0) {
//       errorMessages.push(...invalidFields);
//     }

//     if (errorMessages.length > 0) {
//       const message = errorMessages.join(". ");
//       setError(message);
      
//       Swal.fire({
//         title: "Validation Error",
//         html: errorMessages.map(msg => `â€¢ ${msg}`).join("&lt;br>"),
//         icon: "warning",
//       });
      
//       return false;
//     }

//     setError("");
//     return true;
//   };

//   const handleSave = async () => {
//     try {
//       setLoading(true);
//       setError("");

//       if (!jwtToken) throw new Error("Authentication token missing.");
//       if (!empId) throw new Error("Employee ID missing in cookies.");
//       const statusResponse = await fetch(
//         "https://wftest1.iitm.ac.in:7000/Statusmasternew",
//         {
//           method: "POST",
//           headers: {
//             "Content-Type": "application/json",
//             Authorization: `Bearer ${jwtToken}`,
//           },
//           body: JSON.stringify({
//             statusdescription: "saveandhold",
//             token: "HRFGVJISOVp1fncC",
//             session_id: sessionId,
//           }),
//         }
//       );

//       if (!statusResponse.ok) throw new Error("Failed to fetch status");

//       const encryptedStatus = await statusResponse.json();
//       const decryptedString = await decryptData(
//         encryptedStatus.Data ?? encryptedStatus.data
//       );
//       const validStatusData = validateJsonData(decryptedString);
//       const taskStatusId = validStatusData?.Data?.Records?.[0]?.statusid ?? 8;
//       const selectedOption = signingOptions.find(opt => opt.value === formData.signingAuthority);
//       const signatureText = selectedOption ? selectedOption.label : formData.signingAuthority || "Authority Not Specified";
//       const signatureHtml = `&lt;p>${signatureText}&lt;/p>`;
//       const toColumnValue = getToColumnHtml(formData);
//       const reqpayload = {
//         token: "HRFGVJISOVp1fncC",
//         session_id: sessionId,
//         typeofsubmit: "draft",
//         p_cover_page_no: record?.coverpageno || "",
//         p_employee_id: formData.employeeid,
//         p_employee_name: formData.facultyname,
//         p_department: formData.department,
//         p_designation: formData.designation,
//         p_visit_from: formatTimestamp(formData.visitfrom, "09:00:00"),
//         p_visit_to: formatTimestamp(formData.visitto, "17:00:00"),
//         p_duration: calculateDuration(formData.visitfrom, formData.visitto),
//         p_nature_of_visit: formData.natureofparticipation_value,
//         p_claim_type: formData.claimtype || "",
//         p_city_town: formData.city,
//         p_country: formData.country,
//         p_header_html: bodyData.header || "",
//         p_order_no: bodyData.referenceNo || "",
//         p_order_date: bodyData.referenceDate || new Date().toISOString().split("T")[0],
//         p_to_column: toColumnValue,
//         p_subject: bodyData.subject || "",
//         p_reference: bodyData.refsubject,
//         p_body_html: bodyData.body,
//         p_signature_html: signatureHtml,
//         p_cc_to: Array.isArray(formData.toSection)
//           ? formData.toSection.join(",")
//           : formData.toSection || "Office copy",
//         p_footer_html: bodyData.footer || "",
//         p_assign_to: formData.employeeid || "",
//         p_assigned_role: "initiator",
//         p_task_status_id: taskStatusId,
//         p_activity_seq_no: 0,
//         p_is_task_return: false,
//         p_is_task_approved: false,
//         p_initiated_by: empId || "admin",
//         p_initiated_on: new Date().toISOString().replace("Z", "+05:30"),
//         p_updated_by: empId || "admin",
//         p_updated_on: new Date().toISOString().replace("Z", "+05:30"),
//         p_process_id: 1,
//         p_remarks: formData.remarks,
//         p_email_flag: false,
//         p_reject_flag: 0,
//         p_user_role: userRole || "",
//       };

//       const response = await fetch(
//         `${HostName}/OfficeOrder_InsertOfficedetails`,
//         {
//           method: "POST",
//           headers: {
//             "Content-Type": "application/json",
//             Authorization: `Bearer ${jwtToken}`,
//           },
//           body: JSON.stringify(reqpayload),
//         }
//       );

//       if (!response.ok)
//         throw new Error(
//           "Failed to save as draft (OfficeOrder_InsertOfficedetails)"
//         );

//       await Swal.fire({
//         title: "Saved!",
//         text: "The task has been saved successfully as a draft.",
//         icon: "success",
//         timer: 2000,
//         showConfirmButton: false,
//       });

//       setIsSavedSuccessfully(true);
//       setPreviewCoverPageNo(record?.coverpageno);
//       setSelectedEmployeeId(formData.employeeid);
//     } catch (err) {
//       console.error("Save as Draft API Error:", err);
//       setError(err.message || "Failed to save as draft");
//       Swal.fire({
//         title: "Error",
//         text: err.message || "Failed to save as draft",
//         icon: "error",
//       });
//     } finally {
//       setLoading(false);
//     }
//   };

//   const handleDelete = async () => {
//     const confirmResult = await Swal.fire({
//       title: "Are you sure?",
//       text: "Do you want to delete the task?",
//       icon: "warning",
//       showCancelButton: true,
//       confirmButtonColor: "#ED553B",
//       cancelButtonColor: "#6c757d",
//       confirmButtonText: "Yes, Delete",
//       cancelButtonText: "No, Cancel",
//     });

//     if (!confirmResult.isConfirmed) return;

//     try {
//       setLoading(true);
//       setError("");

//       if (!jwtToken) throw new Error("Authentication token missing.");

//       const statusResponse = await fetch(
//         "https://wftest1.iitm.ac.in:7000/Statusmasternew",
//         {
//           method: "POST",
//           headers: {
//             "Content-Type": "application/json",
//             Authorization: `Bearer ${jwtToken}`,
//           },
//           body: JSON.stringify({
//             statusdescription: "Deleted",
//             token: "HRFGVJISOVp1fncC",
//             session_id: sessionId,
//           }),
//         }
//       );

//       if (!statusResponse.ok) throw new Error("Failed to fetch status");

//       const encryptedStatus = await statusResponse.json();
//       const decryptedString = await decryptData(
//         encryptedStatus.Data ?? encryptedStatus.data
//       );
//       const validStatusData = validateJsonData(decryptedString);
//       const deletedStatusId =
//         validStatusData?.Data?.Records?.[0]?.statusid ?? 8;

//       const reqpayload = {
//         token: "HRFGVJISOVp1fncC",
//         session_id: sessionId,
//         p_coverpageno: record.coverpageno,
//         p_employeeid: record.employeeid,
//         p_taskstatusid: String(deletedStatusId),
//         p_updatedby: "DELETEBYUSER",
//         p_updatedon: new Date().toISOString(),
//       };

//       const response = await fetch(`${HostName}/OfficeOrder_statusupdate`, {
//         method: "POST",
//         headers: {
//           "Content-Type": "application/json",
//           Authorization: `Bearer ${jwtToken}`,
//         },
//         body: JSON.stringify(reqpayload),
//       });

//       if (!response.ok) throw new Error("Failed to update Office Order");

//       await Swal.fire({
//         title: "Deleted!",
//         text: "The task has been marked as deleted successfully.",
//         icon: "success",
//         timer: 2000,
//         showConfirmButton: false,
//       });
//       onClose?.();
//       if (onSuccess) {
//         onSuccess();
//       }
//     } catch (err) {
//       console.error("Delete API Error:", err);
//       setError(err.message || "Failed to delete Office Order");
//       Swal.fire({
//         title: "Error",
//         text: err.message || "Failed to delete Office Order",
//         icon: "error",
//       });
//     } finally {
//       setLoading(false);
//     }
//   };

//   const handleSubmit = async (e) => {
//     if (e) e.preventDefault();
//     if (!validateForm()) return;
//     try {
//       setLoading(true);
//       setError("");

//       if (!jwtToken) throw new Error("Authentication token missing.");
//       if (!empId) throw new Error("Employee ID missing in cookies.");
//       const statusResponse = await fetch(
//         "https://wftest1.iitm.ac.in:7000/Statusmasternew",
//         {
//           method: "POST",
//           headers: {
//             "Content-Type": "application/json",
//             Authorization: `Bearer ${jwtToken}`,
//           },
//           body: JSON.stringify({
//             statusdescription: "ongoing",
//             token: "HRFGVJISOVp1fncC",
//             session_id: sessionId,
//           }),
//         }
//       );

//       if (!statusResponse.ok)
//         throw new Error("Failed to fetch status for 'ongoing'");

//       const encryptedStatus = await statusResponse.json();
//       const decryptedString = await decryptData(
//         encryptedStatus.Data ?? encryptedStatus.data
//       );
//       const validStatusData = validateJsonData(decryptedString);
//       const taskStatusId = validStatusData?.Data?.Records?.[0]?.statusid ?? 8;
//       const selectedOption = signingOptions.find(opt => opt.value === formData.signingAuthority);
//       const signatureText = selectedOption ? selectedOption.label : formData.signingAuthority || "Authority Not Specified";
//       const signatureHtml = `&lt;p>${signatureText}&lt;/p>`;
//       const toColumnValue = getToColumnHtml(formData);
//       const requestpayload = {
//         token: "HRFGVJISOVp1fncC",
//         session_id: sessionId,
//         typeofsubmit: "Submit",
//         p_cover_page_no: record?.coverpageno || "",
//         p_employee_id: formData.employeeid,
//         p_employee_name: formData.facultyname,
//         p_department: formData.department,
//         p_designation: formData.designation,
//         p_visit_from: formatTimestamp(formData.visitfrom, "09:00:00"),
//         p_visit_to: formatTimestamp(formData.visitto, "17:00:00"),
//         p_duration: calculateDuration(formData.visitfrom, formData.visitto),
//         p_nature_of_visit: formData.natureofparticipation_value,
//         p_claim_type: formData.claimtype || "",
//         p_city_town: formData.city,
//         p_country: formData.country,
//         p_header_html: bodyData.header || "",
//         p_order_no: bodyData.referenceNo || "",
//         p_order_date: bodyData.referenceDate || new Date().toISOString().split("T")[0],
//         p_to_column: toColumnValue,
//         p_subject: bodyData.subject || "",
//         p_reference: bodyData.refsubject,
//         p_body_html: bodyData.body,
//         p_signature_html: signatureHtml,
//         p_cc_to: Array.isArray(formData.toSection)
//           ? formData.toSection.join(",")
//           : formData.toSection || "wf_admin@iitm.ac.in",
//         p_footer_html: bodyData.footer || "",
//         p_assign_to: "WF_Admin",
//         p_assigned_role: "initiator",
//         p_task_status_id: taskStatusId,
//         p_activity_seq_no: 1,
//         p_is_task_return: false,
//         p_is_task_approved: true,
//         p_initiated_by: empId || "admin",
//         p_initiated_on: new Date().toISOString().replace("Z", "+05:30"),
//         p_updated_by: empId || "admin",
//         p_updated_on: new Date().toISOString().replace("Z", "+05:30"),
//         p_process_id: 1,
//         p_remarks: formData.remarks,
//         p_email_flag: false,
//         p_reject_flag: 0,
//         p_user_role: userRole || "",
//       };

//       const response = await fetch(
//         `${HostName}/OfficeOrder_InsertOfficedetails`,
//         {
//           method: "POST",
//           headers: {
//             "Content-Type": "application/json",
//             Authorization: `Bearer ${jwtToken}`,
//           },
//           body: JSON.stringify(requestpayload),
//         }
//       );

//       if (!response.ok)
//         throw new Error("Failed to insert Office Order (Submit)");

//       await Swal.fire({
//         title: "Submitted!",
//         text: "The task has been Submitted Successfully.",
//         icon: "success",
//         timer: 2000,
//         showConfirmButton: false,
//       });
//       onClose?.();

//       if (onSuccess) {
//         onSuccess();
//       }
//     } catch (err) {
//       console.error("Insert API Error:", err);
//       setError(err.message || "Failed to insert Office Order");
//       Swal.fire({
//         title: "Error",
//         text: err.message || "Failed to insert Office Order",
//         icon: "error",
//       });
//     } finally {
//       setLoading(false);
//     }
//   };

//   const handlePreview = async () => {
//     if (!isSavedSuccessfully) {
//       setError("Please save the draft or submit the form before previewing.");
//       Swal.fire({
//         title: "Action Required",
//         text: "Please save the current changes as a draft or submit the form before generating the preview PDF.",
//         icon: "info",
//       });
//       return;
//     }
    
//     if (
//       !record?.coverpageno ||
//       !formData.employeeid ||
//       !formData.signingAuthority
//     ) {
//       setError(
//         "Cannot generate preview: Missing Cover Page Number, Employee ID, or Signing Authority."
//       );
//       return;
//     }
    
//     setLoading(true);
//     setError("");

//     try {
//       if (!jwtToken) throw new Error("Authentication token missing.");
//       const pdfApiUrl = `https://wftest1.iitm.ac.in:8080/api/officeorder/pdf`;
      
//       const previewpayload = {
//         employeeid: formData.employeeid,
//         coverpageno: record.coverpageno,
//         templatetype: "draft",
//         status: "saveandhold",
//       };
      
//       const response = await fetch(pdfApiUrl, {
//         method: "POST",
//         headers: {
//           "Content-Type": "application/json",
//           Authorization: `Bearer ${jwtToken}`,
//         },
//         body: JSON.stringify(previewpayload),
//       });

//       if (!response.ok) {
//         const errorText = await response.text();
//         throw new Error(
//           `Failed to generate PDF. Server responded with: ${
//             errorText || response.statusText
//           }`
//         );
//       }

//       const pdfBlob = await response.blob();
//       const fileURL = URL.createObjectURL(pdfBlob);
      
//       setPreviewData({
//         pdfUrl: fileURL,
//         formData: formData,
//         bodyData: bodyData,
//       });
//       setPreviewCoverPageNo(record.coverpageno);
//       setSelectedEmployeeId(formData.employeeid);
      
//       setShowPreview(true);

//     } catch (err) {
//       console.error("Preview Generation Error:", err);
//       const errorMessage =
//         err.message ||
//         "An unexpected error occurred while generating the preview.";
//       setError(errorMessage);
//       Swal.fire({
//         title: "Preview Error",
//         text: errorMessage,
//         icon: "error",
//       });
//     } finally {
//       setLoading(false);
//     }
//   };

//   const handleClosePreview = () => {
//     setShowPreview(false);
//     if (previewData?.pdfUrl) {
//       URL.revokeObjectURL(previewData.pdfUrl);
//       setPreviewData(null);
//     }
//   };

//   const handleBack = () => onClose?.();

//   if (loading)
//     return &lt;div style={loadingStyle}>Loading employee data...&lt;/div>;

//   if (showPreview &amp;&amp; previewData?.pdfUrl) {
//     return (
//       &lt;OfficeOrderPreview
//         coverpageno={previewCoverPageNo}
//         employeeid={selectedEmployeeId}
//         pdfUrl={previewData.pdfUrl}
//         formData={previewData.formData}
//         bodyData={previewData.bodyData}
//         onBack={handleClosePreview}
//         isLocalPreview={false}
//         loading={loading}
//       />
//     );
//   }

//   return (
//     &lt;div style={cardStyle}>
//       &lt;BackButton onClick={handleBack} />
//       &lt;h2 style={headingStyle}>Permission Cum Relief&lt;/h2>
//       {error &amp;&amp; &lt;Alerts type="error" variant="outlined" message={error} />}

//       &lt;form onSubmit={handleSubmit}>
//         {/* Employee Info */}
//         &lt;FormSection>
//           &lt;h3 style={sectionHeadingStyle}>
//             Employee Information
//           &lt;/h3>

//           {/* Row 1: Employee ID, Name, Dept, Desig */}
//           &lt;div style={gridRowStyle}>
//             &lt;TextField
//               label="Employee ID"
//               name="employeeid"
//               value={formData.employeeid}
//               onChange={handleChange}
//               InputProps={{ readOnly: true }}
//               variant="outlined"
//               fullWidth
//             />
//             &lt;TextField
//               label="Employee Name"
//               name="facultyname"
//               value={formData.facultyname}
//               onChange={handleChange}
//               InputProps={{ readOnly: true }}
//               variant="outlined"
//               fullWidth
//             />
//             &lt;TextField
//               label="Department"
//               name="department"
//               value={formData.department}
//               onChange={handleChange}
//               InputProps={{ readOnly: true }}
//               variant="outlined"
//               fullWidth
//             />
//             &lt;TextField
//               label="Designation"
//               name="designation"
//               value={formData.designation}
//               onChange={handleChange}
//               InputProps={{ readOnly: true }}
//               variant="outlined"
//               fullWidth
//             />
//           &lt;/div>

//           {/* Row 2: Nature, Visit From, Visit To, Country */}
//           &lt;div style={gridRowStyle}>
//             &lt;TextField
//               label="Nature of Visit"
//               name="natureofparticipation_value"
//               value={formData.natureofparticipation_value}
//               onChange={handleChange}
//               variant="outlined"
//               fullWidth
//             />
//             &lt;TextField
//               type="date"
//               label="Visit From"
//               name="visitfrom"
//               value={formData.visitfrom}
//               onChange={handleChange}
//               InputLabelProps={{ shrink: true }}
//               variant="outlined"
//               fullWidth
//             />
//             &lt;TextField
//               type="date"
//               label="Visit To"
//               name="visitto"
//               value={formData.visitto}
//               onChange={handleChange}
//               InputLabelProps={{ shrink: true }}
//               variant="outlined"
//               fullWidth
//             />
//             &lt;TextField
//               label="Country"
//               name="country"
//               value={formData.country}
//               onChange={handleChange}
//               variant="outlined"
//               fullWidth
//             />
//           &lt;/div>

//           {/* Row 3: City/Town (1 column) */}
//           &lt;div style={gridRowStyle}>
//             &lt;TextField
//               label="City/Town"
//               name="city"
//               value={formData.city}
//               onChange={handleChange}
//               variant="outlined"
//               fullWidth
//             />
//             {/* Claim Type hidden field */}
//             &lt;TextField
//               label="Claim Type"
//               name="claimtype"
//               value={formData.claimtype}
//               onChange={handleChange}
//               InputProps={{ readOnly: true }}
//               sx={{ display: "none" }}
//             />
//             &lt;div>&lt;/div> {/* Filler */}
//             &lt;div>&lt;/div> {/* Filler */}
//             &lt;div>&lt;/div> {/* Filler */}
//           &lt;/div>
//         &lt;/FormSection>

//         {/* Office Order Details */}
//         &lt;FormSection>
//           &lt;h3 style={sectionHeadingStyle}>
//             Office Order Details
//           &lt;/h3>

//           {/* Reference Number and Date */}
//           &lt;div style={gridRowTwoColumnStyles}>
//             &lt;TextField
//               label="Reference Number"
//               name="referenceNo"
//               value={bodyData.referenceNo}
//               onChange={handleChange}
//               InputProps={{ readOnly: true }}
//               variant="outlined"
//               fullWidth
//             />
//             &lt;TextField
//               type="date"
//               label="Reference Date"
//               name="referenceDate"
//               value={bodyData.referenceDate}
//               onChange={handleChange}
//               InputLabelProps={{ shrink: true }}
//               variant="outlined"
//               fullWidth
//             />
//           &lt;/div>

//           {/* Subject and Ref in one row (2 columns) */}
//           &lt;div style={gridRowTwoColumnStyles}>
//             &lt;TextField
//               label="Subject"
//               name="subject"
//               value={bodyData.subject}
//               onChange={handleChange}
//               variant="outlined"
//               fullWidth
//               multiline
//               rows={2}
//             />

//             &lt;TextField
//               label="Ref"
//               name="refsubject"
//               value={bodyData.refsubject || ""}
//               onChange={handleChange}
//               variant="outlined"
//               fullWidth
//               multiline
//               rows={2}
//             />
//           &lt;/div>

//           {/* Body (Full width) */}
//           &lt;div style={{ marginBottom: "16px" }}>
//             &lt;label style={labelStyle}>Body&lt;/label>
//             &lt;TextEdit
//               value={bodyData.body}
//               onChange={(value) => {
//                 setBodyData((prev) => ({ ...prev, body: value }));
//                 setIsSavedSuccessfully(false);
//               }}
//             />
//           &lt;/div>

//           &lt;br />
          
//           {/* Signing Authority and TO Section side by side */}
//           &lt;div style={gridRowTwoColumnStyles}>
//             &lt;div>
//               &lt;Dropdown
//                 label="Signing Authority"
//                 options={signingOptions}
//                 value={signingValue}
//                 onChange={handleSigningChange}
//               />
//             &lt;/div>
//             &lt;div>
//               &lt;DropdownWithCheckboxes
//                 label="To Section"
//                 options={toSectionOptions.map(opt => ({ value: opt, label: opt }))}
//                 value={formData.toSection}
//                 onChange={(selected) => {
//                   setFormData((prev) => ({ ...prev, toSection: selected }));
//                   setIsSavedSuccessfully(false);
//                 }}
//               />
//             &lt;/div>
//           &lt;/div>

//           &lt;br />

//           {/* Remarks (Full width) */}
//           &lt;div style={gridRowTwoColumnStyle}>
//             &lt;TextField
//               label="Remarks"
//               name="remarks"
//               value={formData.remarks}
//               onChange={handleChange}
//               variant="outlined"
//               fullWidth
//               multiline
//               rows={2}
//             />
//           &lt;/div>
//         &lt;/FormSection>

//         {/* Buttons (Right Aligned) */}
//         &lt;div style={buttonContainerStyle}>
//           &lt;SaveButton
//             variant="primary"
//             styleType="gradient"
//             onClick={handleSave}
//             disabled={loading}
//           >
//             Save as Draft
//           &lt;/SaveButton>

//           &lt;SubmitButton
//             type="submit"
//             variant="success"
//             styleType="filled"
//             disabled={loading}
//           >
//             Submit
//           &lt;/SubmitButton>

//           {isSavedSuccessfully &amp;&amp; (
//             &lt;FavoriteButton
//               onClick={handlePreview}
//               variant="warning"
//               styleType="filled"
//               disabled={loading}
//             >
//               Preview
//             &lt;/FavoriteButton>
//           )}

//           &lt;DeleteButton
//             onClick={handleDelete}
//             disabled={loading}
           
//           >
//             Delete
//           &lt;/DeleteButton>
//         &lt;/div>
//       &lt;/form>
//     &lt;/div>
//   );
// };

// /* ---------- STYLES ---------- */

// const cardStyle = {
//   width: "100%",
//   maxWidth: "2000px",
//   padding: "32px",
//   borderRadius: "12px",
//   boxShadow: "0 8px 16px rgba(0,0,0,0.1)",
//   backgroundColor: "#fff",
//   marginTop: "20px",
// };
// const headingStyle = {
//   marginBottom: "24px",
//   color: "rgb(107, 114, 128)",
//   fontSize: "24px",
//   fontWeight: "600",
// };
// const sectionHeadingStyle = {
//   marginBottom: "16px",
//   fontSize: "18px",
//   fontWeight: "600",
//   color: "#374151",
// };
// const labelStyle = {
//   display: "block",
//   marginBottom: "6px",
//   fontWeight: "500",
//   color: "#374151",
// };
// const gridRowStyle = {
//   display: "grid",
//   gridTemplateColumns: "repeat(4, 1fr)",
//   gap: "16px",
//   marginBottom: "16px",
// };
// const gridRowTwoColumnStyle = {
//   display: "grid",
//   gridTemplateColumns: "repeat(1, 1fr)",
//   gap: "16px",
//   marginBottom: "16px",
// };

// const gridRowTwoColumnStyles = {
//   display: "grid",
//   gridTemplateColumns: "repeat(2, 1fr)",
//   gap: "16px",
//   marginBottom: "16px",
//   width: "100%",
// };

// const loadingStyle = {
//   display: "flex",
//   justifyContent: "center",
//   alignItems: "center",
//   height: "100vh",
//   fontSize: "18px",
//   color: "#6B7280",
// };
// const buttonContainerStyle = {
//   display: "flex",
//   gap: "12px",
//   marginTop: "20px",
//   justifyContent: "flex-end",
// };

// export default SaveandHold;


/**
 * @fileoverview Save and Hold component for managing employee visit office orders.
 * Handles editing, saving as draft, submission, deletion, and preview generation
 * for permission cum relief tasks in a save-and-hold workflow state.
 * @module SaveandHold
 * @author Rakshana
 * @date 01/11/2025
 * @since 1.0.0
 */

import React, { useState, useEffect } from "react";
import Cookies from "js-cookie";
import TextField from "@mui/material/TextField";
import OfficeOrderPreview from "./OfficeOrderPreview.js";
import {
  decryptData,
  validateJsonData,
} from "src/components/Decryption/Decrypt";
import Alerts from "src/components/ui/Alerts.js";
import TextEdit from "./TextEdit";
import Swal from "sweetalert2";
import { HostName } from "src/assets/host/Host";
import DropdownWithCheckboxes from "src/components/ui/DropdownWithCheckBox";
import Dropdown from "src/components/ui/Dropdown";
import FormSection from "src/components/ui/TopColorCard.js";
import { SaveButton, SubmitButton, FavoriteButton, BackButton, DeleteButton } from "src/components/ui/Button.js";

/**
 * Formats a date string into an ISO timestamp with a specified hour and Indian timezone offset.
 * @param {string} dateStr - The date string in YYYY-MM-DD format.
 * @param {string} [hour="09:00:00"] - The hour in HH:MM:SS format to append.
 * @returns {string|null} The formatted ISO timestamp or null if input is invalid.
 */
const formatTimestamp = (dateStr, hour = "09:00:00") => {
  if (!dateStr || !dateStr.trim()) return null;
  const date = new Date(`${dateStr}T${hour}`);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const day = String(date.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}T${hour}+05:30`;
};

/**
 * Calculates the duration in days between two dates, inclusive.
 * @param {string} from - The start date string.
 * @param {string} to - The end date string.
 * @returns {number} The calculated duration in days.
 */
const calculateDuration = (from, to) => {
  if (!from || !to) return 0;
  const diff = new Date(to) - new Date(from);
  return Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1;
};

/**
 * Generates HTML for the "To" column based on form data.
 * @param {Object} formData - The form data object containing signing authority and employee details.
 * @returns {string} The formatted HTML string for the "To" column.
 */
const getToColumnHtml = (formData) => {
  const { signingAuthority, department = "N/A Department", facultyname = "N/A Name", employeeid = "N/A" } = formData;
  let toColumnValue = "";
  if (signingAuthority) {
    toColumnValue = `&lt;p>&lt;strong>To&lt;/strong>&lt;br>${facultyname} (ID No. ${employeeid})&lt;br>Thro the Head, ${department}&lt;/p>&lt;p>&lt;strong>Sir,&lt;/strong>&lt;/p>`;
  }
  return toColumnValue;
};

/**
 * Main React component for the Save and Hold workflow.
 * Manages editing of existing office order tasks, saving drafts, submission,
 * deletion, and PDF preview generation.
 * 
 * @component
 * @param {Object} props - Component props.
 * @param {Function} [props.onClose] - Callback function to close the form/modal.
 * @param {Object} [props.record] - Initial record data containing cover page number and employee ID.
 * @param {Function} [props.onSuccess] - Optional callback on successful submission or deletion.
 * @returns {JSX.Element} The rendered form component.
 */
const SaveandHold = ({ onClose, record, onSuccess }) => {
  const [formData, setFormData] = useState({
    employeeid: "",
    facultyname: "",
    department: "",
    designation: "",
    visitfrom: "",
    visitto: "",
    natureofparticipation_value: "",
    country: "",
    city: "",
    claimtype: "",
    signingAuthority: "",
    toSection: [],
    remarks: "",
  });

  const [bodyData, setBodyData] = useState({
    referenceNo: "",
    referenceDate: "",
    subject: "",
    refsubject: "",
    body: "",
    header: "",
    footer: "",
    template: "",
  });

  const [showPreview, setShowPreview] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [isSavedSuccessfully, setIsSavedSuccessfully] = useState(false);
  const [previewData, setPreviewData] = useState(null);
  const [previewCoverPageNo, setPreviewCoverPageNo] = useState(null);
  const [selectedEmployeeId, setSelectedEmployeeId] = useState(null);

  const sessionId = Cookies.get("session_id");
  const empId = Cookies.get("EmpId");
  const userRole = Cookies.get("selectedRole");
  const jwtToken = Cookies.get("HRToken");

  const toSectionOptions = [
    `The Head of ${formData?.department || ""}`,
    "The Dean (Faculty)",
    "The Dean (Admin)",
    "The Dean (IC&amp;SR)",
    "The Dean (ACR)",
    "The Dean (GE)",
    "The Deputy Registrar (F&amp;A)",
    "Office copy",
    "AR (Paybill)",
    "AR (Bills)",
  ];

  const signingOptions = [
    { value: "Signing Authority", label: "Select Signing Authority" },
    { value: "Deputy Registrar", label: "Deputy Registrar" },
    { value: "Assistant Registrar", label: "Assistant Registrar" },
    { value: "Registrar", label: "Registrar" },
  ];

  const signingValue = signingOptions.find(opt => opt.value === formData.signingAuthority) || signingOptions[0];

  /**
   * Handles changes to the signing authority dropdown selection.
   * @param {Object} selectedOption - The newly selected option object.
   */
  const handleSigningChange = (selectedOption) => {
    setFormData(prev => ({ ...prev, signingAuthority: selectedOption.value }));
    setIsSavedSuccessfully(false);
  };

  /**
   * Formats a date value to YYYY-MM-DD string.
   * @param {string} dateValue - The raw date value to format.
   * @returns {string} The formatted date string or empty if invalid.
   */
  const formatDate = (dateValue) => {
    if (!dateValue) return "";
    const date = new Date(dateValue);
    return isNaN(date.getTime()) ? "" : date.toISOString().split("T")[0];
  };

  /**
   * Fetches employee details and existing task data from the API.
   * Populates form and body data states, processes CC sections and signing authority.
   * @param {string} coverpageno - The cover page number for the record.
   * @param {string} employeeid - The employee ID to fetch data for.
   */
  const fetchEmployeeDetails = async (coverpageno, employeeid) => {
    setLoading(true);
    setError("");
    try {
      if (!jwtToken) throw new Error("Authentication token missing.");
      if (!employeeid) throw new Error("Employee ID missing");

      const body = {
        employeeid,
        coverpageno,
        token: "HRFGVJISOVp1fncC",
        session_id: sessionId,
      };

      const response = await fetch(`${HostName}/OfficeOrder_taskvisitdetails`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${jwtToken}`,
        },
        body: JSON.stringify(body),
      });

      const encryptedData = await response.json();
      const encryptedPayload = encryptedData.Data ?? encryptedData.data;
      if (!encryptedPayload) throw new Error("Encrypted Data missing");

      const decryptedString = await decryptData(encryptedPayload);
      const parsedData = validateJsonData(decryptedString);

      const records = parsedData?.Records ?? parsedData?.Data?.Records ?? [];
      if (!records.length) throw new Error("No records found");

      const record = records[0];
      const rawCcList = record.cc_to || "";
      const ccSectionsArray = rawCcList
        ? rawCcList
            .split(",")
            .map((s) => s.trim())
            .filter((s) => s)
        : [];

      let signingAuthorityValue = record.signing_authority || "";

      if (record.signature_html) {
        const signatureTextMatch = record.signature_html.match(/&lt;p>(.*?)&lt;\/p>/i);
        const signatureLabel = signatureTextMatch ? signatureTextMatch[1].trim() : '';
        
        if (signatureLabel) {
          const matchedOption = signingOptions.find(
            (opt) => opt.label.toLowerCase() === signatureLabel.toLowerCase()
          );
          
          signingAuthorityValue = matchedOption ? matchedOption.value : signatureLabel;
        }
      }

      setFormData({
        employeeid: record?.employee_id || "",
        facultyname: record?.employee_name || "",
        department: record.department || "",
        designation: record.designation || "",
        visitfrom: formatDate(record.visit_from),
        visitto: formatDate(record.visit_to),
        natureofparticipation_value: record.nature_of_visit || "",
        country: record.country || "",
        city: record.city_town || "",
        claimtype: record.claim_type || "",
        signingAuthority: signingAuthorityValue,
        toSection: ccSectionsArray,
        remarks: record.remarks || "",
      });

      setBodyData({
        referenceNo: record.order_no || "",
        referenceDate: formatDate(record.order_date),
        subject: record.subject || "",
        refsubject: record.reference || "",
        body: record.body_html || "",
        header: record.header_html || "",
        footer: record.footer_html || "",
        template: record.template_id || "",
      });

      setIsSavedSuccessfully(true);
    } catch (err) {
      console.error("API Fetch Error:", err);
      setError(err.message || "Failed to fetch employee data");
    } finally {
      setLoading(false);
    }
  };

  /**
   * Effect hook to fetch employee details on component mount if record is provided.
   */
  useEffect(() => {
    if (record?.coverpageno &amp;&amp; record?.employeeid) {
      fetchEmployeeDetails(record.coverpageno, record.employeeid);
    }
  }, [record]);

  /**
   * Handles changes to form inputs, updating state accordingly.
   * Supports checkboxes, body data fields, and general form fields.
   * @param {Object} e - The event object from the input change.
   */
  const handleChange = (e) => {
    const { name, value, type, checked } = e.target;
    setIsSavedSuccessfully(false);

    if (type === "checkbox") {
      setFormData((prev) => {
        const current = Array.isArray(prev.toSection) ? prev.toSection : [];
        const updated = checked
          ? [...current, value]
          : current.filter((v) => v !== value);
        return { ...prev, toSection: updated };
      });
    } else if (
      [
        "referenceNo",
        "referenceDate",
        "subject",
        "refsubject",
        "body",
        "header",
        "footer",
        "template",
      ].includes(name)
    ) {
      setBodyData((prev) => ({ ...prev, [name]: value }));
    } else {
      setFormData((prev) => ({ ...prev, [name]: value }));
    }
  };

  /**
   * Validates the form fields based on draft or submit mode.
   * Checks for required fields, date logic, and content length/format.
   * @param {boolean} [isDraft=false] - Whether to validate for draft (lenient) or full submit.
   * @returns {boolean} True if validation passes, false otherwise.
   */
  const validateForm = (isDraft = false) => {
    const missingFields = [];
    const invalidFields = [];
    const requiredFieldsForSubmit = {
      natureofparticipation_value: "Nature of Visit",
      visitfrom: "Visit From Date",
      visitto: "Visit To Date",
      country: "Country",
      city: "City/Town",
      subject: "Subject",
      refsubject: "Reference (Ref)",
      body: "Body",
      signingAuthority: "Signing Authority",
      toSection: "To Section",
      remarks: "Remarks",
    };
    const requiredFieldsForDraft = {
      natureofparticipation_value: "Nature of Visit",
      visitfrom: "Visit From Date",
      visitto: "Visit To Date",
      country: "Country",
      city: "City/Town",
    };

    const fieldsToValidate = isDraft ? requiredFieldsForDraft : requiredFieldsForSubmit;
    for (const [key, label] of Object.entries(fieldsToValidate)) {
      let value = formData.hasOwnProperty(key) ? formData[key] : bodyData[key];
      if (
        value === "" ||
        value === null ||
        value === undefined ||
        (Array.isArray(value) &amp;&amp; value.length === 0) ||
        (typeof value === "string" &amp;&amp; value.trim() === "")
      ) {
        missingFields.push(label);
      }
    }
    if (formData.visitfrom &amp;&amp; formData.visitto) {
      const fromDate = new Date(formData.visitfrom);
      const toDate = new Date(formData.visitto);
      
      if (fromDate > toDate) {
        invalidFields.push("Visit To Date must be equal to or after Visit From Date");
      }
    }
    if (!isDraft) {
      if (bodyData.subject &amp;&amp; bodyData.subject.trim().length &lt; 10) {
        invalidFields.push("Subject must be at least 10 characters long");
      }
      if (bodyData.body) {
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = bodyData.body;
        const textContent = tempDiv.textContent || tempDiv.innerText || "";
        if (textContent.trim().length &lt; 20) {
          invalidFields.push("Body must contain at least 20 characters of text");
        }
      }
      if (formData.country &amp;&amp; !/^[a-zA-Z\s]+$/.test(formData.country.trim())) {
        invalidFields.push("Country must contain only alphabetic characters");
      }
      if (formData.city &amp;&amp; !/^[a-zA-Z\s,.-]+$/.test(formData.city.trim())) {
        invalidFields.push("City/Town must contain only alphabetic characters and basic punctuation");
      }
     
    }
    const errorMessages = [];
    
    if (missingFields.length > 0) {
      errorMessages.push(`Missing required fields: ${missingFields.join(", ")}`);
    }

    if (invalidFields.length > 0) {
      errorMessages.push(...invalidFields);
    }

    if (errorMessages.length > 0) {
      const message = errorMessages.join(". ");
      setError(message);
      
      Swal.fire({
        title: "Validation Error",
        html: errorMessages.map(msg => `â€¢ ${msg}`).join("&lt;br>"),
        icon: "warning",
      });
      
      return false;
    }

    setError("");
    return true;
  };

  /**
   * Handles saving the form as a draft via API.
   * Fetches status ID for "saveandhold" and updates the task.
   */
  const handleSave = async () => {
    try {
      setLoading(true);
      setError("");

      if (!jwtToken) throw new Error("Authentication token missing.");
      if (!empId) throw new Error("Employee ID missing in cookies.");
      const statusResponse = await fetch(
        "https://wftest1.iitm.ac.in:7000/Statusmasternew",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwtToken}`,
          },
          body: JSON.stringify({
            statusdescription: "saveandhold",
            token: "HRFGVJISOVp1fncC",
            session_id: sessionId,
          }),
        }
      );

      if (!statusResponse.ok) throw new Error("Failed to fetch status");

      const encryptedStatus = await statusResponse.json();
      const decryptedString = await decryptData(
        encryptedStatus.Data ?? encryptedStatus.data
      );
      const validStatusData = validateJsonData(decryptedString);
      const taskStatusId = validStatusData?.Data?.Records?.[0]?.statusid ?? 8;
      const selectedOption = signingOptions.find(opt => opt.value === formData.signingAuthority);
      const signatureText = selectedOption ? selectedOption.label : formData.signingAuthority || "Authority Not Specified";
      const signatureHtml = `&lt;p>${signatureText}&lt;/p>`;
      const toColumnValue = getToColumnHtml(formData);
      const reqpayload = {
        token: "HRFGVJISOVp1fncC",
        session_id: sessionId,
        typeofsubmit: "draft",
        p_cover_page_no: record?.coverpageno || "",
        p_employee_id: formData.employeeid,
        p_employee_name: formData.facultyname,
        p_department: formData.department,
        p_designation: formData.designation,
        p_visit_from: formatTimestamp(formData.visitfrom, "09:00:00"),
        p_visit_to: formatTimestamp(formData.visitto, "17:00:00"),
        p_duration: calculateDuration(formData.visitfrom, formData.visitto),
        p_nature_of_visit: formData.natureofparticipation_value,
        p_claim_type: formData.claimtype || "",
        p_city_town: formData.city,
        p_country: formData.country,
        p_header_html: bodyData.header || "",
        p_order_no: bodyData.referenceNo || "",
        p_order_date: bodyData.referenceDate || new Date().toISOString().split("T")[0],
        p_to_column: toColumnValue,
        p_subject: bodyData.subject || "",
        p_reference: bodyData.refsubject,
        p_body_html: bodyData.body,
        p_signature_html: signatureHtml,
        p_cc_to: Array.isArray(formData.toSection)
          ? formData.toSection.join(",")
          : formData.toSection || "Office copy",
        p_footer_html: bodyData.footer || "",
        p_assign_to: formData.employeeid || "",
        p_assigned_role: "",
        p_task_status_id: taskStatusId,
        p_activity_seq_no: 0,
        p_is_task_return: false,
        p_is_task_approved: true,
        p_initiated_by: empId || "admin",
        p_initiated_on: new Date().toISOString().replace("Z", "+05:30"),
        p_updated_by: empId || "admin",
        p_updated_on: new Date().toISOString().replace("Z", "+05:30"),
        p_process_id: 1,
        p_remarks: formData.remarks,
        p_email_flag: false,
        p_reject_flag: 0,
        p_user_role: userRole || "",
      };

      const response = await fetch(
        `${HostName}/OfficeOrder_InsertOfficedetails`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwtToken}`,
          },
          body: JSON.stringify(reqpayload),
        }
      );

      if (!response.ok)
        throw new Error(
          "Failed to save as draft (OfficeOrder_InsertOfficedetails)"
        );

      await Swal.fire({
        title: "Saved!",
        text: "The task has been saved successfully as a draft.",
        icon: "success",
        timer: 2000,
        showConfirmButton: false,
      });

      setIsSavedSuccessfully(true);
      setPreviewCoverPageNo(record?.coverpageno);
      setSelectedEmployeeId(formData.employeeid);
    } catch (err) {
      console.error("Save as Draft API Error:", err);
      setError(err.message || "Failed to save as draft");
      Swal.fire({
        title: "Error",
        text: err.message || "Failed to save as draft",
        icon: "error",
      });
    } finally {
      setLoading(false);
    }
  };

  /**
   * Handles task deletion after user confirmation.
   * Updates status to "Deleted" via API.
   */
  const handleDelete = async () => {
    const confirmResult = await Swal.fire({
      title: "Are you sure?",
      text: "Do you want to delete the task?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#ED553B",
      cancelButtonColor: "#6c757d",
      confirmButtonText: "Yes, Delete",
      cancelButtonText: "No, Cancel",
    });

    if (!confirmResult.isConfirmed) return;

    try {
      setLoading(true);
      setError("");

      if (!jwtToken) throw new Error("Authentication token missing.");

      const statusResponse = await fetch(
        "https://wftest1.iitm.ac.in:7000/Statusmasternew",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwtToken}`,
          },
          body: JSON.stringify({
            statusdescription: "Deleted",
            token: "HRFGVJISOVp1fncC",
            session_id: sessionId,
          }),
        }
      );

      if (!statusResponse.ok) throw new Error("Failed to fetch status");

      const encryptedStatus = await statusResponse.json();
      const decryptedString = await decryptData(
        encryptedStatus.Data ?? encryptedStatus.data
      );
      const validStatusData = validateJsonData(decryptedString);
      const deletedStatusId =
        validStatusData?.Data?.Records?.[0]?.statusid ?? 8;

      const reqpayload = {
        token: "HRFGVJISOVp1fncC",
        session_id: sessionId,
        p_coverpageno: record.coverpageno,
        p_employeeid: record.employeeid,
        p_taskstatusid: String(deletedStatusId),
        p_updatedby: "DELETEBYUSER",
        p_updatedon: new Date().toISOString(),
      };

      const response = await fetch(`${HostName}/OfficeOrder_statusupdate`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${jwtToken}`,
        },
        body: JSON.stringify(reqpayload),
      });

      if (!response.ok) throw new Error("Failed to update Office Order");

      await Swal.fire({
        title: "Deleted!",
        text: "The task has been marked as deleted successfully.",
        icon: "success",
        timer: 2000,
        showConfirmButton: false,
      });
      onClose?.();
      if (onSuccess) {
        onSuccess();
      }
    } catch (err) {
      console.error("Delete API Error:", err);
      setError(err.message || "Failed to delete Office Order");
      Swal.fire({
        title: "Error",
        text: err.message || "Failed to delete Office Order",
        icon: "error",
      });
    } finally {
      setLoading(false);
    }
  };

  /**
   * Handles form submission after validation.
   * Fetches status ID for "ongoing" and submits the task.
   * @param {Object} [e] - Optional event object to prevent default.
   */
  const handleSubmit = async (e) => {
    if (e) e.preventDefault();
    if (!validateForm()) return;
    try {
      setLoading(true);
      setError("");

      if (!jwtToken) throw new Error("Authentication token missing.");
      if (!empId) throw new Error("Employee ID missing in cookies.");
      const statusResponse = await fetch(
        "https://wftest1.iitm.ac.in:7000/Statusmasternew",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwtToken}`,
          },
          body: JSON.stringify({
            statusdescription: "ongoing",
            token: "HRFGVJISOVp1fncC",
            session_id: sessionId,
          }),
        }
      );

      if (!statusResponse.ok)
        throw new Error("Failed to fetch status for 'ongoing'");

      const encryptedStatus = await statusResponse.json();
      const decryptedString = await decryptData(
        encryptedStatus.Data ?? encryptedStatus.data
      );
      const validStatusData = validateJsonData(decryptedString);
      const taskStatusId = validStatusData?.Data?.Records?.[0]?.statusid ?? 8;
      const selectedOption = signingOptions.find(opt => opt.value === formData.signingAuthority);
      const signatureText = selectedOption ? selectedOption.label : formData.signingAuthority || "Authority Not Specified";
      const signatureHtml = `&lt;p>${signatureText}&lt;/p>`;
      const toColumnValue = getToColumnHtml(formData);
      const requestpayload = {
        token: "HRFGVJISOVp1fncC",
        session_id: sessionId,
        typeofsubmit: "Submit",
        p_cover_page_no: record?.coverpageno || "",
        p_employee_id: formData.employeeid,
        p_employee_name: formData.facultyname,
        p_department: formData.department,
        p_designation: formData.designation,
        p_visit_from: formatTimestamp(formData.visitfrom, "09:00:00"),
        p_visit_to: formatTimestamp(formData.visitto, "17:00:00"),
        p_duration: calculateDuration(formData.visitfrom, formData.visitto),
        p_nature_of_visit: formData.natureofparticipation_value,
        p_claim_type: formData.claimtype || "",
        p_city_town: formData.city,
        p_country: formData.country,
        p_header_html: bodyData.header || "",
        p_order_no: bodyData.referenceNo || "",
        p_order_date: bodyData.referenceDate || new Date().toISOString().split("T")[0],
        p_to_column: toColumnValue,
        p_subject: bodyData.subject || "",
        p_reference: bodyData.refsubject,
        p_body_html: bodyData.body,
        p_signature_html: signatureHtml,
        p_cc_to: Array.isArray(formData.toSection)
          ? formData.toSection.join(",")
          : formData.toSection ,
        p_footer_html: bodyData.footer || "",
        p_assign_to: "",
        p_assigned_role: "",
        p_task_status_id: taskStatusId,
        p_activity_seq_no: 1,
        p_is_task_return: false,
        p_is_task_approved: true,
        p_initiated_by: empId || "admin",
        p_initiated_on: new Date().toISOString().replace("Z", "+05:30"),
        p_updated_by: empId || "admin",
        p_updated_on: new Date().toISOString().replace("Z", "+05:30"),
        p_process_id: 1,
        p_remarks: formData.remarks,
        p_email_flag: false,
        p_reject_flag: 0,
        p_user_role: userRole || "",
      };

      const response = await fetch(
        `${HostName}/OfficeOrder_InsertOfficedetails`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwtToken}`,
          },
          body: JSON.stringify(requestpayload),
        }
      );

      if (!response.ok)
        throw new Error("Failed to insert Office Order (Submit)");

      await Swal.fire({
        title: "Submitted!",
        text: "The task has been Submitted Successfully.",
        icon: "success",
        timer: 2000,
        showConfirmButton: false,
      });
      onClose?.();

      if (onSuccess) {
        onSuccess();
      }
    } catch (err) {
      console.error("Insert API Error:", err);
      setError(err.message || "Failed to insert Office Order");
      Swal.fire({
        title: "Error",
        text: err.message || "Failed to insert Office Order",
        icon: "error",
      });
    } finally {
      setLoading(false);
    }
  };

  /**
   * Handles preview generation after ensuring a draft is saved.
   * Fetches PDF blob from API and opens preview modal.
   */
  const handlePreview = async () => {
    if (!isSavedSuccessfully) {
      setError("Please save the draft or submit the form before previewing.");
      Swal.fire({
        title: "Action Required",
        text: "Please save the current changes as a draft or submit the form before generating the preview PDF.",
        icon: "info",
      });
      return;
    }
    
    if (
      !record?.coverpageno ||
      !formData.employeeid ||
      !formData.signingAuthority
    ) {
      setError(
        "Cannot generate preview: Missing Cover Page Number, Employee ID, or Signing Authority."
      );
      return;
    }
    
    setLoading(true);
    setError("");

    try {
      if (!jwtToken) throw new Error("Authentication token missing.");
      const pdfApiUrl = `https://wftest1.iitm.ac.in:8080/api/officeorder/pdf`;
      
      const previewpayload = {
        employeeid: formData.employeeid,
        coverpageno: record.coverpageno,
        templatetype: "draft",
        status: "saveandhold",
      };
      
      const response = await fetch(pdfApiUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${jwtToken}`,
        },
        body: JSON.stringify(previewpayload),
      });

      if (!response.ok) {
        const errorText = await response.text();
        throw new Error(
          `Failed to generate PDF. Server responded with: ${
            errorText || response.statusText
          }`
        );
      }

      const pdfBlob = await response.blob();
      const fileURL = URL.createObjectURL(pdfBlob);
      
      setPreviewData({
        pdfUrl: fileURL,
        formData: formData,
        bodyData: bodyData,
      });
      setPreviewCoverPageNo(record.coverpageno);
      setSelectedEmployeeId(formData.employeeid);
      
      setShowPreview(true);

    } catch (err) {
      console.error("Preview Generation Error:", err);
      const errorMessage =
        err.message ||
        "An unexpected error occurred while generating the preview.";
      setError(errorMessage);
      Swal.fire({
        title: "Preview Error",
        text: errorMessage,
        icon: "error",
      });
    } finally {
      setLoading(false);
    }
  };

  /**
   * Closes the preview modal and revokes the PDF URL to free memory.
   */
  const handleClosePreview = () => {
    setShowPreview(false);
    if (previewData?.pdfUrl) {
      URL.revokeObjectURL(previewData.pdfUrl);
      setPreviewData(null);
    }
  };

  /**
   * Handles back navigation by calling the onClose callback.
   */
  const handleBack = () => onClose?.();

  if (loading)
    return &lt;div style={loadingStyle}>Loading employee data...&lt;/div>;

  if (showPreview &amp;&amp; previewData?.pdfUrl) {
    return (
      &lt;OfficeOrderPreview
        coverpageno={previewCoverPageNo}
        employeeid={selectedEmployeeId}
        pdfUrl={previewData.pdfUrl}
        formData={previewData.formData}
        bodyData={previewData.bodyData}
        onBack={handleClosePreview}
        isLocalPreview={false}
        loading={loading}
      />
    );
  }

  return (
    &lt;div style={cardStyle}>
      &lt;BackButton onClick={handleBack} />
      &lt;h2 style={headingStyle}>Permission Cum Relief&lt;/h2>
      {error &amp;&amp; &lt;Alerts type="error" variant="outlined" message={error} />}

      &lt;form onSubmit={handleSubmit}>
        {/* Employee Info */}
        &lt;FormSection>
          &lt;h3 style={sectionHeadingStyle}>
            Employee Information
          &lt;/h3>

          {/* Row 1: Employee ID, Name, Dept, Desig */}
          &lt;div style={gridRowStyle}>
            &lt;TextField
              label="Employee ID"
              name="employeeid"
              value={formData.employeeid}
              onChange={handleChange}
              InputProps={{ readOnly: true }}
              variant="outlined"
              fullWidth
            />
            &lt;TextField
              label="Employee Name"
              name="facultyname"
              value={formData.facultyname}
              onChange={handleChange}
              InputProps={{ readOnly: true }}
              variant="outlined"
              fullWidth
            />
            &lt;TextField
              label="Department"
              name="department"
              value={formData.department}
              onChange={handleChange}
              InputProps={{ readOnly: true }}
              variant="outlined"
              fullWidth
            />
            &lt;TextField
              label="Designation"
              name="designation"
              value={formData.designation}
              onChange={handleChange}
              InputProps={{ readOnly: true }}
              variant="outlined"
              fullWidth
            />
          &lt;/div>

          {/* Row 2: Nature, Visit From, Visit To, Country */}
          &lt;div style={gridRowStyle}>
            &lt;TextField
              label="Nature of Visit"
              name="natureofparticipation_value"
              value={formData.natureofparticipation_value}
              onChange={handleChange}
              variant="outlined"
              fullWidth
            />
            &lt;TextField
              type="date"
              label="Visit From"
              name="visitfrom"
              value={formData.visitfrom}
              onChange={handleChange}
              InputLabelProps={{ shrink: true }}
              variant="outlined"
              fullWidth
            />
            &lt;TextField
              type="date"
              label="Visit To"
              name="visitto"
              value={formData.visitto}
              onChange={handleChange}
              InputLabelProps={{ shrink: true }}
              variant="outlined"
              fullWidth
            />
            &lt;TextField
              label="Country"
              name="country"
              value={formData.country}
              onChange={handleChange}
              variant="outlined"
              fullWidth
            />
          &lt;/div>

          {/* Row 3: City/Town (1 column) */}
          &lt;div style={gridRowStyle}>
            &lt;TextField
              label="City/Town"
              name="city"
              value={formData.city}
              onChange={handleChange}
              variant="outlined"
              fullWidth
            />
            {/* Claim Type hidden field */}
            &lt;TextField
              label="Claim Type"
              name="claimtype"
              value={formData.claimtype}
              onChange={handleChange}
              InputProps={{ readOnly: true }}
              sx={{ display: "none" }}
            />
            &lt;div>&lt;/div> {/* Filler */}
            &lt;div>&lt;/div> {/* Filler */}
            &lt;div>&lt;/div> {/* Filler */}
          &lt;/div>
        &lt;/FormSection>

        {/* Office Order Details */}
        &lt;FormSection>
          &lt;h3 style={sectionHeadingStyle}>
            Office Order Details
          &lt;/h3>

          {/* Reference Number and Date */}
          &lt;div style={gridRowTwoColumnStyles}>
            &lt;TextField
              label="Reference Number"
              name="referenceNo"
              value={bodyData.referenceNo}
              onChange={handleChange}
              InputProps={{ readOnly: true }}
              variant="outlined"
              fullWidth
            />
            &lt;TextField
              type="date"
              label="Reference Date"
              name="referenceDate"
              value={bodyData.referenceDate}
              onChange={handleChange}
              InputLabelProps={{ shrink: true }}
              variant="outlined"
              fullWidth
            />
          &lt;/div>

          {/* Subject and Ref in one row (2 columns) */}
          &lt;div style={gridRowTwoColumnStyles}>
            &lt;TextField
              label="Subject"
              name="subject"
              value={bodyData.subject}
              onChange={handleChange}
              variant="outlined"
              fullWidth
              multiline
              rows={2}
            />

            &lt;TextField
              label="Ref"
              name="refsubject"
              value={bodyData.refsubject || ""}
              onChange={handleChange}
              variant="outlined"
              fullWidth
              multiline
              rows={2}
            />
          &lt;/div>

          {/* Body (Full width) */}
          &lt;div style={{ marginBottom: "16px" }}>
            &lt;label style={labelStyle}>Body&lt;/label>
            &lt;TextEdit
              value={bodyData.body}
              onChange={(value) => {
                setBodyData((prev) => ({ ...prev, body: value }));
                setIsSavedSuccessfully(false);
              }}
            />
          &lt;/div>

          &lt;br />
          
          {/* Signing Authority and TO Section side by side */}
          &lt;div style={gridRowTwoColumnStyles}>
            &lt;div>
              &lt;Dropdown
                label="Signing Authority"
                options={signingOptions}
                value={signingValue}
                onChange={handleSigningChange}
              />
            &lt;/div>
            &lt;div>
              &lt;DropdownWithCheckboxes
                label="To Section"
                options={toSectionOptions.map(opt => ({ value: opt, label: opt }))}
                value={formData.toSection}
                onChange={(selected) => {
                  setFormData((prev) => ({ ...prev, toSection: selected }));
                  setIsSavedSuccessfully(false);
                }}
              />
            &lt;/div>
          &lt;/div>

          &lt;br />

          {/* Remarks (Full width) */}
          &lt;div style={gridRowTwoColumnStyle}>
            &lt;TextField
              label="Remarks"
              name="remarks"
              value={formData.remarks}
              onChange={handleChange}
              variant="outlined"
              fullWidth
              multiline
              rows={2}
            />
          &lt;/div>
        &lt;/FormSection>

        {/* Buttons (Right Aligned) */}
        &lt;div style={buttonContainerStyle}>
          &lt;SaveButton
            variant="primary"
            styleType="gradient"
            onClick={handleSave}
            disabled={loading}
          >
            Save as Draft
          &lt;/SaveButton>

          &lt;SubmitButton
            type="submit"
            variant="success"
            styleType="filled"
            disabled={loading}
          >
            Submit
          &lt;/SubmitButton>

          {isSavedSuccessfully &amp;&amp; (
            &lt;FavoriteButton
              onClick={handlePreview}
              variant="warning"
              styleType="filled"
              disabled={loading}
            >
              Preview
            &lt;/FavoriteButton>
          )}

          &lt;DeleteButton
            onClick={handleDelete}
            disabled={loading}
           
          >
            Delete
          &lt;/DeleteButton>
        &lt;/div>
      &lt;/form>
    &lt;/div>
  );
};

/* ---------- STYLES ---------- */

const cardStyle = {
  width: "100%",
  maxWidth: "2000px",
  padding: "32px",
  borderRadius: "12px",
  boxShadow: "0 8px 16px rgba(0,0,0,0.1)",
  backgroundColor: "#fff",
  marginTop: "20px",
};
const headingStyle = {
  marginBottom: "24px",
  color: "rgb(107, 114, 128)",
  fontSize: "24px",
  fontWeight: "600",
};
const sectionHeadingStyle = {
  marginBottom: "16px",
  fontSize: "18px",
  fontWeight: "600",
  color: "#374151",
};
const labelStyle = {
  display: "block",
  marginBottom: "6px",
  fontWeight: "500",
  color: "#374151",
};
const gridRowStyle = {
  display: "grid",
  gridTemplateColumns: "repeat(4, 1fr)",
  gap: "16px",
  marginBottom: "16px",
};
const gridRowTwoColumnStyle = {
  display: "grid",
  gridTemplateColumns: "repeat(1, 1fr)",
  gap: "16px",
  marginBottom: "16px",
};

const gridRowTwoColumnStyles = {
  display: "grid",
  gridTemplateColumns: "repeat(2, 1fr)",
  gap: "16px",
  marginBottom: "16px",
  width: "100%",
};

const loadingStyle = {
  display: "flex",
  justifyContent: "center",
  alignItems: "center",
  height: "100vh",
  fontSize: "18px",
  color: "#6B7280",
};
const buttonContainerStyle = {
  display: "flex",
  gap: "12px",
  marginTop: "20px",
  justifyContent: "flex-end",
};

export default SaveandHold;</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Wed Nov 05 2025 11:24:43 GMT+0530 (India Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
