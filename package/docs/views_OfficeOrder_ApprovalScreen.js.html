<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>views/OfficeOrder/ApprovalScreen.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-AdditionalDetails.html">AdditionalDetails</a><ul class='methods'><li data-type='method'><a href="module-AdditionalDetails.html#~AdditionalDetails">AdditionalDetails</a></li><li data-type='method'><a href="module-AdditionalDetails.html#~AdditionalDetails">AdditionalDetails</a></li></ul></li><li></li><li><a href="module-ApprovalForm.html">ApprovalForm</a><ul class='methods'><li data-type='method'><a href="module-ApprovalForm.html#~ApprovalForm">ApprovalForm</a></li><li data-type='method'><a href="module-ApprovalForm.html#~ApprovalForm">ApprovalForm</a></li></ul></li><li></li><li><a href="module-EmployeeVisitForm.html">EmployeeVisitForm</a><ul class='methods'><li data-type='method'><a href="module-EmployeeVisitForm.html#~EmployeeVisitForm">EmployeeVisitForm</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~EmployeeVisitForm">EmployeeVisitForm</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~stripNonEnglish">stripNonEnglish</a></li><li data-type='method'><a href="module-EmployeeVisitForm.html#~stripNonEnglish">stripNonEnglish</a></li></ul></li><li></li><li><a href="module-SaveandHold.html">SaveandHold</a><ul class='methods'><li data-type='method'><a href="module-SaveandHold.html#~SaveandHold">SaveandHold</a></li><li data-type='method'><a href="module-SaveandHold.html#~SaveandHold">SaveandHold</a></li><li data-type='method'><a href="module-SaveandHold.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-SaveandHold.html#~calculateDuration">calculateDuration</a></li><li data-type='method'><a href="module-SaveandHold.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-SaveandHold.html#~formatTimestamp">formatTimestamp</a></li><li data-type='method'><a href="module-SaveandHold.html#~getToColumnHtml">getToColumnHtml</a></li><li data-type='method'><a href="module-SaveandHold.html#~getToColumnHtml">getToColumnHtml</a></li></ul></li><li></li><li><a href="module-components_Roadmap.html">components/Roadmap</a><ul class='methods'><li data-type='method'><a href="module-components_Roadmap.html#~Roadmap">Roadmap</a></li></ul></li><li><a href="module-src_components_UIShowcase.html">src/components/UIShowcase</a><ul class='methods'><li data-type='method'><a href="module-src_components_UIShowcase.html#~UIShowcase">UIShowcase</a></li></ul></li><li><a href="module-src_components_authentication_OtpVerification.html">src/components/authentication/OtpVerification</a><ul class='methods'><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~addTrustedDevice">addTrustedDevice</a></li><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~generateDeviceFingerprint">generateDeviceFingerprint</a></li><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~getDeviceInfo">getDeviceInfo</a></li><li data-type='method'><a href="module-src_components_authentication_OtpVerification.html#~removeTrustedDevice">removeTrustedDevice</a></li></ul></li><li><a href="module-src_components_ui.html">src/components/ui</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui.html#~AnimatedSlide">AnimatedSlide</a></li><li data-type='method'><a href="module-src_components_ui.html#~CardStyle">CardStyle</a></li></ul></li><li></li><li></li><li></li><li><a href="module-src_components_ui_Alerts.html">src/components/ui/Alerts</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Alerts.html#~Alerts">Alerts</a></li></ul></li><li><a href="module-src_components_ui_Avatar.html">src/components/ui/Avatar</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Avatar.html#~Avatar">Avatar</a></li></ul></li><li><a href="module-src_components_ui_Badge.html">src/components/ui/Badge</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Badge.html#~Badge">Badge</a></li></ul></li><li><a href="module-src_components_ui_Button.html">src/components/ui/Button</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Button.html#~Button">Button</a></li><li data-type='method'><a href="module-src_components_ui_Button.html#~ButtonGroup">ButtonGroup</a></li><li data-type='method'><a href="module-src_components_ui_Button.html#~NavigationContainer">NavigationContainer</a></li></ul></li><li><a href="module-src_components_ui_Card.html">src/components/ui/Card</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Card.html#~Card">Card</a></li></ul></li><li><a href="module-src_components_ui_Checkbox.html">src/components/ui/Checkbox</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Checkbox.html#~Checkbox">Checkbox</a></li></ul></li><li><a href="module-src_components_ui_DialogBox.html">src/components/ui/DialogBox</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_DialogBox.html#~DialogBox">DialogBox</a></li></ul></li><li><a href="module-src_components_ui_Dropdown.html">src/components/ui/Dropdown</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Dropdown.html#~Dropdown">Dropdown</a></li></ul></li><li><a href="module-src_components_ui_Input.html">src/components/ui/Input</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_Input.html#~Input">Input</a></li></ul></li><li><a href="module-src_components_ui_Pagination.html">src/components/ui/Pagination</a></li><li><a href="module-src_components_ui_PriorityIcon.html">src/components/ui/PriorityIcon</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_PriorityIcon.html#~PriorityIcon">PriorityIcon</a></li></ul></li><li><a href="module-src_components_ui_TextArea.html">src/components/ui/TextArea</a><ul class='methods'><li data-type='method'><a href="module-src_components_ui_TextArea.html#~TextArea">TextArea</a></li></ul></li><li><a href="module-src_layouts_full_header_Profile.html">src/layouts/full/header/Profile</a></li><li><a href="module-src_pages_Inbox_Inbox.html">src/pages/Inbox/Inbox</a></li><li><a href="module-src_services_EnhancedDynamicDecryption.html">src/services/EnhancedDynamicDecryption</a><ul class='methods'><li data-type='method'><a href="module-src_services_EnhancedDynamicDecryption.html#~base64ToArrayBuffer">base64ToArrayBuffer</a></li><li data-type='method'><a href="module-src_services_EnhancedDynamicDecryption.html#~getAuthHeaders">getAuthHeaders</a></li></ul></li><li><a href="module-src_views_authentication_auth_AuthLogin.html">src/views/authentication/auth/AuthLogin</a></li><li><a href="module-src_views_authentication_auth_encryption.html">src/views/authentication/auth/encryption</a><ul class='methods'><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.authenticateUser">authenticateUser</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.decryptGCM">decryptGCM</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.encryptECB">encryptECB</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.getDecryptKeyFromCookies">getDecryptKeyFromCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.getSessionIdFromCookies">getSessionIdFromCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.getUserFromCookies">getUserFromCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.isUserAuthenticated">isUserAuthenticated</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#.logoutUser">logoutUser</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~deleteCookie">deleteCookie</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~generate256BitKey">generate256BitKey</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~getAuthHeaders">getAuthHeaders</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~getCookie">getCookie</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~insertSessionData">insertSessionData</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~saveUserToCookies">saveUserToCookies</a></li><li data-type='method'><a href="module-src_views_authentication_auth_encryption.html#~setCookie">setCookie</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#CommentsHistory">CommentsHistory</a></li><li><a href="global.html#DateInput">DateInput</a></li><li><a href="global.html#DatePicker">DatePicker</a></li><li><a href="global.html#DateRangePicker">DateRangePicker</a></li><li><a href="global.html#DocumentUpload">DocumentUpload</a></li><li><a href="global.html#DropZone">DropZone</a></li><li><a href="global.html#FileUpload">FileUpload</a></li><li><a href="global.html#ImageUpload">ImageUpload</a></li><li><a href="global.html#InlineDateRangePicker">InlineDateRangePicker</a></li><li><a href="global.html#Login2">Login2</a></li><li><a href="global.html#MultiFileUpload">MultiFileUpload</a></li><li><a href="global.html#TaskCard">TaskCard</a></li><li><a href="global.html#TaskSummaryPage">TaskSummaryPage</a></li><li><a href="global.html#base64ToArrayBuffer">base64ToArrayBuffer</a></li><li><a href="global.html#decrypt">decrypt</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">views/OfficeOrder/ApprovalScreen.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview ApprovalForm component for handling office order approvals.
 * Manages form data, comments, approver actions, and preview for permission cum relief tasks.
 * @module ApprovalForm
 * @author Rakshana
 * @date 01/11/2025
 * @since 1.0.0
 */

import React, {
  useState,
  useEffect,
  useMemo,
  useCallback,
  useRef,
} from "react";
import Cookies from "js-cookie";
import TextField from "@mui/material/TextField";
import OfficeOrderPreview from "src/views/OfficeOrder/OfficeOrderPreview.js";
import {
  decryptData,
  validateJsonData,
} from "src/components/Decryption/Decrypt";
import TextEdit from "src/views/OfficeOrder/TextEdit";
import Swal from "sweetalert2";
import { HostName } from "src/assets/host/Host";
import { useNavigate } from "react-router-dom";
import ApproverSection from "src/components/Process/ApproverSection";
import CommentsSection from "src/components/Process/CommentsSection";
import Dropdown from "src/components/ui/Dropdown";
import DropdownWithCheckboxes from "src/components/ui/DropdownWithCheckBox";
import FormSection from "src/components/ui/TopColorCard.js"; // New import for the FormSection component
import Roadmap from "src/components/Process/RoadMap"; 

/**
 * Main React component for the Approval Form.
 * Handles loading task data, employee details, comments, approval actions,
 * editing office order content, saving drafts, submitting approvals/rejections,
 * and generating previews.
 * 
 * @component
 * @param {Object} props - Component props.
 * @param {Object} [props.taskData] - Task data containing details like TaskId, EmployeeID, etc.
 * @param {Function} [props.onClose] - Callback function to close the form/modal.
 * @param {Object} [props.record] - Optional record data with employeeid, coverpageno.
 * @param {Function} [props.showSnackbar] - Optional callback to show snackbar notifications.
 * @returns {JSX.Element} The rendered approval form component.
 */
const ApprovalForm = ({ taskData, onClose, record, showSnackbar }) => {
  const navigate = useNavigate();
  const [formData, setFormData] = useState({
    employeeid: "",
    facultyname: "",
    department: "",
    designation: "",
    visitfrom: "",
    visitto: "",
    natureofparticipation_value: "",
    country: "",
    city: "",
    claimtype: "",
    signingAuthority: "",
    toSection: [],
    remarks: "",
    leave: "",
    subject: "",
    ref: "",
    referenceNumber: "",
    template: "",
    body: "",
    date: "",
    header: "",
    footer: "",
  });

  const [bodyData, setBodyData] = useState({
    referencenumber: "",
    subject: "",
    body: "",
    refsubject: "",
    Date: "",
    Ref: "",
  });

  const [showPreview, setShowPreview] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [previewCoverPageNo, setPreviewCoverPageNo] = useState(null);
  const [selectedEmployeeId, setSelectedEmployeeId] = useState(null);
  const [approverRemarks, setApproverRemarks] = useState("");
  const [approvalAction, setApprovalAction] = useState(""); // "approve" or "reject"
  const [initiatorComments, setInitiatorComments] = useState([]);
  const [isSavedSuccessfully, setIsSavedSuccessfully] = useState(false);
  const [pdfUrl, setPdfUrl] = useState(null);
  const [isOfficeOrderEditable, setIsOfficeOrderEditable] = useState(false);
  const [isOfficeOrderExpanded, setIsOfficeOrderExpanded] = useState(false);
  const [returnToUser, setReturnToUser] = useState("");
  const [sendBackToMe, setSendBackToMe] = useState(false);
  const [apiReturnUserOptions, setApiReturnUserOptions] = useState([]);
  const commentsHeaderColor = "#3F51B5";

  /**
   * Memoized current preview data combining form and body data.
   */
  const currentPreviewData = useMemo(() => {
    return {
      formData: {
        ...formData,
        signingAuthorityLabel: formData.signingAuthority,
      },
      bodyData: {
        ...bodyData,
      },
    };
  }, [formData, bodyData]);

  /**
   * Memoized actual task data, extracting and normalizing from taskData.
   */
  const actualTaskData = useMemo(() => {
    if (!taskData) {
      return null;
    }
    if (taskData.TaskId) {
      return {
        ...taskData,
        Processid: taskData.ProcessId || taskData.Processid || "1",
      };
    }
    if (
      taskData.Data &amp;&amp;
      taskData.Data.Records &amp;&amp;
      taskData.Data.Records.length > 0
    ) {
      const extractedRecord = taskData.Data.Records[0];
      return {
        ...extractedRecord,
        TaskId: extractedRecord.taskid || extractedRecord.TaskId,
        EmployeeID: extractedRecord.employeeid || extractedRecord.EmployeeID,
        CoverPageNo: extractedRecord.coverpageno || extractedRecord.CoverPageNo,
        ProcessId: extractedRecord.processid || extractedRecord.ProcessId,
        ActivitySeqNo: extractedRecord.activityseqno || extractedRecord.ActivitySeqNo,
        Processid: extractedRecord.processid || extractedRecord.ProcessId || "1",
      };
    }
    return null;
  }, [taskData]);

  const sessionId = Cookies.get("session_id");

  const toSectionOptions = [
    `The Head of ${formData?.department || ""}`,
    "The Dean (Faculty)",
    "The Dean (Admin)",
    "The Dean (IC&amp;SR)",
    "The Dean (ACR)",
    "The Dean (GE)",
    "The Deputy Registrar (F&amp;A)",
    "Office copy",
    "AR (Paybill)",
    "AR (Bills)",
  ];

  const signingAuthorityOptions = [
    { value: "", label: "Select signing authority" },
    { value: "Deputy Registrar", label: "Deputy Registrar" },
    { value: "Assistant Registrar", label: "Assistant Registrar" },
    { value: "Registrar", label: "Registrar" },
  ];

  /**
   * Memoized return user options including API fetched users and initiator.
   */
  const returnUserOptions = useMemo(() => {
    const initialOption = { value: "", label: "Select Next/Return User" };
    return [initialOption, ...apiReturnUserOptions];
  }, [apiReturnUserOptions]);

  /**
   * Strips HTML tags from a string to extract plain text.
   * @param {string} htmlString - The HTML string to strip.
   * @returns {string} The plain text content.
   */
  const stripHtml = (htmlString) => {
    if (!htmlString) return "";
    const div = document.createElement("div");
    div.innerHTML = htmlString;
    return div.textContent || div.innerText || "";
  };

  /**
   * Formats a date value for input fields (YYYY-MM-DD).
   * @param {string} dateValue - The raw date value to format.
   * @returns {string} The formatted date string or empty if invalid.
   */
  const formatDateInput = (dateValue) => {
    if (!dateValue) return "";
    const date = new Date(dateValue);
    return isNaN(date.getTime()) ? "" : date.toISOString().split("T")[0];
  };

  /**
   * Formats a date string for API with specified time and timezone offset.
   * @param {string} dateString - The date string in YYYY-MM-DD format.
   * @param {string} [time="09:00:00"] - The time in HH:MM:SS format.
   * @returns {string|null} The formatted ISO timestamp or null if invalid.
   */
  const formatDateForAPI = (dateString, time = "09:00:00") => {
    if (!dateString || dateString.trim() === "") return null;
    const datePart = new Date(dateString);
    if (isNaN(datePart.getTime())) return null;
    const [hours, minutes, seconds] = time.split(":").map(Number);
    datePart.setHours(hours, minutes, seconds, 0);
    const tzOffset = -datePart.getTimezoneOffset();
    const tzOffsetHours = String(Math.floor(Math.abs(tzOffset) / 60)).padStart(
      2,
      "0"
    );
    const tzOffsetMins = String(Math.abs(tzOffset) % 60).padStart(2, "0");
    const tzSign = tzOffset >= 0 ? "+" : "-";
    const year = datePart.getFullYear();
    const month = String(datePart.getMonth() + 1).padStart(2, "0");
    const day = String(datePart.getDate()).padStart(2, "0");
    const hour = String(datePart.getHours()).padStart(2, "0");
    const minute = String(datePart.getMinutes()).padStart(2, "0");
    const second = String(datePart.getSeconds()).padStart(2, "0");
    return `${year}-${month}-${day}T${hour}:${minute}:${second}${tzSign}${tzOffsetHours}:${tzOffsetMins}`;
  };

  /**
   * Calculates the duration in days between two dates, inclusive.
   * @param {string} from - The start date string.
   * @param {string} to - The end date string.
   * @returns {number} The calculated duration in days.
   */
  const calculateDuration = (from, to) => {
    if (!from || !to || from.trim() === "" || to.trim() === "") return 0;
    const fromDate = new Date(from);
    const toDate = new Date(to);
    if (isNaN(fromDate.getTime()) || isNaN(toDate.getTime())) return 0;
    const diff = toDate - fromDate;
    return Math.ceil(diff / (1000 * 60 * 60 * 24)) + 1;
  };

  /**
   * Sanitizes a field value to ensure it's a string or empty.
   * @param {*} value - The value to sanitize.
   * @returns {string} The sanitized string value.
   */
  const sanitizeField = (value) => {
    if (value === null || value === undefined || value === "") return "";
    return value;
  };

  /**
   * Fetches status ID by description from the Statusmaster API.
   * @param {string} statusDescription - The status description to query.
   * @returns {Promise&lt;number>} The status ID or default 8.
   */
  const fetchStatusIdByDescription = async (statusDescription) => {
    const jwtToken = Cookies.get("HRToken");
    if (!jwtToken) throw new Error("Authentication token missing.");

    const statusResponse = await fetch(
      "https://wftest1.iitm.ac.in:7000/Statusmasternew",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${jwtToken}`,
        },
        body: JSON.stringify({
          statusdescription: statusDescription,
          token: "HRFGVJISOVp1fncC",
          session_id: sessionId,
        }),
      }
    );

    if (!statusResponse.ok)
      throw new Error(`Failed to fetch status for ${statusDescription}`);

    const encryptedStatus = await statusResponse.json();
    const encryptedPayload = encryptedStatus.Data ?? encryptedStatus.data;
    if (!encryptedPayload)
      throw new Error("Encrypted data missing in status response");

    const decryptedString = await decryptData(encryptedPayload);
    const validStatusData = validateJsonData(decryptedString);
    return validStatusData?.Data?.Records?.[0]?.statusid ?? 8;
  };

  /**
   * Generates HTML for the "To" column based on form data.
   * @returns {string} The formatted HTML string for the "To" column.
   */
  const generateToColumnHtml = () => {
    const name = sanitizeField(formData.facultyname);
    const id = sanitizeField(formData.employeeid);
    const dept = sanitizeField(formData.department);
    return `&lt;p>&lt;strong>To&lt;/strong>&lt;br>${name} (ID No. ${id})&lt;br>Thro the Head, ${dept}&lt;/p>&lt;p>&lt;strong>Sir,&lt;/strong>&lt;/p>`;
  };

  /**
   * Fetches API return user options for task return functionality.
   * Populates options from comments and adds initiator if needed.
   */
  const fetchApiReturnUsers = useCallback(async () => {
    const taskId = actualTaskData?.TaskId;
    const currentEmpId = Cookies.get("EmpId");
    
    if (!taskId) {
      return;
    }

    try {
      const jwtToken = Cookies.get("HRToken");
      if (!jwtToken) throw new Error("Authentication token missing.");

      const body = {
        token: "HRFGVJISOVp1fncC",
        session_id: sessionId,
        task_id: taskId,
      };

      const response = await fetch(
        "https://wftest1.iitm.ac.in:7000/OfficeOrder_ReturnDropdown",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwtToken}`,
          },
          body: JSON.stringify(body),
        }
      );

      if (!response.ok) {
        throw new Error(`Failed to fetch return users: ${response.status}`);
      }

      const encryptedData = await response.json();
      const encryptedPayload = encryptedData.Data ?? encryptedData.data;
      
      if (!encryptedPayload) {
        throw new Error("Encrypted Data missing in return users response");
      }

      const decryptedString = await decryptData(encryptedPayload);
      const parsedData = validateJsonData(decryptedString);

      const records = parsedData?.Records ?? 
                     parsedData?.Data?.Records ?? 
                     [];
      
      const uniqueUsers = new Set();
      const options = [];

      records.forEach((r) => {
        const userId = r.comment_by;
        if (userId &amp;&amp; !uniqueUsers.has(userId)) {
          uniqueUsers.add(userId);
          const firstName = r.firstname || "";
          const role = r.comment_role || "";
          
          const label = role
          
          options.push({
            value: userId,
            label: label,
          });
        }
      });
      const initiatorId = actualTaskData?.InitiatedBy;
      if (initiatorId &amp;&amp; !uniqueUsers.has(initiatorId)) {
        options.push({
          value: initiatorId,
          label: `${initiatorId} - Initiator`,
        });
      }

      options.sort((a, b) => a.label.localeCompare(b.label));
      
      setApiReturnUserOptions(options);
    } catch (err) {
      console.error("Fetch Return Users Error:", err);
      Swal.fire({
        title: "Error",
        text: "Failed to load return user options. Please try again.",
        icon: "error",
      });
    }
  }, [actualTaskData?.TaskId, sessionId, actualTaskData?.InitiatedBy]);

  /**
   * Fetches employee data and office order details from the API.
   * Populates form and body data states, processes subject/reference splitting.
   */
  const fetchEmployeeData = useCallback(async () => {
    const employeeId =
      actualTaskData?.EmployeeID ||
      actualTaskData?.employeeid ||
      actualTaskData?.EmployeeId ||
      record?.employeeid ||
      record?.EmployeeID;
    const coverPageNo =
      actualTaskData?.CoverPageNo ||
      actualTaskData?.coverpageno ||
      record?.coverpageno ||
      actualTaskData?.TaskId;

    if (!employeeId || !coverPageNo) {
      setError(
        "Required document parameters missing (EmployeeID or CoverPageNo)."
      );
      return;
    }

    setLoading(true);
    setError("");

    /**
     * Cleans and splits subject into main subject and reference.
     * @param {string} subject - The raw subject string.
     * @returns {Object} Object with mainSubject and reference.
     */
    const cleanSubject = (subject) => {
      if (!subject) return { mainSubject: "", reference: "" };
      let cleaned = subject.replace(/^Sir,\s*/i, "");
      const refIndex = cleaned.indexOf("Ref:");
      let mainSubject = cleaned;
      let reference = "";
      if (refIndex !== -1) {
        mainSubject = cleaned.slice(0, refIndex).trim();
        reference = cleaned.slice(refIndex + 4).trim();
      }
      return { mainSubject, reference };
    };

    try {
      const jwtToken = Cookies.get("HRToken");
      if (!jwtToken) throw new Error("Authentication token missing.");

      const body = {
        token: "HRFGVJISOVp1fncC",
        employeeid: employeeId,
        coverpageno: coverPageNo,
        session_id: sessionId,
      };

      const response = await fetch(
        "https://wftest1.iitm.ac.in:7000/OfficeOrder_taskvisitdetails",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwtToken}`,
          },
          body: JSON.stringify(body),
        }
      );

      if (!response.ok) {
        throw new Error(`API returned status ${response.status}`);
      }

      const encryptedData = await response.json();
      const encryptedPayload = encryptedData.Data ?? encryptedData.data;
      if (!encryptedPayload) {
        throw new Error(
          "Encrypted Data missing in task visit details response"
        );
      }

      const decryptedString = await decryptData(encryptedPayload);
      const parsedData = validateJsonData(decryptedString);

      const records = parsedData?.Records ?? parsedData?.Data?.Records ?? [];
      if (records.length === 0) {
        throw new Error("No records found in task visit details response");
      }

      const dataRecord = records[0];
      const { mainSubject, reference } = cleanSubject(dataRecord.subject || "");

      let signingAuthorityValue = dataRecord.signing_authority || "";
      if (!signingAuthorityValue &amp;&amp; dataRecord.signature_html) {
        const signatureText = stripHtml(dataRecord.signature_html).trim();
        const matchedOption = signingAuthorityOptions.find(
          (opt) => opt.label.toLowerCase() === signatureText.toLowerCase()
        );
        signingAuthorityValue = matchedOption
          ? matchedOption.value
          : signatureText;
      }

      const employeeData = {
        employeeid: dataRecord.employee_id || "",
        facultyname: dataRecord.employee_name || "",
        department: dataRecord.department || "",
        designation: dataRecord.designation || "",
        visitfrom: formatDateInput(dataRecord.visit_from),
        visitto: formatDateInput(dataRecord.visit_to),
        natureofparticipation_value: dataRecord.nature_of_visit || "",
        country: dataRecord.country?.trim() || "",
        city: dataRecord.city_town || "",
        claimtype: dataRecord.claim_type || "",
        signingAuthority: signingAuthorityValue,
        remarks: dataRecord.remarks || "",
        subject: mainSubject,
        ref: reference || stripHtml(dataRecord.reference) || "",
        referenceNumber: dataRecord.order_no || "",
        body: dataRecord.body_html || "",
        date: formatDateInput(dataRecord.order_date),
        header: stripHtml(dataRecord.header_html) || "",
        footer: stripHtml(dataRecord.footer_html) || "",
        toSection: dataRecord.cc_to
          ? dataRecord.cc_to
              .split(",")
              .map((s) => s.trim())
              .filter((s) => s)
          : [],
      };

      setFormData(employeeData);
      setBodyData({
        referencenumber: dataRecord.order_no || "",
        subject: mainSubject,
        body: dataRecord.body_html || "",
        refsubject: reference || stripHtml(dataRecord.reference) || "",
        Date: formatDateInput(dataRecord.order_date),
      });
      setPreviewCoverPageNo(coverPageNo);
      setSelectedEmployeeId(employeeId);
    } catch (err) {
      setError(err.message || "Failed to fetch employee data");
    } finally {
      setLoading(false);
    }
  }, [actualTaskData, record, sessionId]);

  /**
   * Fetches comments and remarks for the task from the API.
   * Populates initiator comments state.
   */
  const fetchCommentsData = useCallback(async () => {
    const officeOrderId = actualTaskData?.TaskId;
    if (!officeOrderId) return;

    try {
      const jwtToken = Cookies.get("HRToken");
      if (!jwtToken) throw new Error("Authentication token missing.");

      const body = {
        token: "HRFGVJISOVp1fncC",
        taskid: officeOrderId,
        session_id: sessionId,
      };

      const response = await fetch(
        "https://wftest1.iitm.ac.in:7000/OfficeOrder_approval_remarks",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwtToken}`,
          },
          body: JSON.stringify(body),
        }
      );

      const encryptedData = await response.json();
      const encryptedPayload = encryptedData.Data ?? encryptedData.data;
      if (!encryptedPayload)
        throw new Error("Encrypted Data missing in comments response");

      const decryptedString = await decryptData(encryptedPayload);
      const parsedData = validateJsonData(decryptedString);

      const records = parsedData?.Records ?? parsedData?.Data?.Records ?? [];
      const commentsArray = records.map((r, index) => ({
        id: index + 1,
        commenter: r.UpdatedBy || "Unknown",
        role: r.UserRole,
        comment: r.Remarks || "",
        date: new Date(r.UpdatedOn).toLocaleString("en-IN", {
          dateStyle: "medium",
          timeStyle: "short",
        }),
      }));
      setInitiatorComments(commentsArray);
    } catch (err) {
      console.error("Fetch Comments Error:", err);
    }
  }, [actualTaskData?.TaskId, sessionId]);

  /**
   * Effect hook to load all initial data: employee details, comments, return users.
   */
  useEffect(() => {
    const loadAllData = async () => {
      if (!actualTaskData?.TaskId) {
        return;
      }
      setLoading(true);
      try {
        await Promise.all([
          fetchEmployeeData(),
          fetchCommentsData(),
          fetchApiReturnUsers(),
        ]);
      } catch (error) {
        setError(
          error.message || "An error occurred during initial data loading."
        );
      } finally {
        setLoading(false);
      }
    };

    loadAllData();
  }, [
    actualTaskData?.TaskId,
    fetchEmployeeData,
    fetchCommentsData,
    fetchApiReturnUsers,
  ]);

  /**
   * Handles changes to form inputs, respecting edit mode and field types.
   * @param {Object} e - The event object from the input change.
   */
  const handleChange = (e) => {
    const { name, value, type, checked, disabled } = e.target;
    if (disabled) return;
    if (type === "checkbox" &amp;&amp; isOfficeOrderEditable) {
      setFormData((prev) => {
        const current = Array.isArray(prev.toSection) ? prev.toSection : [];
        const updated = checked
          ? [...current, value]
          : current.filter((v) => v !== value);
        return { ...prev, toSection: updated };
      });
    } else if (
      isOfficeOrderEditable &amp;&amp;
      [
        "referencenumber",
        "subject",
        "Date",
        "refsubject",
        "header",
        "footer",
      ].includes(name)
    ) {
      setBodyData((prev) => ({
        ...prev,
        [name === "Date" ? "Date" : name]: value,
      }));
      setFormData((prev) => ({
        ...prev,
        [name === "Date" ? "date" : name]: value,
      }));
    } else if (isOfficeOrderEditable) {
      setFormData((prev) => ({ ...prev, [name]: value }));
    }
  };

  /**
   * Handles changes to the signing authority dropdown.
   * @param {string} value - The selected value from the dropdown.
   */
  const handleSigningAuthorityChange = useCallback((value) => {
    if (!isOfficeOrderEditable) return;
    setFormData((prev) => ({ ...prev, signingAuthority: value }));
  }, [isOfficeOrderEditable]);

  /**
   * Handles changes to the body text editor.
   * @param {string} value - The new body content.
   */
  const handleBodyChange = (value) => {
    if (!isOfficeOrderEditable) return;
    setBodyData((prev) => ({ ...prev, body: value }));
    setFormData((prev) => ({ ...prev, body: value }));
  };

  /**
   * Handles changes to the To Section multi-select.
   * @param {Array} selected - The selected options array.
   */
  const handleToSectionChange = useCallback((selected) => {
    if (!isOfficeOrderEditable) return;
    setFormData((prev) => ({ ...prev, toSection: selected }));
  }, [isOfficeOrderEditable]);

  /**
   * Handles approval action toggle (approve/reject).
   * @param {string} action - The action to toggle ("approve" or "reject").
   */
  const handleApprovalActionChange = (action) => {
    setApprovalAction(approvalAction === action ? "" : action);
    if (action !== "reject") {
      setReturnToUser("");
    }
  };

  /**
   * Handles saving the form as a draft via API.
   * Fetches status ID for "saveandhold" and updates the task.
   */
  const handleSave = async () => {
    try {
      setLoading(true);
      const jwtToken = Cookies.get("HRToken");
      const empId = Cookies.get("EmpId");
      if (!jwtToken || !empId)
        throw new Error("Authentication details missing.");

      const taskStatusId = await fetchStatusIdByDescription("saveandhold");
      const userRole = Cookies.get("selectedRole");

      const reqpayload = {
        token: "HRFGVJISOVp1fncC",
        session_id: sessionId,
        typeofsubmit: "draft",
        p_cover_page_no: sanitizeField(
          actualTaskData?.CoverPageNo ||
            actualTaskData?.coverpageno ||
            actualTaskData?.TaskId
        ),
        p_employee_id: sanitizeField(formData.employeeid),
        p_employee_name: sanitizeField(formData.facultyname),
        p_department: sanitizeField(formData.department),
        p_designation: sanitizeField(formData.designation),
        p_visit_from: formatDateForAPI(formData.visitfrom, "09:00:00"),
        p_visit_to: formatDateForAPI(formData.visitto, "17:00:00"),
        p_duration: calculateDuration(formData.visitfrom, formData.visitto),
        p_nature_of_visit: sanitizeField(formData.natureofparticipation_value),
        p_claim_type: sanitizeField(formData.claimtype),
        p_city_town: sanitizeField(formData.city),
        p_country: sanitizeField(formData.country),
        p_header_html: sanitizeField(formData.header),
        p_order_no: sanitizeField(bodyData.referencenumber),
        p_order_date:
          formatDateForAPI(bodyData.Date, "00:00:00")?.split("T")[0] || "",
        p_to_column: generateToColumnHtml(),
        p_subject: sanitizeField(bodyData.subject),
        p_reference: sanitizeField(bodyData.refsubject),
        p_body_html: sanitizeField(bodyData.body),
        p_signature_html: sanitizeField(formData.signingAuthority),
        p_cc_to: Array.isArray(formData.toSection)
          ? formData.toSection.join(",")
          : "",
        p_footer_html: sanitizeField(formData.footer),
        p_assign_to:empId,
        p_assigned_role: userRole,
        p_task_status_id: taskStatusId,
        p_activity_seq_no: actualTaskData?.ActivitySeqNo,
        p_is_task_return: false,
        p_is_task_approved: false, // Fixed: Set to false for draft/save
        p_initiated_by: sanitizeField(actualTaskData?.InitiatedBy || empId),
        p_initiated_on: actualTaskData?.InitiatedOn || new Date().toISOString(),
        p_updated_by: sanitizeField(empId),
        p_updated_on: new Date().toISOString(),
        p_process_id: Number(
          actualTaskData?.Processid || actualTaskData?.ProcessId
        ),
        p_remarks: sanitizeField(formData.remarks),
        p_email_flag: false,
        p_reject_flag: 0,
        p_user_role: userRole,
        p_original_order_no: "",
        p_order_type: actualTaskData?.ProcessKeyword || "",
        p_task_id: actualTaskData?.TaskId || null,
        p_role: "",
        p_requested_user: "",
        p_return_to_role: "",
        p_return_to_user: "",
        p_send_back_to_me: false,
        p_send_back_to_user: "",
      };

      const response = await fetch(
        `${HostName}/OfficeOrder_InsertOfficedetails`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwtToken}`,
          },
          body: JSON.stringify(reqpayload),
        }
      );

      if (!response.ok) throw new Error("Failed to save Office Order");

      Swal.fire({
        title: "Saved!",
        text: "The task has been saved successfully.",
        icon: "success",
        timer: 2000,
        showConfirmButton: false,
      });

      setIsSavedSuccessfully(true);
    } catch (err) {
      Swal.fire({
        title: "Error",
        text: err.message || "Failed to save Office Order",
        icon: "error",
      });
    } finally {
      setLoading(false);
    }
  };

  /**
   * Handles approval submission (approve or reject) after validation.
   * Updates task status and notifies via API.
   */
  const handleSubmit = async () => {
    if (!approvalAction) {
      Swal.fire("Select Action", "Please choose Approve or Reject.", "warning");
      return;
    }
    if (!approverRemarks.trim()) {
      Swal.fire(
        "Remarks Required",
        "Please fill in Official Remarks.",
        "warning"
      );
      return;
    }
    if (approvalAction === "reject" &amp;&amp; !returnToUser) {
      Swal.fire(
        "User Required",
        "Please select a user to return the task to.",
        "warning"
      );
      return;
    }

    const isApprove = approvalAction === "approve";
    const isReject = approvalAction === "reject";

    const result = await Swal.fire({
      title: isApprove ? "Approve Request?" : "Reject &amp; Return Request?",
      text: `Are you sure you want to ${
        isApprove ? "approve" : "reject and return"
      }?`,
      icon: isApprove ? "question" : "warning",
      showCancelButton: true,
      confirmButtonColor: isApprove ? "#10B981" : "#EF4444",
      confirmButtonText: isApprove ? "Yes, Approve" : "Yes, Reject and Return",
    });

    if (!result.isConfirmed) return;

    setLoading(true);
    try {
      const jwtToken = Cookies.get("HRToken");
      const empId = Cookies.get("EmpId");
      if (!jwtToken || !empId)
        throw new Error("Authentication details missing.");

      const userRole = Cookies.get("selectedRole");

      const updatePayload = {
        token: "HRFGVJISOVp1fncC",
        session_id: sessionId,
        typeofsubmit: "submit",
        p_cover_page_no: sanitizeField(
          actualTaskData?.CoverPageNo ||
            actualTaskData?.coverpageno ||
            actualTaskData?.TaskId
        ),
        p_employee_id: sanitizeField(formData.employeeid),
        p_employee_name: sanitizeField(formData.facultyname),
        p_department: sanitizeField(formData.department),
        p_designation: sanitizeField(formData.designation),
        p_visit_from: formatDateForAPI(formData.visitfrom, "09:00:00"),
        p_visit_to: formatDateForAPI(formData.visitto, "17:00:00"),
        p_duration: calculateDuration(formData.visitfrom, formData.visitto),
        p_nature_of_visit: sanitizeField(formData.natureofparticipation_value),
        p_claim_type: sanitizeField(formData.claimtype),
        p_city_town: sanitizeField(formData.city),
        p_country: sanitizeField(formData.country),
        p_header_html: sanitizeField(formData.header),
        p_order_no: sanitizeField(bodyData.referencenumber),
        p_order_date:
          formatDateForAPI(bodyData.Date, "00:00:00")?.split("T")[0] || "",
        p_to_column: generateToColumnHtml(),
        p_subject: sanitizeField(bodyData.subject),
        p_reference: sanitizeField(bodyData.refsubject),
        p_body_html: sanitizeField(bodyData.body),
        p_signature_html: sanitizeField(formData.signingAuthority),
        p_cc_to: Array.isArray(formData.toSection)
          ? formData.toSection.join(",")
          : "",
        p_footer_html: sanitizeField(formData.footer),
        p_task_status_id: isApprove ? 4 : 10,
        p_activity_seq_no: actualTaskData?.ActivitySeqNo || 0,
        p_is_task_return: isReject,
        p_is_task_approved: isApprove,
        p_initiated_by: sanitizeField(actualTaskData?.InitiatedBy || empId),
        p_initiated_on: actualTaskData?.InitiatedOn || new Date().toISOString(),
        p_updated_by: sanitizeField(empId),
        p_updated_on: new Date().toISOString(),
        p_process_id: Number(
          actualTaskData?.Processid || actualTaskData?.ProcessId
        ),
        p_remarks: sanitizeField(approverRemarks),
        p_original_order_no: "",
        p_order_type: actualTaskData?.ProcessKeyword,
        p_task_id: actualTaskData?.TaskId || null,
        p_role: "",
        p_requested_user: isReject ? empId : "",
        p_return_to_role: isReject ? (returnUserOptions.find(opt => opt.value === returnToUser)?.label || "") : "",
        p_return_to_user: isReject ? returnToUser : "",
        p_send_back_to_me: sendBackToMe,
        p_send_back_to_user: sendBackToMe ? Cookies.get("EmpId") : "",
        p_user_role: userRole, 
      };

      const response = await fetch(
        `${HostName}/OfficeOrder_InsertOfficedetails`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${jwtToken}`,
          },
          body: JSON.stringify(updatePayload),
        }
      );

      if (!response.ok) {
        throw new Error(`Failed to submit: ${response.statusText}`);
      }

      Swal.fire({
        title: "Success!",
        text: `The task has been ${
          isApprove ? "approved" : "rejected"
        } successfully.`,
        icon: "success",
        timer: 2000,
        showConfirmButton: false,
      });

      setTimeout(() => navigate("/inbox"), 2000);
    } catch (err) {
      Swal.fire({
        title: "Error",
        text: err.message || "Failed to update Office Order",
        icon: "error",
      });
    } finally {
      setLoading(false);
    }
  };

  /**
   * Handles preview generation and modal opening.
   */
  const handlePreview = () => {
    const coverPageNo =
      actualTaskData?.CoverPageNo ||
      actualTaskData?.coverpageno ||
      actualTaskData?.TaskId;
    if (!coverPageNo || !formData.employeeid) {
      Swal.fire(
        "Missing Data",
        "Cannot generate preview: Missing required data.",
        "warning"
      );
      return;
    }
    setPreviewCoverPageNo(coverPageNo);
    setSelectedEmployeeId(formData.employeeid);
    setShowPreview(true);
  };

  /**
   * Closes the preview modal and revokes PDF URL.
   */
  const handleClosePreview = () => {
    if (pdfUrl) URL.revokeObjectURL(pdfUrl);
    setPdfUrl(null);
    setShowPreview(false);
  };



  if (loading) return &lt;div style={loadingStyle}>Loading employee data...&lt;/div>;

  if (showPreview) {
    return (
      &lt;OfficeOrderPreview
        coverpageno={previewCoverPageNo}
        formData={currentPreviewData.formData}
        bodyData={currentPreviewData.bodyData}
        onBack={handleClosePreview}
        employeeid={selectedEmployeeId}
        isLocalPreview={true}
      />
    );
  }

  return (
    &lt;div style={containerStyle}>
    

      &lt;div style={cardStyle}>
        &lt;Roadmap 
          processId={actualTaskData?.Processid || 1}
          currentActivity={actualTaskData?.ActivitySeqNo || 1}
          signingAuthority={formData.signingAuthority || "Registrar"}
          sessionId={sessionId}
        />
        &lt;div
          style={{
            paddingBottom: "10px",
            marginBottom: "20px",
            borderBottom: "1px solid #E0E0E0",
          }}
        >
          &lt;h2 style={headingStyle}>Permission Cum Relief Approval&lt;/h2>
        &lt;/div>

        {/* This main div now contains all interactive and informational sections */}
        &lt;div
          style={{
            maxHeight: "100%",
            overflowY: "auto",
            border: "1px solid #E5E7EB",
            borderRadius: "12px",
            backgroundColor: "#FFFFFF",
            boxShadow: "0 2px 8px rgba(0, 0, 0, 0.08)",
          }}
        >
          &lt;form
            onSubmit={(e) => e.preventDefault()}
            style={{ padding: "15px" }} // Reduced padding for compactness
          >
            {/* --- Approver Section Component (STICKY BOX) --- */}
            &lt;div
              style={{
                position: "sticky",
                top: 0,
                zIndex: 10,
                backgroundColor: "#FFFFFF",
                borderRadius: "8px",
                padding: "5px",
                marginBottom: "5px",
              }}
            >
              &lt;ApproverSection
                approvalAction={approvalAction}
                handleApprovalActionChange={handleApprovalActionChange}
                returnToUser={returnToUser}
                setReturnToUser={setReturnToUser}
                returnUserOptions={returnUserOptions}
                approverRemarks={approverRemarks}
                setApproverRemarks={setApproverRemarks}
                handleSave={handleSave}
                handleSubmit={handleSubmit}
                handlePreview={handlePreview}
                sendBackToMe={sendBackToMe}
                setSendBackToMe={setSendBackToMe}
              />
            &lt;/div>

            {/* --- Comments Section Component --- */}
            &lt;CommentsSection
              comments={initiatorComments}
              loading={loading &amp;&amp; initiatorComments.length === 0}
              headerColor={commentsHeaderColor}
            />

            {/* --- Employee Info Section (COMPACT) --- */}
            &lt;FormSection style={readOnlySectionStyle}>
              &lt;div style={sectionHeaderStyle}>
                &lt;h3 style={sectionHeadingStyle}>
                  Employee Information
                &lt;/h3>
              &lt;/div>
              &lt;div style={gridRowStyle}>
                &lt;TextField
                  label="Employee ID"
                  value={formData.employeeid}
                  InputProps={{ readOnly: true }}
                  variant="outlined"
                  fullWidth
                  size="small" // Added for compactness
                />
                &lt;TextField
                  label="Employee Name"
                  value={formData.facultyname}
                  InputProps={{ readOnly: true }}
                  variant="outlined"
                  fullWidth
                  size="small"
                />
                &lt;TextField
                  label="Department"
                  value={formData.department}
                  InputProps={{ readOnly: true }}
                  variant="outlined"
                  fullWidth
                  size="small"
                />
                &lt;TextField
                  label="Designation"
                  value={formData.designation}
                  InputProps={{ readOnly: true }}
                  variant="outlined"
                  fullWidth
                  size="small"
                />
              &lt;/div>
              &lt;div style={gridRowStyle}>
                &lt;TextField
                  label="Nature of Visit"
                  value={formData.natureofparticipation_value}
                  InputProps={{ readOnly: true }}
                  variant="outlined"
                  fullWidth
                  size="small"
                />
                &lt;TextField
                  type="date"
                  label="Visit From"
                  value={formData.visitfrom}
                  InputProps={{ readOnly: true }}
                  variant="outlined"
                  fullWidth
                  size="small"
                  InputLabelProps={{ shrink: true }}
                />
                &lt;TextField
                  type="date"
                  label="Visit To"
                  value={formData.visitto}
                  InputProps={{ readOnly: true }}
                  variant="outlined"
                  fullWidth
                  size="small"
                  InputLabelProps={{ shrink: true }}
                />
                &lt;TextField
                  label="Country"
                  value={formData.country}
                  InputProps={{ readOnly: true }}
                  variant="outlined"
                  fullWidth
                  size="small"
                />
              &lt;/div>
              &lt;div style={gridRowStyle}>
                &lt;TextField
                  label="City/Town"
                  name="city"
                  value={formData.city}
                  InputProps={{ readOnly: true }}
                  variant="outlined"
                  fullWidth
                  size="small"
                />
              &lt;/div>
            &lt;/FormSection>

            {/* --- Office Order Details Section (COMPACT) --- */}
            &lt;FormSection style={officeOrderSectionStyle}>
              &lt;div
                style={{
                  ...officeOrderHeaderStyle,
                  backgroundColor: isOfficeOrderEditable
                    ? "#FFFBEB"
                    : "#ECEFF1",
                  borderBottom: isOfficeOrderExpanded
                    ? "1px solid #CFD8DC"
                    : "none",
                }}
                onClick={() => setIsOfficeOrderExpanded(!isOfficeOrderExpanded)}
              >
                &lt;div
                  style={{ display: "flex", alignItems: "center", flexGrow: 1 }}
                >
                  &lt;h3
                    style={{
                      ...sectionHeadingStyle,
                      color: isOfficeOrderEditable ? "#9D5A00" : "#263238",
                      marginRight: "15px",
                    }}
                  >
                    Office Order Content &amp; Details
                  &lt;/h3>
                  &lt;span
                    style={{
                      fontSize: "12px",
                      fontWeight: "500",
                      color: isOfficeOrderEditable ? "#A16207" : "#546E7A",
                      backgroundColor: isOfficeOrderEditable
                        ? "#FEF3C7"
                        : "#E0F7FA",
                      padding: "2px 6px",
                      borderRadius: "3px",
                    }}
                  >
                    {isOfficeOrderEditable
                      ? "EDITING IN PROGRESS"
                      : "READ-ONLY"}
                  &lt;/span>
                &lt;/div>

                &lt;div
                  style={{ display: "flex", alignItems: "center", gap: "8px" }}
                >
                  &lt;button
                    type="button"
                    onClick={(e) => {
                      e.stopPropagation();
                      if (isOfficeOrderEditable) {
                        Swal.fire({
                          title: "Discard Changes?",
                          text: "Are you sure you want to exit edit mode?",
                          icon: "warning",
                          showCancelButton: true,
                          confirmButtonText: "Yes, Exit Edit Mode",
                        }).then((res) => {
                          if (res.isConfirmed) {
                            setIsOfficeOrderEditable(false);
                          }
                        });
                      } else {
                        setIsOfficeOrderEditable(true);
                        if (!isOfficeOrderExpanded)
                          setIsOfficeOrderExpanded(true);
                      }
                    }}
                    style={{
                      ...buttonStyle,
                      backgroundColor: isOfficeOrderEditable
                        ? "#10B981"
                        : "#10B981",
                      padding: "4px 12px",
                      fontSize: "11px",
                      borderRadius: "4px",
                    }}
                  >
                    {isOfficeOrderEditable ? "Edit Content" : "Edit Content"}
                  &lt;/button>
                  &lt;svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="#263238"
                    strokeWidth="2"
                    style={{
                      transform: isOfficeOrderExpanded
                        ? "rotate(180deg)"
                        : "rotate(0deg)",
                      transition: "transform 0.3s ease",
                    }}
                  >
                    &lt;polyline points="6 9 12 15 18 9">&lt;/polyline>
                  &lt;/svg>
                &lt;/div>
              &lt;/div>

              {isOfficeOrderExpanded &amp;&amp; (
                &lt;div style={{ padding: "16px", backgroundColor: "#F9FAFB" }}>
                  {" "}
                  {/* Reduced padding */}
                  &lt;div
                    style={{
                      ...gridRowStyle,
                      gridTemplateColumns: "1fr 1fr 2fr 2fr",
                    }}
                  >
                    &lt;TextField
                      label="Reference Number"
                      name="referencenumber"
                      value={bodyData.referencenumber}
                      onChange={handleChange}
                      InputProps={{ readOnly: !isOfficeOrderEditable }}
                      variant="outlined"
                      fullWidth
                      size="small"
                    />
                    &lt;TextField
                      label="Date"
                      name="Date"
                      type="date"
                      value={bodyData.Date}
                      onChange={handleChange}
                      InputProps={{ readOnly: !isOfficeOrderEditable }}
                      variant="outlined"
                      fullWidth
                      size="small"
                      InputLabelProps={{ shrink: true }}
                    />
                  &lt;/div>
                  &lt;div style={gridRowTwoColumnStyles}>
                    &lt;TextField
                      label="Subject"
                      name="subject"
                      value={bodyData.subject}
                      onChange={handleChange}
                      variant="outlined"
                      fullWidth
                      multiline
                      rows={2}
                      InputProps={{ readOnly: !isOfficeOrderEditable }}
                      size="small"
                    />
                    &lt;TextField
                      label="Ref"
                      name="refsubject"
                      value={bodyData.refsubject}
                      onChange={handleChange}
                      variant="outlined"
                      fullWidth
                      multiline
                      rows={2}
                      InputProps={{ readOnly: !isOfficeOrderEditable }}
                      size="small"
                    />
                  &lt;/div>
                  &lt;div style={{ marginBottom: "12px" }}>
                    {" "}
                    {/* Reduced margin */}
                    &lt;label style={labelStyle}>Body&lt;/label>
                    &lt;TextEdit
                      value={bodyData.body}
                      onChange={handleBodyChange}
                      readOnly={!isOfficeOrderEditable}
                    />
                  &lt;/div>
                  {/* Signing Authority and TO Section side by side */}
                  &lt;div style={gridRowTwoColumnStyles}>
                    &lt;div>
                      &lt;Dropdown
                        label="Signing Authority"
                        name="signingAuthority"
                        value={formData.signingAuthority}
                        onChange={handleSigningAuthorityChange}
                        disabled={!isOfficeOrderEditable}
                        options={signingAuthorityOptions}
                        inputStyleOverride={{ height: "44px" }} // Compact height
                      />
                    &lt;/div>
                    &lt;div>
                      &lt;DropdownWithCheckboxes
                        label="To Section"
                        options={toSectionOptions.map(opt => ({ value: opt, label: opt }))}
                        value={formData.toSection}
                        onChange={handleToSectionChange}
                        disabled={!isOfficeOrderEditable}
                      />
                    &lt;/div>
                  &lt;/div>
                &lt;/div>
              )}
            &lt;/FormSection>
          &lt;/form>
        &lt;/div>
      &lt;/div>
    &lt;/div>
  );
};

/* --- STYLES (UPDATED FOR COMPACTNESS AND USER-FRIENDLINESS) --- */
const containerStyle = {
  width: "100%",
  minHeight: "100vh",
  display: "flex",
  justifyContent: "center",
  alignItems: "flex-start",
  padding: "10px",
};
const cardStyle = {
  width: "100%",
  maxWidth: "1800px",
  padding: "24px",
  borderRadius: "16px",
  boxShadow: "0 10px 25px rgba(0,0,0,0.1)",
  backgroundColor: "#fff",
  marginTop: "10px",
}; // Reduced padding
const headingStyle = {
  marginBottom: "8px",
  color: "#3F51B5",
  fontSize: "24px",
  fontWeight: "700",
  letterSpacing: "0.5px",
}; // Slightly smaller heading
const labelStyle = {
  display: "block",
  marginBottom: "6px",
  fontWeight: "600",
  color: "#374151",
  fontSize: "12px",
  letterSpacing: "0.3px",
  textTransform: "uppercase",
}; // Smaller label
const buttonStyle = {
  padding: "6px 12px",
  border: "none",
  borderRadius: "4px",
  color: "#fff",
  cursor: "pointer",
  fontWeight: "600",
  fontSize: "12px",
  letterSpacing: "0.5px",
  transition: "all 0.3s ease",
}; // Compact button

const gridRowStyle = {
  display: "grid",
  gridTemplateColumns: "repeat(4, 1fr)",
  gap: "12px",
  marginBottom: "12px",
}; // Reduced gap and margin
const gridRowTwoColumnStyles = {
  display: "grid",
  gridTemplateColumns: "1fr 1fr",
  gap: "12px",
  marginBottom: "12px",
  width: "70%",
}; // Reduced gap and margin

const loadingStyle = {
  display: "flex",
  justifyContent: "center",
  alignItems: "center",
  height: "100vh",
  fontSize: "18px",
  color: "#6B7280",
};
const sectionHeadingStyle = {
  margin: 0,
  fontSize: "16px",
  fontWeight: "600",
  letterSpacing: "0.3px",
}; // Smaller heading
const sectionHeaderStyle = {
  display: "flex",
  alignItems: "center",
  marginBottom: "16px",
  borderBottom: "1px solid #CFD8DC",
  paddingBottom: "8px",
}; // Reduced margins
const readOnlySectionStyle = {
  marginBottom: "16px",
  padding: "16px",
  border: "1px solid #E5E7EB",
  borderRadius: "8px",
  backgroundColor: "#F9FAFB",
  boxShadow: "0 0 5px rgba(0, 0, 0, 0.03)",
}; // Reduced padding and margin
const officeOrderSectionStyle = {
  marginBottom: "16px",
  border: "1px solid #CFD8DC",
  borderRadius: "8px",
  backgroundColor: "#FFFFFF",
  boxShadow: "0 4px 10px rgba(0, 0, 0, 0.05)",
  overflow: "hidden",
}; // Reduced margin and radius
const officeOrderHeaderStyle = {
  display: "flex",
  justifyContent: "space-between",
  alignItems: "center",
  padding: "12px 16px",
  cursor: "pointer",
  transition: "background-color 0.3s ease",
}; // Reduced padding

export default ApprovalForm;</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Wed Nov 05 2025 11:24:43 GMT+0530 (India Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
